<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Plaine – Donjon & Quêtes</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Space+Grotesk:wght@400;500;600&display=swap');
body{margin:0;background:radial-gradient(1200px 600px at 15% 10%,rgba(127,0,255,0.25),transparent 60%),radial-gradient(900px 600px at 85% 20%,rgba(0,255,213,0.2),transparent 60%),#08060d;color:#eee;font-family:"Space Grotesk", sans-serif;display:flex;justify-content:center;align-items:flex-start;padding:20px;gap:20px}
#questBoard{width:260px;position:sticky;top:20px}
#mapBoard{width:260px;position:sticky;top:20px}
#questPanel{padding:20px;background:rgba(12,12,12,0.95);border-radius:16px;box-shadow:0 0 25px #00ffd5}
#mapPanel{margin-top:12px;padding:20px;background:rgba(18,8,24,0.95);border-radius:16px;box-shadow:0 0 25px #7f00ff}
#game,#dungeonUI{width:950px;padding:30px;background:rgba(12,12,18,0.95);border-radius:16px;box-shadow:0 0 40px rgba(255,59,127,0.6);margin-bottom:20px;}
#hud{display:flex;justify-content:space-between;gap:10px;align-items:center;background:#12101a;border:1px solid #2a2436;border-radius:12px;padding:8px 10px;margin-bottom:8px}
#hud .hud-left{display:flex;gap:8px;flex-wrap:wrap}
#hud .hud-right{display:flex;gap:8px;flex-wrap:wrap}
#hud .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#1a1424;border:1px solid #2b2338;color:#d7cfea}
#zoneMap{display:flex;flex-direction:column;gap:8px;justify-content:center;margin-top:10px}
#zoneMap .zone{background:#122;border:1px solid #355;border-radius:10px;padding:8px 10px;color:#cfe;cursor:pointer;display:flex;flex-direction:column;gap:4px}
#zoneMap .zone.active{background:#00ffd5;color:#000;border-color:#00ffd5;animation:pulse 1.6s ease-in-out infinite}
#zoneMap .zone .sub{font-size:11px;color:#9fc}
#zoneMap .zone.locked{opacity:0.55}
#zoneMap .zone .bar{height:6px;border-radius:6px;background:#1b1b24;border:1px solid #2a2436;overflow:hidden}
#zoneMap .zone .bar .fill{height:100%;background:linear-gradient(90deg,#00ffd5,#7f00ff)}
@keyframes pulse{0%{box-shadow:0 0 0 rgba(0,255,213,0.4)}50%{box-shadow:0 0 14px rgba(0,255,213,0.6)}100%{box-shadow:0 0 0 rgba(0,255,213,0.4)}}
#questPanel h2{margin:0 0 10px 0;color:#00ffd5;text-align:center}
#mapPanel h2{margin:0 0 10px 0;color:#b27bff;text-align:center}
#questList{display:flex;flex-direction:column;gap:10px}
#questList .quest{background:#111;border:1px solid #244;border-radius:10px;padding:10px}
#questList .quest .title{font-weight:600;color:#00ffd5}
#questList .quest .meta{font-size:13px;color:#aaa;margin-top:4px}
#dungeonUI{display:none;}
h1{text-align:center;color:#ff3b7f;font-family:"Cinzel", serif;letter-spacing:1px}
#log,#dungeonLog{height:150px;overflow-y:auto;background:#111;padding:10px;border-radius:10px;box-shadow:0 0 15px #ff3b7f;margin-bottom:10px}
button{padding:12px 20px;margin:5px;border:none;border-radius:8px;background:#ff3b7f;color:#fff;font-size:16px;cursor:pointer;box-shadow:0 0 10px #ff3b7f;transition:0.2s}
button:hover{transform:scale(1.08);box-shadow:0 0 25px #ff5b9f}
.bar-container{width:100%;height:20px;background:#222;border-radius:10px;margin-bottom:8px}
.bar{height:100%;border-radius:10px;transition:width 0.4s}
.hp{background:linear-gradient(90deg,#00ff66,#00cc55)}
.xp{background:linear-gradient(90deg,#7f00ff,#b84dff)}
.monster-bar{background:linear-gradient(90deg,#ff0000,#ff6666)}
.monster-img{width:96px;height:96px;image-rendering:pixelated;background:#111;border:1px solid #2b2338;border-radius:10px;padding:4px;display:block;margin:6px auto}
#actions,#menu,#dungeonActions,#secondaryActions{display:flex;flex-wrap:wrap;justify-content:center}
#actions{gap:6px;align-items:center}
#actions button{padding:8px 12px;font-size:14px;border-radius:10px;background:#1a1424;border:1px solid #2b2338;box-shadow:none}
#actions button.primary-action{background:linear-gradient(90deg,#ff3b7f,#b84dff);border:none;box-shadow:0 0 12px rgba(255,59,127,0.4)}
#menu{margin-top:10px;min-height:60px;background:#0f0f16;border:1px solid #242030;border-radius:12px;padding:10px}
#menu h3{margin:6px 0 8px 0;text-align:center;color:#ffe7ff;font-family:"Cinzel", serif}
.secondary-panel{margin-top:6px;display:none;gap:8px;padding:8px;border-radius:12px;background:#12101a;border:1px solid #2a2436}
.secondary-panel.show{display:flex}
#secondaryActions{gap:6px}
#secondaryActions button{padding:8px 10px;font-size:13px;border-radius:10px;background:#191421;border:1px solid #2b2338;box-shadow:none}
.action-label{width:100%;text-align:center;color:#8f8aa0;font-size:12px;margin:2px 0}
.item-btn{background:#222;border:1px solid #555;margin:3px}
.small{font-size:14px;color:#bbb}
.event-banner{margin:6px 0;padding:6px 10px;border-radius:10px;background:#1a1424;border:1px solid #2b2338;color:#d7cfea;font-size:12px}
.quest-menu{display:flex;flex-direction:column;gap:10px}
.quest-card{background:#0f0f16;border:1px solid #242030;border-radius:12px;padding:10px}
.quest-head{display:flex;justify-content:space-between;align-items:center;gap:10px}
.quest-faction{font-size:11px;background:#1a1424;border:1px solid #2b2338;border-radius:999px;padding:2px 8px;color:#d7cfea}
.quest-actions{display:flex;gap:8px;flex-wrap:wrap}
.quest-sort{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#1a1424;border:1px solid #2b2338;font-size:11px;color:#d7cfea}
.list-card{background:#0f0f16;border:1px solid #242030;border-radius:12px;padding:8px;margin:6px 0}
#toast{position:fixed;top:20px;right:20px;z-index:2000;display:flex;flex-direction:column;gap:8px}
.toast-item{background:#1a1424;border:1px solid #2b2338;color:#ffe7ff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,0.45);min-width:220px}
.toast-title{font-weight:600;margin-bottom:4px}
.bestiary-img{width:64px;height:64px;image-rendering:pixelated;border-radius:8px;border:1px solid #2b2338;background:#111;padding:2px}
.bestiary-row{display:flex;gap:10px;align-items:center}
#classScreen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(135deg,rgba(8,6,13,0.98),rgba(10,8,20,0.95));backdrop-filter:blur(6px);z-index:50}
.class-modal{width:min(980px,92vw);padding:28px 28px 22px;border-radius:20px;background:rgba(10,10,16,0.92);border:1px solid rgba(255,255,255,0.08);box-shadow:0 20px 80px rgba(0,0,0,0.6)}
.class-title{font-family:"Cinzel", serif;text-align:center;font-size:32px;margin:0 0 8px;color:#ffe7ff}
.class-sub{text-align:center;color:#b9b2c7;margin:0 0 22px}
.class-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
.class-card{position:relative;padding:18px;border-radius:16px;background:linear-gradient(135deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.08);transition:transform 0.2s, box-shadow 0.2s, border-color 0.2s}
.class-card:hover{transform:translateY(-4px);box-shadow:0 14px 30px rgba(0,0,0,0.4);border-color:rgba(255,255,255,0.22)}
.class-name{font-family:"Cinzel", serif;font-size:22px;margin:0 0 6px;color:#00ffd5}
.class-tag{display:inline-block;font-size:12px;color:#0a0a0f;background:#00ffd5;padding:3px 8px;border-radius:999px;margin-bottom:10px}
.class-desc{font-size:14px;color:#cfc8dc;min-height:44px;margin:0 0 10px}
.class-stats{display:flex;gap:10px;flex-wrap:wrap;font-size:13px;color:#dcd6e6;margin:0 0 12px}
.class-stats span{background:#16131f;border:1px solid #2b2338;padding:4px 8px;border-radius:10px}
.class-pick{width:100%;margin:0;padding:10px 12px;background:linear-gradient(90deg,#ff3b7f,#b84dff);box-shadow:0 0 20px rgba(255,59,127,0.5)}
.hidden{display:none !important}
#startScreen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(135deg,rgba(6,6,10,0.98),rgba(18,10,28,0.96));backdrop-filter:blur(6px);z-index:60}
.start-modal{width:min(760px,92vw);padding:34px;border-radius:22px;background:rgba(10,10,16,0.95);border:1px solid rgba(255,255,255,0.08);box-shadow:0 30px 90px rgba(0,0,0,0.65);text-align:center}
.start-title{font-family:"Cinzel", serif;font-size:38px;margin:0 0 6px;color:#ffe7ff;letter-spacing:1px}
.start-sub{margin:0 0 26px;color:#b9b2c7}
.start-actions{display:grid;grid-template-columns:1fr;gap:12px}
.start-btn{padding:14px 18px;border-radius:12px;font-size:18px;background:linear-gradient(90deg,#00ffd5,#7f00ff);box-shadow:0 0 22px rgba(0,255,213,0.35)}
.start-btn.secondary{background:#1b1524;color:#f5f2ff;border:1px solid #2e243a;box-shadow:none}
.start-hint{margin-top:16px;font-size:12px;color:#8f8aa0}
.start-save{margin-top:10px;font-size:12px;color:#a9a3b7}
.screen{opacity:0;transform:scale(0.98);transition:opacity calc(0.25s * var(--anim-speed,1)) ease, transform calc(0.25s * var(--anim-speed,1)) ease}
.screen.show{opacity:1;transform:scale(1)}
#optionsScreen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(135deg,rgba(6,6,10,0.98),rgba(18,10,28,0.96));backdrop-filter:blur(6px);z-index:70}
.options-modal{width:min(720px,92vw);padding:28px;border-radius:20px;background:rgba(10,10,16,0.95);border:1px solid rgba(255,255,255,0.08);box-shadow:0 30px 90px rgba(0,0,0,0.65)}
.options-title{font-family:"Cinzel", serif;font-size:30px;margin:0 0 10px;color:#ffe7ff;text-align:center}
.options-grid{display:grid;grid-template-columns:1fr;gap:14px}
.opt-row{display:flex;align-items:center;justify-content:space-between;gap:14px;background:#16131f;border:1px solid #2b2338;padding:12px 14px;border-radius:12px}
.opt-row label{color:#e3dff0}
.opt-row input[type="range"]{width:220px}
.opt-row select{background:#0f0c14;color:#fff;border:1px solid #2b2338;border-radius:8px;padding:6px 8px}
.opt-actions{display:flex;justify-content:center;gap:10px;margin-top:16px}
.opt-btn{padding:10px 16px;border-radius:10px;background:linear-gradient(90deg,#ff3b7f,#b84dff)}
.opt-btn.secondary{background:#1b1524;color:#f5f2ff;border:1px solid #2e243a;box-shadow:none}

@media (max-width: 980px){
  body{flex-direction:column;align-items:stretch;padding:14px}
  #questBoard,#mapBoard{width:100%;position:static}
  #game,#dungeonUI{width:100%;padding:18px}
  #hud{flex-direction:column;align-items:flex-start}
  #menu{min-height:auto}
}

@media (max-width: 560px){
  h1{font-size:24px}
  button{width:100%}
  #actions,#secondaryActions,#menu,.quest-actions,.quest-sort{justify-content:stretch}
  #actions button,#secondaryActions button{flex:1}
  .monster-img{width:80px;height:80px}
}
</style>
</head>
<body>

<div id="startScreen" class="screen"></div>
<div id="classScreen" class="screen"></div>
<div id="optionsScreen" class="screen"></div>
<div id="toast"></div>

<div id="questBoard">
  <div id="questPanel">
    <h2>📜 Quêtes</h2>
    <div id="questList"></div>
  </div>
</div>

<div id="game">
<h1 id="zoneTitle">Plaine</h1>
<div id="eventBanner" class="event-banner" style="display:none;"></div>
<div id="hud"></div>
<div id="stats"></div>
<div class="bar-container"><div id="hpBar" class="bar hp"></div></div>
<div class="bar-container"><div id="xpBar" class="bar xp"></div></div>

<div id="monsterContainer">
 <div id="monsterStats"></div>
 <img id="monsterImg" class="monster-img" alt="Monstre">
 <div class="bar-container"><div id="monsterHpBar" class="bar monster-bar"></div></div>
</div>

<div id="log"></div>
<div id="actions"></div>
<div id="secondaryActions" class="secondary-panel"></div>
<div id="menu"></div>
<button onclick="enterDungeon()">🗝️ Entrer dans un donjon</button>
</div>

<div id="mapBoard">
  <div id="mapPanel">
    <h2>🗺️ Carte</h2>
    <div id="zoneMap"></div>
  </div>
</div>

<div id="dungeonUI">
<h1>🏰 Donjon</h1>
<div id="dungeonPlayer"></div>
<div class="bar-container"><div id="dungeonPlayerHpBar" class="bar hp"></div></div>
<img id="dungeonMonsterImg" class="monster-img" alt="Monstre">
<div id="dungeonStats"></div>
<div class="bar-container"><div id="dungeonHpBar" class="bar monster-bar"></div></div>
<div id="dungeonLog"></div>
<div id="dungeonActions"></div>
</div>

<script>
// ===== CONFIG =====
const XP_PER_LEVEL = 60;
const POTION_HEAL = 20;
const RESPAWN_BASE_POTIONS = 3;
const SPRITE_PATHS = [
    '../assets/monsters/',
    'assets/monsters/'
];

// ===== PLAYER =====
let player = {
    hp:50, maxHp:50, atk:8, level:1, xp:0, potions:3, gold:0, talentPoints:0,
    talents:{strength:0, vitality:0, alchemy:0, luck:0},
    skill:{name:'Coup puissant', mult:2, cooldown:0, maxCd:3},
    equipment:{weapon:null, armor:null, helmet:null, ring:null, amulet:null},
    inventory:{weapons:[], armors:[], helmets:[], rings:[], amulets:[], drops:[]},
    class:null,
    specialization:null,
    companion:null,
    artifact:null,
    artifacts:[],
    defeatedBosses:[]
};
let bestiary = {};
let achievements = {};

// ===== QUEST & DONJON =====
let questLevel = 1;
let quests = [];
let dungeon = {level:1, rooms:[], current:0};
let inDungeon = false;
let dungeonEnemy = null;
let dungeonRoomCleared = false;
let dungeonRoomType = '';
let inArena = false;
let arenaWave = 0;
let seasonalEvent = null;
let dailyQuest = null;
let weeklyQuest = null;
const zones = [
    {id:'plaine', name:'Plaine', diff:1, rewardMult:1, reqLevel:1, monsters:[
        {name:'Gobelin',hp:28,atk:6},
        {name:'Loup',hp:26,atk:8},
        {name:'Squelette',hp:32,atk:7}
    ], boss:{name:'Chef gobelin', hp:60, atk:10, lore:'Un chef brutal qui règne sur les pillards.', artifact:{id:'totem-gob', name:'Totem du Chef', atk:2, hp:10, desc:'Bonus d’attaque et vitalité.'}}},
    {id:'foret', name:'Forêt Sombre', diff:2, rewardMult:1.2, reqLevel:3, monsters:[
        {name:'Orc',hp:38,atk:9},
        {name:'Druide corrompu',hp:34,atk:10},
        {name:'Araignée géante',hp:36,atk:9}
    ], boss:{name:'Sylve infectée', hp:75, atk:13, lore:'Un esprit corrompu qui flétrit la forêt.', artifact:{id:'seed-sylve', name:'Graine de Sylve', hp:20, desc:'Régénération légère (PV +).'}}},
    {id:'marais', name:'Marais', diff:3, rewardMult:1.4, reqLevel:5, monsters:[
        {name:'Spectre',hp:40,atk:11},
        {name:'Sangsue géante',hp:42,atk:10},
        {name:'Shaman des boues',hp:38,atk:12}
    ], boss:{name:'Seigneur des brumes', hp:90, atk:15, lore:'Maître des eaux troubles, il engloutit tout.', artifact:{id:'mist-core', name:'Cœur de Brume', atk:3, desc:'+ATK et chance de loot.' , loot:0.03}}},
    {id:'volcan', name:'Volcan', diff:4, rewardMult:1.7, reqLevel:8, monsters:[
        {name:'Élémentaire de feu',hp:45,atk:14},
        {name:'Salamandre',hp:44,atk:13},
        {name:'Guerrier d’obsidienne',hp:48,atk:15}
    ], boss:{name:'Titan de lave', hp:110, atk:18, lore:'Un colosse incandescent fait de lave.', artifact:{id:'ember-crown', name:'Couronne de Braise', atk:4, desc:'Puissance ardente.'}}},
    {id:'montagnes', name:'Montagnes Gelées', diff:5, rewardMult:2.0, reqLevel:12, monsters:[
        {name:'Golem de givre',hp:58,atk:18},
        {name:'Valkyrie déchue',hp:54,atk:19},
        {name:'Yéti',hp:62,atk:17}
    ], boss:{name:'Roi givre', hp:130, atk:20, lore:'Souverain des neiges éternelles.', artifact:{id:'ice-shard', name:'Éclat polaire', hp:30, desc:'PV max augmentés.'}}},
    {id:'ruines', name:'Ruines Astrales', diff:6, rewardMult:2.4, reqLevel:16, monsters:[
        {name:'Gardien runique',hp:70,atk:22},
        {name:'Oracle brisé',hp:66,atk:24},
        {name:'Spectre stellaire',hp:64,atk:23}
    ], boss:{name:'Primordial astral', hp:150, atk:23, lore:'Un ancien gardien des étoiles.', artifact:{id:'astral-eye', name:'Œil Astral', atk:5, loot:0.04, desc:'ATK + chance de loot.'}}},
    {id:'abysses', name:'Abysses', diff:7, rewardMult:2.9, reqLevel:20, monsters:[
        {name:'Titan abysse',hp:82,atk:27},
        {name:'Sanguinaire',hp:78,atk:29},
        {name:'Briseur d’âmes',hp:86,atk:28}
    ], boss:{name:'Seigneur des abysses', hp:180, atk:28, lore:'Il dévore les âmes tombées.', artifact:{id:'void-heart', name:'Cœur du Néant', atk:6, hp:20, lifesteal:0.08, desc:'Puissance et vol de vie.'}}}
];
let currentZone = zones[0];

// ===== UTILS =====
const MONSTER_SPRITES = {
    'Gobelin':'gobelin.png',
    'Loup':'loup.png',
    'Squelette':'squelette.png',
    'Orc':'orc.png',
    'Druide corrompu':'druide_corrompu.png',
    'Araignée géante':'araignee_geante.png',
    'Spectre':'spectre.png',
    'Sangsue géante':'sangsue_geante.png',
    'Shaman des boues':'shaman_boues.png',
    'Élémentaire de feu':'elementaire_feu.png',
    'Salamandre':'salamandre.png',
    'Guerrier d’obsidienne':'guerrier_obsidienne.png',
    'Golem de givre':'golem_givre.png',
    'Valkyrie déchue':'valkyrie_dechue.png',
    'Yéti':'yeti.png',
    'Gardien runique':'gardien_runique.png',
    'Oracle brisé':'oracle_brise.png',
    'Spectre stellaire':'spectre_stellaire.png',
    'Titan abysse':'titan_abysse.png',
    'Sanguinaire':'sanguinaire.png',
    'Briseur d’âmes':'briseur_ames.png',
    'Démon corrompu':'demon_corrompu.png',
    'Seigneur Squelette':'seigneur_squelette.png',
    'Hydre d’acier':'hydre_acier.png',
    'Reine arachnide':'araignee_geante.png',
    'Colosse runique':'colosse_runique.png',
    'Dragon de cendre':'dragon_cendre.png',
    'Spectre primordial':'spectre_primordial.png',
    'Chef gobelin':'chef_gobelin.png',
    'Sylve infectée':'sylve_infectee.png',
    'Seigneur des brumes':'seigneur_brume.png',
    'Titan de lave':'titan_lave.png',
    'Roi givre':'roi_givre.png',
    'Primordial astral':'primordial_astral.png',
    'Seigneur des abysses':'seigneur_abysses.png'
};


const ACHIEVEMENTS_LIST = [
    {id:'first_blood', name:'Premier sang', desc:'Vaincre 1 monstre'},
    {id:'hunter_10', name:'Chasseur', desc:'Vaincre 10 monstres'},
    {id:'boss_hunter', name:'Tueur de boss', desc:'Vaincre un boss de zone'},
    {id:'rich_100', name:'Riche', desc:'Atteindre 100 or'},
    {id:'legendary_1', name:'Légendaire', desc:'Obtenir un objet légendaire'},
    {id:'arena_win', name:'Champion', desc:'Terminer l’arène'}
];

const BESTIARY_DESC = {
    'Gobelin':'Petit pillard rusé.',
    'Loup':'Prédateur rapide des plaines.',
    'Squelette':'Guerrier revenu d’entre les morts.',
    'Orc':'Brute endurante et agressive.',
    'Druide corrompu':'Esprit sauvage dévoyé.',
    'Araignée géante':'Arachnide venimeux.',
    'Spectre':'Âme errante et glaciale.',
    'Sangsue géante':'Parasite vorace des marais.',
    'Shaman des boues':'Sorcier des marécages.',
    'Élémentaire de feu':'Incarnation des flammes.',
    'Salamandre':'Créature ardente et vive.',
    'Guerrier d’obsidienne':'Armure animée par la lave.',
    'Golem de givre':'Colosse de glace.',
    'Valkyrie déchue':'Ancienne gardienne dépravée.',
    'Yéti':'Bête massive des neiges.',
    'Gardien runique':'Automate ancestral.',
    'Oracle brisé':'Devineresse hantée.',
    'Spectre stellaire':'Ombre venue des étoiles.',
    'Titan abysse':'Monstre colossal des profondeurs.',
    'Sanguinaire':'Bourreau des abysses.',
    'Briseur d’âmes':'Prédateur d’esprits.',
    'Chef gobelin':'Seigneur des pillards.',
    'Sylve infectée':'Esprit forestier corrompu.',
    'Seigneur des brumes':'Maître du marais.',
    'Titan de lave':'Colosse incandescent.',
    'Roi givre':'Souverain des glaces.',
    'Primordial astral':'Gardien des ruines.',
    'Seigneur des abysses':'Tyran des profondeurs.'
};

function pickSpriteBase(){
    const path = location.pathname || '';
    if(path.includes('/Html%20%26%20Css/') || path.includes('/Html & Css/')){
        return SPRITE_PATHS[0];
    }
    return SPRITE_PATHS[1];
}

function setMonsterImage(imgId, name){
    const img = document.getElementById(imgId);
    if(!img) return;
    const file = MONSTER_SPRITES[name];
    if(!file){
        img.style.display = 'none';
        return;
    }
    const primary = pickSpriteBase() + file;
    const fallback = (primary.startsWith('../') ? SPRITE_PATHS[1] : SPRITE_PATHS[0]) + file;
    img.onerror = () => {
        if(img.src.endsWith(fallback)) return;
        img.src = fallback;
    };
    img.src = primary;
    img.style.display = 'block';
}

function updateBestiary(name, type){
    if(!name) return;
    if(!bestiary[name]){
        bestiary[name] = {kills:0, firstSeen: Date.now(), type};
    }
    bestiary[name].kills += 1;
}

function unlockAchievement(id){
    if(achievements[id]) return;
    achievements[id] = {unlocked:true, time:Date.now()};
    const a = ACHIEVEMENTS_LIST.find(x=>x.id===id);
    if(a){
        log(`🏅 Succès débloqué: ${a.name}`);
        showToast(`Succès débloqué`, a.name);
    }
}

function checkAchievements(){
    const totalKills = Object.values(bestiary).reduce((s,b)=>s + (b.kills||0),0);
    if(totalKills >= 1) unlockAchievement('first_blood');
    if(totalKills >= 10) unlockAchievement('hunter_10');
    if(player.gold >= 100) unlockAchievement('rich_100');
    if(player.artifacts && player.artifacts.length > 0) unlockAchievement('legendary_1');
}

function showToast(title, message){
    const box = document.getElementById('toast');
    if(!box) return;
    const el = document.createElement('div');
    el.className = 'toast-item';
    el.innerHTML = `<div class="toast-title">${title}</div><div class="small">${message}</div>`;
    box.appendChild(el);
    setTimeout(()=>{el.remove();}, 2500);
}

function renderBestiary(){
    const m = document.getElementById('menu');
    const entries = Object.entries(bestiary);
    m.innerHTML = `<h3>📖 Bestiaire</h3>`;
    if(entries.length===0){
        m.innerHTML += `<div class="small">Aucun monstre rencontré.</div>`;
        return;
    }
    entries.sort((a,b)=>b[1].kills - a[1].kills);
    entries.forEach(([name,data])=>{
        const info = getMonsterInfo(name);
        const img = MONSTER_SPRITES[name] ? `${SPRITE_PATH}${MONSTER_SPRITES[name]}` : '';
        const desc = BESTIARY_DESC[name] || 'Créature mystérieuse.';
        m.innerHTML += `<div class="list-card">
            <div class="bestiary-row">
                ${img ? `<img class="bestiary-img" src="${img}" alt="${name}">` : ''}
                <div>
                    <div><b>${name}</b></div>
                    <div class="small">${desc}</div>
                    <div class="small">HP: ${info.hp} | ATK: ${info.atk} | Type: ${info.type}</div>
                    <div class="small">Kills: ${data.kills}</div>
                </div>
            </div>
        </div>`;
    });
}

function renderAchievements(){
    const m = document.getElementById('menu');
    m.innerHTML = `<h3>🏅 Succès</h3>`;
    ACHIEVEMENTS_LIST.forEach(a=>{
        const unlocked = achievements[a.id]?.unlocked;
        m.innerHTML += `<div class="list-card">
            <div><b>${a.name}</b> ${unlocked ? '✅' : '❌'}</div>
            <div class="small">${a.desc}</div>
        </div>`;
    });
}

function getMonsterInfo(name){
    for(const z of zones){
        for(const m of z.monsters){
            if(m.name===name) return {hp:m.hp, atk:m.atk, type:'normal'};
        }
        if(z.boss && z.boss.name===name){
            return {hp:z.boss.hp, atk:z.boss.atk, type:'boss'};
        }
    }
    return {hp:'?', atk:'?', type:'?'};
}
function log(msg){const l=document.getElementById('log');l.innerHTML+=msg+'<br>';l.scrollTop=l.scrollHeight;}
function dungeonLog(msg){const l=document.getElementById('dungeonLog');l.innerHTML+=msg+'<br>';l.scrollTop=l.scrollHeight;}
function rarityColor(r){return r==='Commun'?'#aaa':r==='Rare'?'#00bfff':r==='Épique'?'#d600ff':'#ffb200';}
function getTalentAtk(){return (player.talents?.strength||0);}
function getFactionAtk(){return applyFactionPerks().atk;}
function getSpecAtk(){return player.specialization?.atk || 0;}
function getSpecHp(){return player.specialization?.hp || 0;}
function getCompanionAtk(){return player.companion?.atk || 0;}
function getEventAtk(){return seasonalEvent?.bonus?.atk || 0;}
function getArtifactAtk(){return player.artifact?.atk || 0;}
function getArtifactHp(){return player.artifact?.hp || 0;}
function getArtifactLoot(){return player.artifact?.loot || 0;}
function getArtifactLifesteal(){return player.artifact?.lifesteal || 0;}
function getFactionHp(){return applyFactionPerks().hp;}
function getTalentBonusHp(){return (player.talents?.vitality||0) * 5;}
function getLuckBonus(){return (player.talents?.luck||0) * 0.02;}
function getPotionHeal(){return POTION_HEAL + (player.talents?.alchemy||0) * 2;}
function getEventLootBonus(){return seasonalEvent?.bonus?.loot || 0;}
function getAtk(){return player.atk+(player.equipment.weapon?player.equipment.weapon.atk:0)+(player.equipment.ring?player.equipment.ring.atk:0)+getTalentAtk()+getFactionAtk()+getSpecAtk()+getEventAtk()+getArtifactAtk();}
function getDef(){return (player.equipment.armor?player.equipment.armor.def:0)+(player.equipment.helmet?player.equipment.helmet.def:0);}
function getBonusHp(){return (player.equipment.amulet?player.equipment.amulet.hp:0)+getTalentBonusHp()+getFactionHp()+getSpecHp()+getArtifactHp();}
function clamp(v,min,max){return Math.max(min,Math.min(max,v));}

// ===== ENEMIES =====
function initEnemy(level=1, type='normal'){
    const monsters = currentZone.monsters;
    const bosses=[
        {name:'Démon corrompu',hp:85,atk:16},
        {name:'Seigneur Squelette',hp:80,atk:15},
        {name:'Hydre d’acier',hp:90,atk:17},
        {name:'Reine arachnide',hp:88,atk:18},
        {name:'Colosse runique',hp:98,atk:20},
        {name:'Dragon de cendre',hp:110,atk:22},
        {name:'Spectre primordial',hp:105,atk:23}
    ];
    const m = type==='boss'
        ? bosses[Math.floor(Math.random()*bosses.length)]
        : monsters[Math.floor(Math.random()*monsters.length)];
    const scale = type==='boss' ? 1.35 : 1;
    const zoneScale = 1 + (currentZone.diff-1)*0.12;
    let hp = Math.floor((m.hp + level*5) * scale * zoneScale);
    let atk = Math.floor((m.atk + level*2) * scale * zoneScale);
    const affixes = [
        {name:'Féroce', hp:1.0, atk:1.2},
        {name:'Colossal', hp:1.25, atk:0.95},
        {name:'Sanguinaire', hp:1.1, atk:1.1},
        {name:'Rapide', hp:0.9, atk:1.15},
        {name:'Maudit', hp:1.05, atk:1.05}
    ];
    let affix = null;
    if(Math.random() < 0.25){
        affix = affixes[Math.floor(Math.random()*affixes.length)];
        hp = Math.floor(hp * affix.hp);
        atk = Math.floor(atk * affix.atk);
    }
    return {name:m.name,hp:hp,maxHp:hp,atk:atk,type, affix};
}
let enemy=initEnemy();

// ===== LOOT =====
function rollRarity(){
    const r=Math.random();
    const luck = getLuckBonus() + (seasonalEvent?.bonus?.loot || 0);
    if(r<0.7) return 'Commun';
    if(r<0.93) return 'Rare';
    if(r<0.995 - luck) return 'Épique';
    return 'Légendaire';
}
function generateItem(){
    const types=['weapon','armor','helmet','ring','amulet'];
    const type=types[Math.floor(Math.random()*types.length)];
    const rarity=rollRarity();
    const mult=rarity==='Commun'?1:rarity==='Rare'?1.5:2.2;
    const base = Math.max(1, Math.floor(player.level*2*mult));

    const names={
        weapon:['Lame','Hache','Dague','Épée','Marteau'],
        armor:['Cuirasse','Armure','Plastron'],
        helmet:['Casque','Heaume','Visière'],
        ring:['Anneau','Bague','Sceau'],
        amulet:['Talisman','Amulette','Pendentif']
    };
    const n=names[type][Math.floor(Math.random()*names[type].length)];

    if(type==='weapon' || type==='ring'){
        const atk=base + (type==='weapon'?2:0);
        const effect = rarity==='Légendaire' ? {lifesteal:0.1} : null;
        return {type, name:`${n} ${rarity}`, atk, rarity, effect};
    }
    if(type==='amulet'){
        const hp = base * 4;
        const effect = rarity==='Légendaire' ? {lifesteal:0.05} : null;
        return {type, name:`${n} ${rarity}`, hp, rarity, effect};
    }
    const def=base;
    const effect = rarity==='Légendaire' ? {lifesteal:0.05} : null;
    return {type, name:`${n} ${rarity}`, def, rarity, effect};
}
function addLoot(item){
    if(item.type==='weapon') player.inventory.weapons.push(item);
    if(item.type==='armor') player.inventory.armors.push(item);
    if(item.type==='helmet') player.inventory.helmets.push(item);
    if(item.type==='ring') player.inventory.rings.push(item);
    if(item.type==='amulet') player.inventory.amulets.push(item);
}
function generateDrop(){
    const rarity = rollRarity();
    const pool = [
        'Essence néon',
        'Éclat d’ombre',
        'Poussière astrale',
        'Fragment cristallin',
        'Peau de bête',
        'Cendre arcanique'
    ];
    const name = pool[Math.floor(Math.random()*pool.length)];
    return {name, rarity, qty:1};
}
function addDrop(drop){
    const existing = player.inventory.drops.find(d => d.name === drop.name && d.rarity === drop.rarity);
    if(existing) existing.qty += drop.qty;
    else player.inventory.drops.push(drop);
    applyQuestProgress({dropName:drop.name, dropQty:drop.qty});
}
function dropRarityScore(r){
    return r==='Commun' ? 1 : r==='Rare' ? 2 : 3;
}
function getDropQty(name){
    return player.inventory.drops
        .filter(d => d.name === name)
        .reduce((sum,d)=>sum + d.qty, 0);
}
function spendDropByName(name, qty){
    let remaining = qty;
    const buckets = player.inventory.drops
        .filter(d => d.name === name)
        .sort((a,b)=>dropRarityScore(a.rarity)-dropRarityScore(b.rarity));
    for(const d of buckets){
        if(remaining <= 0) break;
        const use = Math.min(d.qty, remaining);
        d.qty -= use;
        remaining -= use;
    }
    player.inventory.drops = player.inventory.drops.filter(d => d.qty > 0);
    return remaining === 0;
}
function checkQuestCompletion(q, source){
    if(q.completed) return;
    const done =
        (q.objective.kills ? q.progress.kills >= q.objective.kills : true) &&
        (q.objective.chests ? q.progress.chests >= q.objective.chests : true) &&
        (q.objective.boss ? q.progress.boss : true) &&
        (q.objective.drop ? (q.progress.drop||0) >= q.objective.drop.qty : true) &&
        (q.objective.zoneKills ? (q.progress.zoneKills||0) >= q.objective.zoneKills : true);
    if(!done) return;
    q.completed = true;
    const doneMsg = `🏆 Quête terminée: ${q.name} ! (Va la valider)`;
    if(source==='dungeon') dungeonLog(doneMsg); else log(doneMsg);
    updateUI();
}

function renderQuestBoard(){
    const list = document.getElementById('questList');
    if(!quests.length){
        list.innerHTML = '<div class="small">Aucune quête active.</div>';
        return;
    }
    list.innerHTML = quests.map((q,i)=>{
        const status = q.completed ? (q.claimed ? 'Validée' : 'Terminée') : 'En cours';
        const canClaim = q.completed && !q.claimed;
        const dropLine = q.objective.drop ? `<div class="meta">Objet ${q.objective.drop.name}: ${q.progress.drop||0}/${q.objective.drop.qty}</div>` : '';
        const zoneLine = q.objective.zoneKills ? `<div class="meta">Zone ${q.objective.zoneName}: ${q.progress.zoneKills||0}/${q.objective.zoneKills}</div>` : '';
        return `
        <div class="quest">
            <div class="title">${q.name}</div>
            ${q.objective.kills ? `<div class="meta">Kills ${q.progress.kills}/${q.objective.kills}</div>` : ''}
            ${q.objective.chests ? `<div class="meta">Coffres ${q.progress.chests}/${q.objective.chests}</div>` : ''}
            ${q.objective.boss ? `<div class="meta">Boss ${q.progress.boss?'✅':'❌'}</div>` : ''}
            ${dropLine}
            ${zoneLine}
            <div class="meta">Récompense: ${q.reward.xp} XP, ${q.reward.gold||0} or${q.reward.loot?' + loot':''}</div>
            <div class="meta">Statut: ${status}</div>
            <button class="item-btn" ${canClaim?'':'disabled'} onclick="claimQuest(${i})">Valider la quête</button>
        </div>`;
    }).join('');
}

// ===== QUEST MENU =====
let questSortMode = 'status';
function renderQuestMenu(){
    const m = document.getElementById('menu');
    const sorted = sortQuests(quests.map((q,i)=>({q,i})));
    m.innerHTML = `<h3>📜 Quêtes</h3>
        <div class="quest-sort">
            <button class="item-btn" onclick="setQuestSort('status')">Statut</button>
            <button class="item-btn" onclick="setQuestSort('faction')">Faction</button>
            <button class="item-btn" onclick="setQuestSort('reward')">Récompense</button>
        </div>
        <div class="small">Actives: ${quests.length}</div>
        ${dailyQuest ? `<div class="small">Quête quotidienne: ${dailyQuest.quest.name}</div>` : ''}
        ${weeklyQuest ? `<div class="small">Quête hebdo: ${weeklyQuest.quest.name}</div>` : ''}
        <div class="quest-menu">${sorted.map(({q,i})=>renderQuestCard(q,i)).join('')}</div>`;
}
function renderQuestCard(q, idx){
    const status = q.completed ? (q.claimed ? 'Validée' : 'Terminée') : 'En cours';
    const canClaim = q.completed && !q.claimed;
    const dropLine = q.objective.drop ? `<div class="small">Objet ${q.objective.drop.name}: ${q.progress.drop||0}/${q.objective.drop.qty}</div>` : '';
    const zoneLine = q.objective.zoneKills ? `<div class="small">Zone ${q.objective.zoneName}: ${q.progress.zoneKills||0}/${q.objective.zoneKills}</div>` : '';
    return `
    <div class="quest-card">
        <div class="quest-head">
            <div><b>${q.name}</b> <span class="badge">${status}</span></div>
            <span class="quest-faction">${q.faction}</span>
        </div>
        ${q.objective.kills ? `<div class="small">Kills ${q.progress.kills}/${q.objective.kills}</div>` : ''}
        ${q.objective.chests ? `<div class="small">Coffres ${q.progress.chests}/${q.objective.chests}</div>` : ''}
        ${q.objective.boss ? `<div class="small">Boss ${q.progress.boss?'✅':'❌'}</div>` : ''}
        ${dropLine}
        ${zoneLine}
        <div class="small">Récompense: ${q.reward.xp} XP, ${q.reward.gold||0} or${q.reward.loot?' + loot':''}</div>
        <div class="quest-actions">
            <button class="item-btn" ${canClaim?'':'disabled'} onclick="claimQuest(${idx})">Valider</button>
            <button class="item-btn" onclick="abandonQuest(${idx})">Abandonner</button>
        </div>
    </div>`;
}
function setQuestSort(mode){
    questSortMode = mode;
    renderQuestMenu();
}
function sortQuests(list){
    if(questSortMode==='faction'){
        return list.sort((a,b)=>a.q.faction.localeCompare(b.q.faction));
    }
    if(questSortMode==='reward'){
        return list.sort((a,b)=>(b.q.reward.gold||0)-(a.q.reward.gold||0));
    }
    return list.sort((a,b)=>Number(a.q.completed)-Number(b.q.completed));
}
function abandonQuest(i){
    if(!quests[i]) return;
    quests.splice(i,1);
    quests.push(generateQuest(questLevel++));
    log('🗑️ Quête abandonnée.');
    updateUI();
    renderQuestMenu();
    saveGame();
}
function claimQuest(i){
    const q = quests[i];
    if(!q || !q.completed || q.claimed) return;
    q.claimed = true;
    const xpGain = q.reward.xp || 0;
    if(xpGain > 0) grantXP(xpGain);
    const goldGain = q.reward.gold || 0;
    if(goldGain > 0) grantGold(goldGain);
    if(q.reward.loot){
        const drop = generateDrop();
        addDrop(drop);
        log(`🎁 Récompense de quête: ${drop.name} x${drop.qty} [${drop.rarity}]`);
    }
    addReputation(q.faction, 5);
    log(`✅ Quête validée: ${q.name}`);
    replaceQuestAt(i);
    updateUI();
    saveGame();
}
function generateQuest(level){
    const types = ['hunt','chest','boss','drop','zone'];
    const type = types[Math.floor(Math.random()*types.length)];
    const baseKills = 3 + level * 2;
    const baseChests = 1 + Math.floor(level/2);
    const reward = {xp: 35 + level * 16, gold: 20 + level * 8, loot: true};
    let objective = {kills:0, chests:0, boss:false};
    let progress = {kills:0, chests:0, boss:false, drop:0, zoneKills:0};
    let name = `Aventure ${level}`;
    let faction = 'Explorateurs';
    if(type==='hunt'){
        objective.kills = baseKills;
        name = `Chasse ${level}`;
        faction = 'Chasseurs';
    } else if(type==='chest'){
        objective.chests = baseChests + 1;
        name = `Trésors ${level}`;
        faction = 'Explorateurs';
    } else if(type==='boss'){
        objective.kills = Math.max(2, Math.floor(level/2));
        objective.boss = true;
        name = `Boss ${level}`;
        faction = 'Chasseurs';
    } else if(type==='drop'){
        const pool = ['Essence néon','Éclat d’ombre','Poussière astrale','Fragment cristallin'];
        const dropName = pool[Math.floor(Math.random()*pool.length)];
        objective.drop = {name:dropName, qty:2 + Math.floor(level/2)};
        objective.kills = Math.max(2, Math.floor(level/2));
        name = `Collecte ${level}`;
        faction = 'Arcanes';
    } else if(type==='zone'){
        const unlocked = zones.filter(z=>player.level >= z.reqLevel);
        const z = unlocked[Math.floor(Math.random()*unlocked.length)];
        objective.zoneId = z.id;
        objective.zoneName = z.name;
        objective.zoneKills = 4 + level;
        name = `Purge ${z.name}`;
        faction = 'Explorateurs';
    }
    return {name, objective, progress, reward, completed:false, claimed:false, faction};
}
function initQuests(count=3){
    quests = [];
    for(let i=0;i<count;i++){
        quests.push(generateQuest(questLevel));
        questLevel++;
    }
}
function replaceQuestAt(i){
    quests[i] = generateQuest(questLevel);
    questLevel++;
    saveGame();
}

function applyQuestProgress({kills=0, chests=0, boss=false, dropName='', dropQty=0, zoneId=''}){
    const source = inDungeon ? 'dungeon' : 'world';
    quests.forEach(q=>{
        if(kills && q.objective.kills){
            q.progress.kills += kills;
        }
        if(chests && q.objective.chests){
            q.progress.chests += chests;
        }
        if(boss && q.objective.boss){
            q.progress.boss = true;
        }
        if(dropName && q.objective.drop && q.objective.drop.name === dropName){
            q.progress.drop = (q.progress.drop||0) + dropQty;
        }
        if(zoneId && q.objective.zoneKills && q.objective.zoneId === zoneId){
            q.progress.zoneKills = (q.progress.zoneKills||0) + kills;
        }
        checkQuestCompletion(q, source);
    });
    if(dailyQuest){
        applyQuestToSpecial(dailyQuest, {kills, chests, boss, dropName, dropQty, zoneId}, source);
    }
    if(weeklyQuest){
        applyQuestToSpecial(weeklyQuest, {kills, chests, boss, dropName, dropQty, zoneId}, source);
    }
}

function applyQuestToSpecial(holder, payload, source){
    const q = holder.quest;
    if(!q || q.completed) return;
    const {kills, chests, boss, dropName, dropQty, zoneId} = payload;
    if(kills && q.objective.kills){q.progress.kills += kills;}
    if(chests && q.objective.chests){q.progress.chests += chests;}
    if(boss && q.objective.boss){q.progress.boss = true;}
    if(dropName && q.objective.drop && q.objective.drop.name === dropName){q.progress.drop = (q.progress.drop||0) + dropQty;}
    if(zoneId && q.objective.zoneKills && q.objective.zoneId === zoneId){q.progress.zoneKills = (q.progress.zoneKills||0) + kills;}
    checkQuestCompletion(q, source);
    if(q.completed && !holder.claimed){
        holder.claimed = true;
        grantXP(q.reward.xp || 0);
        grantGold(q.reward.gold || 0);
        log(`🎯 Quête spéciale complétée: ${q.name}`);
    }
}

// ===== UI =====
function updateUI(){
    if(!classChosen){
        document.getElementById('stats').innerHTML='Choisis une classe pour commencer.';
        document.getElementById('hpBar').style.width='0%';
        document.getElementById('xpBar').style.width='0%';
        document.getElementById('monsterStats').innerHTML='';
        document.getElementById('monsterHpBar').style.width='0%';
        return;
    }
    if(seasonalEvent){
        const banner = document.getElementById('eventBanner');
        banner.style.display = 'block';
        banner.textContent = `Événement: ${seasonalEvent.name} — ${seasonalEvent.desc}`;
    } else {
        const banner = document.getElementById('eventBanner');
        banner.style.display = 'none';
    }
    const maxHpTotal = player.maxHp + getBonusHp();
    if(player.hp > maxHpTotal) player.hp = maxHpTotal;
    const title = document.getElementById('zoneTitle');
    if(title) title.textContent = currentZone.name;
    document.getElementById('stats').innerHTML=`👤 ${player.class} | 🌍 ${currentZone.name} | ❤️ ${player.hp}/${maxHpTotal} | ⚔️ ${getAtk()} | 🛡️ ${getDef()} | ⭐ Lv ${player.level} | 🧪 ${player.potions} | 💰 ${player.gold} | ✨ ${player.talentPoints}`;
    const hud = document.getElementById('hud');
    const totalBosses = zones.filter(z=>z.boss).length;
    const defeatedCount = player.defeatedBosses.length;
    const buffs = [];
    if(player.specialization) buffs.push(`Spé: ${player.specialization.name}`);
    if(player.companion) buffs.push(`Compagnon: ${player.companion.name}`);
    if(player.artifact) buffs.push(`Artefact: ${player.artifact.name}`);
    if(seasonalEvent) buffs.push(`Event: ${seasonalEvent.name}`);
    hud.innerHTML = `
        <div class="hud-left">${buffs.map(b=>`<span class="pill">${b}</span>`).join('')}</div>
        <div class="hud-right">
            <span class="pill">Boss ${defeatedCount}/${totalBosses}</span>
            <span class="pill">Loot+ ${(Math.round((getLuckBonus()+getEventLootBonus()+getArtifactLoot())*100))}%</span>
            <span class="pill">ATK ${getAtk()}</span>
            <span class="pill">PV ${player.hp}/${maxHpTotal}</span>
        </div>`;
    document.getElementById('hpBar').style.width=clamp(player.hp/maxHpTotal*100,0,100)+'%';
    document.getElementById('xpBar').style.width=clamp(player.xp/(player.level*XP_PER_LEVEL)*100,0,100)+'%';
    const aff = enemy.affix ? ` (${enemy.affix.name})` : '';
    document.getElementById('monsterStats').innerHTML=`👹 ${enemy.name}${aff} HP: ${enemy.hp}/${enemy.maxHp}`;
    document.getElementById('monsterHpBar').style.width=clamp(enemy.hp/enemy.maxHp*100,0,100)+'%';
    setMonsterImage('monsterImg', enemy.name);
    renderQuestBoard();
    renderZoneMap();
    checkAchievements();
}
function updateDungeonUI(){
    let line = '';
    if(inArena){
        line = `Arène | Vague ${arenaWave}`;
    } else {
        const room = dungeon.rooms[dungeon.current];
        line = `Niveau ${dungeon.level} | Salle ${dungeon.current+1}/${dungeon.rooms.length} | Type: ${room.type}`;
    }
    const maxHpTotal = player.maxHp + getBonusHp();
    if(player.hp > maxHpTotal) player.hp = maxHpTotal;
    document.getElementById('dungeonPlayer').innerHTML=`👤 ${player.class} | ❤️ ${player.hp}/${maxHpTotal} | ⚔️ ${getAtk()} | 🛡️ ${getDef()}`;
    document.getElementById('dungeonPlayerHpBar').style.width=clamp(player.hp/maxHpTotal*100,0,100)+'%';
    if(dungeonEnemy){
        const aff = dungeonEnemy.affix ? ` (${dungeonEnemy.affix.name})` : '';
        line += ` | 👹 ${dungeonEnemy.name}${aff} ${dungeonEnemy.hp}/${dungeonEnemy.maxHp}`;
        document.getElementById('dungeonHpBar').style.width=clamp(dungeonEnemy.hp/dungeonEnemy.maxHp*100,0,100)+'%';
        setMonsterImage('dungeonMonsterImg', dungeonEnemy.name);
    } else {
        document.getElementById('dungeonHpBar').style.width='0%';
        const img = document.getElementById('dungeonMonsterImg');
        if(img) img.style.display = 'none';
    }
    document.getElementById('dungeonStats').innerHTML=line;
}

// ===== COMBAT (MONDE) =====
function attack(){
    if(player.hp<=0)return;
    const dmg=Math.floor(Math.random()*4)+getAtk();
    enemy.hp-=dmg;
    log(`⚔️ Tu infliges ${dmg} dégâts à ${enemy.name}`);
    applyLifesteal(dmg);
    companionStrike(enemy);
    if(enemy.hp<=0){winCombat(false);return;}
    enemyTurn(false);
}
function useSkill(){
    if(player.skill.cooldown>0){log('⏳ Compétence en recharge');return;}
    const dmg=Math.floor(getAtk()*player.skill.mult);
    enemy.hp-=dmg;
    player.skill.cooldown=player.skill.maxCd;
    log(`🔥 ${player.skill.name} inflige ${dmg} dégâts !`);
    applyLifesteal(dmg);
    companionStrike(enemy);
    if(enemy.hp<=0){winCombat(false);return;}
    enemyTurn(false);
}
function enemyTurn(isDungeon){
    const foe = isDungeon ? dungeonEnemy : enemy;
    if(!foe) return;
    const dmg=Math.max(1,foe.atk-getDef());
    player.hp-=dmg;
    if(isDungeon){
        dungeonLog(`💥 ${foe.name} inflige ${dmg}`);
    } else {
        log(`💥 ${foe.name} inflige ${dmg}`);
    }
    if(player.hp<=0){
        if(isDungeon) dungeonLog('💀 Tu es mort ! Redémarrage...');
        else log('💀 Tu es mort ! Redémarrage...');
        setTimeout(restartGame,1500);
        return;
    }
    tickCooldown();
    updateUI();
    if(isDungeon) updateDungeonUI();
}
function potion(){
    if(player.potions<=0) return;
    player.potions--;
    const maxHpTotal = player.maxHp + getBonusHp();
    player.hp=Math.min(maxHpTotal,player.hp+getPotionHeal());
    log('🧪 Potion utilisée');
    updateUI();
}

// ===== COMBAT (DONJON) =====
function dungeonAttack(){
    if(player.hp<=0 || !dungeonEnemy) return;
    const dmg=Math.floor(Math.random()*4)+getAtk();
    dungeonEnemy.hp-=dmg;
    dungeonLog(`⚔️ Tu infliges ${dmg} dégâts à ${dungeonEnemy.name}`);
    applyLifesteal(dmg);
    companionStrike(dungeonEnemy);
    if(dungeonEnemy.hp<=0){winCombat(true);return;}
    enemyTurn(true);
}
function dungeonSkill(){
    if(player.skill.cooldown>0){dungeonLog('⏳ Compétence en recharge');return;}
    const dmg=Math.floor(getAtk()*player.skill.mult);
    dungeonEnemy.hp-=dmg;
    player.skill.cooldown=player.skill.maxCd;
    dungeonLog(`🔥 ${player.skill.name} inflige ${dmg} dégâts !`);
    applyLifesteal(dmg);
    companionStrike(dungeonEnemy);
    if(dungeonEnemy.hp<=0){winCombat(true);return;}
    enemyTurn(true);
}
function dungeonPotion(){
    if(player.potions<=0) return;
    player.potions--;
    const maxHpTotal = player.maxHp + getBonusHp();
    player.hp=Math.min(maxHpTotal,player.hp+getPotionHeal());
    dungeonLog('🧪 Potion utilisée');
    updateUI();
    updateDungeonUI();
}

// ===== PROGRESSION =====
function grantXP(amount){
    player.xp+=amount;
    while(player.xp >= player.level*XP_PER_LEVEL){
        player.xp -= player.level*XP_PER_LEVEL;
        player.level++;
        player.maxHp += 10;
        player.hp = player.maxHp;
        player.atk += 2;
        player.talentPoints += 1;
        log(`⭐ Niveau ${player.level} atteint ! +10 PV, +2 ATK, +1 point de talent`);
    }
}
function tickCooldown(){
    if(player.skill.cooldown>0) player.skill.cooldown--;
}

function grantGold(amount){
    player.gold += amount;
    const write = inDungeon ? dungeonLog : log;
    write(`💰 Tu gagnes ${amount} or`);
}

function spendGold(amount){
    if(player.gold < amount) return false;
    player.gold -= amount;
    return true;
}

function addReputation(faction, amount){
    if(!faction) return;
    if(factions[faction]===undefined) factions[faction]=0;
    const before = factions[faction];
    factions[faction] += amount;
    if(factions[faction] >= 25 && before < 25){
        log(`🏛️ Réputation ${faction} : Reconnue`);
        if(faction==='Arcanes'){player.potions += 1; log('🧪 Bonus Arcanes: +1 potion');}
    } else if(factions[faction] >= 50 && before < 50){
        log(`🏛️ Réputation ${faction} : Respectée`);
        if(faction==='Arcanes'){player.potions += 1; log('🧪 Bonus Arcanes: +1 potion');}
    }
}

function getFactionRank(rep){
    return rep>=50 ? 'Respectée' : rep>=25 ? 'Reconnue' : 'Inconnue';
}

function applyFactionPerks(){
    const repArc = factions.Arcanes || 0;
    const repExp = factions.Explorateurs || 0;
    const repCha = factions.Chasseurs || 0;
    const bonus = {
        hp: repExp>=50 ? 20 : repExp>=25 ? 10 : 0,
        atk: repCha>=50 ? 4 : repCha>=25 ? 2 : 0,
        potions: repArc>=50 ? 2 : repArc>=25 ? 1 : 0
    };
    bonus.label = `Factions: +${bonus.hp} PV, +${bonus.atk} ATK, +${bonus.potions} potions`;
    return bonus;
}

function renderFactions(){
    const m = document.getElementById('menu');
    m.innerHTML = `<h3>🏛️ Factions</h3>
        <div class="small">Bonus actifs: ${applyFactionPerks().label}</div>`;
    Object.keys(factions).forEach(name=>{
        const rep = factions[name];
        const rank = getFactionRank(rep);
        m.innerHTML += `<div class="small">${name}: ${rep} (${rank})</div>`;
    });
    m.innerHTML += `<div class="small">Les quêtes augmentent ta réputation.</div>`;
}

function triggerRandomEvent(source){
    const chance = source==='dungeon' ? 0.12 : 0.18;
    if(Math.random() > chance) return;
    const write = source==='dungeon' ? dungeonLog : log;
    const roll = Math.random();
    if(roll < 0.25){
        const g = 8 + Math.floor(Math.random()*12);
        player.gold += g;
        write(`✨ Événement: tu trouves une bourse (+${g} or)`);
    } else if(roll < 0.5){
        const heal = 8 + Math.floor(Math.random()*10);
        const maxHpTotal = player.maxHp + getBonusHp();
        player.hp = Math.min(maxHpTotal, player.hp + heal);
        write(`✨ Événement: source mystique (+${heal} PV)`);
    } else if(roll < 0.75){
        const loss = Math.min(player.gold, 6 + Math.floor(Math.random()*10));
        player.gold -= loss;
        write(`✨ Événement: pickpocket (-${loss} or)`);
    } else {
        const item = generateItem();
        addLoot(item);
        write(`✨ Événement: trésor trouvé (${item.name})`);
    }
}

function applyLifesteal(dmg){
    const weapon = player.equipment.weapon;
    const amulet = player.equipment.amulet;
    const effect = (weapon?.effect?.lifesteal || 0) + (amulet?.effect?.lifesteal || 0) + getArtifactLifesteal();
    if(effect>0){
        const heal = Math.max(1, Math.floor(dmg * effect));
        const maxHpTotal = player.maxHp + getBonusHp();
        player.hp = Math.min(maxHpTotal, player.hp + heal);
        if(inDungeon) dungeonLog(`🩸 Vol de vie: +${heal} PV`);
        else log(`🩸 Vol de vie: +${heal} PV`);
    }
}

function companionStrike(target){
    if(!player.companion || !target) return;
    const chance = 0.35;
    if(Math.random() > chance) return;
    const dmg = Math.max(1, Math.floor(player.companion.atk + player.level*0.5));
    target.hp -= dmg;
    if(inDungeon) dungeonLog(`🐾 ${player.companion.name} frappe (${dmg})`);
    else log(`🐾 ${player.companion.name} frappe (${dmg})`);
}

// ===== LOOT & WIN =====
function winCombat(isDungeon){
    const foe = isDungeon ? dungeonEnemy : enemy;
    const xpGain = Math.floor((12 + player.level*4 + (foe.type==='boss'?20:0)) * currentZone.rewardMult);
    grantXP(xpGain);
    const goldGain = Math.floor((6 + player.level*2 + (foe.type==='boss'?15:0)) * currentZone.rewardMult);
    grantGold(goldGain);
    if(isDungeon){
        dungeonLog(`✅ ${foe.name} vaincu ! +${xpGain} XP`);
    } else {
        log(`✅ ${foe.name} vaincu ! +${xpGain} XP`);
    }
    applyQuestProgress({kills:1, boss:foe.type==='boss', zoneId:currentZone.id});

    const dropChance = (isDungeon ? 0.88 : 0.7) + getLuckBonus() + getEventLootBonus() + getArtifactLoot();
    if(Math.random() < clamp(dropChance,0,0.99)){
        if(Math.random() < 0.6){
            const item = generateItem();
            addLoot(item);
            const msg = `🧰 Équipement: ${item.name} (${item.type})`;
            if(isDungeon) dungeonLog(msg); else log(msg);
        } else {
            const drop = generateDrop();
            addDrop(drop);
            const msg = `🎁 Drop: ${drop.name} x${drop.qty} [${drop.rarity}]`;
            if(isDungeon) dungeonLog(msg); else log(msg);
        }
    }

    if(isDungeon){
        dungeonEnemy = null;
        dungeonRoomCleared = true;
        if(inArena){
            dungeonLog('➡️ Vague nettoyée. Tu peux avancer.');
        } else {
            dungeonLog('➡️ Salle nettoyée. Tu peux avancer.');
        }
        updateDungeonUI();
    } else {
        enemy = initEnemy(player.level);
    }
    updateBestiary(foe.name, foe.type);
    if(foe.isZoneBoss) unlockAchievement('boss_hunter');
    if(foe.isZoneBoss && foe.artifact){
        player.defeatedBosses.push(foe.name);
        unlockArtifact(foe.artifact);
    }
    triggerRandomEvent(isDungeon ? 'dungeon' : 'world');
    updateUI();
    saveGame();
}

// ===== INVENTORY =====
let inventoryOpen=false;
let equipSort = 'power';
let classChosen=false;
let respawnBonus = {hp:0, atk:0, potions:0, label:''};
let settings = {music:70, sfx:80, animSpeed:1, floatTexts:true};
let factions = {Explorateurs:0, Arcanes:0, Chasseurs:0};
function toggleInventory(){
    inventoryOpen=!inventoryOpen;
    const m=document.getElementById('menu');
    if(!inventoryOpen){m.innerHTML='';return;}
    renderInventory();
}
function renderInventory(){
    const m=document.getElementById('menu');
    m.innerHTML='<h3>🎒 Inventaire (Drops)</h3>';
    const drops = player.inventory.drops;
    if(drops.length===0){
        m.innerHTML+='<div class="small">Aucun drop pour le moment.</div>';
        return;
    }
    drops.forEach(d=>{
        m.innerHTML+=`<button class="item-btn" style="color:${rarityColor(d.rarity)}">${d.name} x${d.qty} [${d.rarity}]</button>`;
    });
}

// ===== EQUIPMENT =====
let equipmentOpen=false;
function toggleEquipment(){
    equipmentOpen=!equipmentOpen;
    const m=document.getElementById('menu');
    if(!equipmentOpen){m.innerHTML='';return;}
    renderEquipment();
}
function renderEquipment(){
    const m = document.getElementById('menu');
    m.innerHTML = '<h3>⚙️ Équipement</h3>';
    m.innerHTML += `<button class="item-btn" onclick="autoEquip()">Auto-équiper (meilleur)</button>`;
    const slots = [
        {slot:'weapon', label:'🗡️ Arme'},
        {slot:'armor', label:'🛡️ Armure'},
        {slot:'helmet', label:'🪖 Casque'},
        {slot:'ring', label:'💍 Bague'},
        {slot:'amulet', label:'📿 Amulette'}
    ];
    slots.forEach(s=>{
        const item = player.equipment[s.slot];
        if(item){
            const stat = item.atk?`+${item.atk} ATK`:(item.def?`+${item.def} DEF`:`+${item.hp} PV`);
            m.innerHTML += `<button class="item-btn" style="color:${rarityColor(item.rarity)}" onclick="showEquipList('${s.slot}')">${s.label}: ${item.name} (${stat}) [${item.rarity}]</button>`;
        } else {
            m.innerHTML += `<button class="item-btn" onclick="showEquipList('${s.slot}')">${s.label}: Vide</button>`;
        }
    });
}
function showEquipList(slot){
    const m = document.getElementById('menu');
    const label =
        slot==='weapon' ? '🗡️ Arme' :
        slot==='armor' ? '🛡️ Armure' :
        slot==='helmet' ? '🪖 Casque' :
        slot==='ring' ? '💍 Bague' :
        '📿 Amulette';
    m.innerHTML = `<h3>⚙️ Équipement – ${label}</h3>
        <div class="small">Tri:</div>
        <button class="item-btn" onclick="setEquipSort('power','${slot}')">Puissance</button>
        <button class="item-btn" onclick="setEquipSort('rarity','${slot}')">Rareté</button>
        <button class="item-btn" onclick="setEquipSort('name','${slot}')">Nom</button>`;

    const list =
        slot==='weapon' ? player.inventory.weapons :
        slot==='armor' ? player.inventory.armors :
        slot==='helmet' ? player.inventory.helmets :
        slot==='ring' ? player.inventory.rings :
        player.inventory.amulets;

    const sorted = sortEquipList(list);
    if(sorted.length===0){
        m.innerHTML += '<div class="small">Aucun objet pour ce slot.</div>';
    } else {
        sorted.forEach(({it, i})=>{
            const stat = it.atk?`+${it.atk} ATK`:(it.def?`+${it.def} DEF`:`+${it.hp} PV`);
            const fn =
                slot==='weapon' ? `equipWeapon(${i})` :
                slot==='armor' ? `equipArmor(${i})` :
                slot==='helmet' ? `equipHelmet(${i})` :
                slot==='ring' ? `equipRing(${i})` :
                `equipAmulet(${i})`;
            m.innerHTML += `<button class="item-btn" style="color:${rarityColor(it.rarity)}" onclick="${fn}">${it.name} (${stat}) [${it.rarity}]</button>`;
        });
    }
    m.innerHTML += `<button class="item-btn" onclick="renderEquipment()">⬅️ Retour</button>`;
}
function renderCrafting(){
    const m = document.getElementById('menu');
    m.innerHTML = `<h3>🛠️ Artisanat</h3>
        <div class="small">Recettes disponibles</div>`;

    const canEquip = getDropQty('Essence néon')>=3 && getDropQty('Fragment cristallin')>=2;
    const canPotions = getDropQty('Poussière astrale')>=2 && getDropQty('Cendre arcanique')>=1;

    m.innerHTML += `<div class="small">Équipement aléatoire (3 Essence néon + 2 Fragment cristallin)</div>
        <button class="item-btn" ${canEquip?'':'disabled'} onclick="craftEquipment()">Fabriquer</button>`;
    m.innerHTML += `<div class="small">Potions x2 (2 Poussière astrale + 1 Cendre arcanique)</div>
        <button class="item-btn" ${canPotions?'':'disabled'} onclick="craftPotions()">Fabriquer</button>`;
}
function craftEquipment(){
    if(!spendDropByName('Essence néon',3)) return;
    if(!spendDropByName('Fragment cristallin',2)) return;
    const item = generateItem();
    addLoot(item);
    log(`🛠️ Artisanat: ${item.name} (${item.type})`);
    renderCrafting();
    saveGame();
}
function craftPotions(){
    if(!spendDropByName('Poussière astrale',2)) return;
    if(!spendDropByName('Cendre arcanique',1)) return;
    player.potions += 2;
    log('🛠️ Artisanat: +2 potions');
    updateUI();
    renderCrafting();
    saveGame();
}
function renderUpgrade(){
    const m = document.getElementById('menu');
    m.innerHTML = `<h3>⬆️ Amélioration</h3>
        <div class="small">Coût: 2 Essence néon + 1 Fragment cristallin</div>`;
    const can = getDropQty('Essence néon')>=2 && getDropQty('Fragment cristallin')>=1;
    const slots = [
        {slot:'weapon', label:'🗡️ Arme'},
        {slot:'armor', label:'🛡️ Armure'},
        {slot:'helmet', label:'🪖 Casque'},
        {slot:'ring', label:'💍 Bague'},
        {slot:'amulet', label:'📿 Amulette'}
    ];
    slots.forEach(s=>{
        const item = player.equipment[s.slot];
        if(!item) return;
        const stat = item.atk?`+${item.atk} ATK`:(item.def?`+${item.def} DEF`:`+${item.hp} PV`);
        m.innerHTML += `<button class="item-btn" ${can?'':'disabled'} onclick="upgradeItem('${s.slot}')">${s.label}: ${item.name} (${stat})</button>`;
    });
}
function upgradeItem(slot){
    if(!spendDropByName('Essence néon',2)) return;
    if(!spendDropByName('Fragment cristallin',1)) return;
    const item = player.equipment[slot];
    if(!item) return;
    if(slot==='amulet'){
        item.hp = (item.hp || 0) + 10;
    } else if(item.atk){
        item.atk += 1;
    } else if(item.def){
        item.def += 1;
    }
    log(`⬆️ Amélioration: ${item.name}`);
    updateUI();
    renderUpgrade();
    saveGame();
}
function renderConsumables(){
    const m = document.getElementById('menu');
    m.innerHTML = `<h3>🧪 Consommables</h3>`;
    const essence = getDropQty('Essence néon');
    const astral = getDropQty('Poussière astrale');
    if(essence===0 && astral===0){
        m.innerHTML += '<div class="small">Aucun consommable disponible.</div>';
        return;
    }
    if(essence>0){
        m.innerHTML += `<button class="item-btn" onclick="useDropHeal('Essence néon',10)">Essence néon (Soigne 10)</button>`;
    }
    if(astral>0){
        m.innerHTML += `<button class="item-btn" onclick="useDropHeal('Poussière astrale',15)">Poussière astrale (Soigne 15)</button>`;
    }
}

// ===== SPECIALISATIONS =====
const SPECIALIZATIONS = {
    Guerrier:[
        {name:'Berserker', atk:4, hp:0, skill:{name:'Rage sanglante', mult:2.4, maxCd:3}},
        {name:'Paladin', atk:2, hp:20, skill:{name:'Choc sacré', mult:2.2, maxCd:3}},
        {name:'Gardien', atk:1, hp:30, skill:{name:'Mur de fer', mult:2.0, maxCd:4}}
    ],
    Mage:[
        {name:'Pyromancien', atk:5, hp:0, skill:{name:'Explosion', mult:2.8, maxCd:3}},
        {name:'Arcaniste', atk:3, hp:10, skill:{name:'Rayon', mult:2.5, maxCd:3}},
        {name:'Chronomancien', atk:2, hp:15, skill:{name:'Faille', mult:2.3, maxCd:2}}
    ],
    Archer:[
        {name:'Sniper', atk:5, hp:0, skill:{name:'Tir perforant', mult:2.6, maxCd:3}},
        {name:'Éclaireur', atk:3, hp:10, skill:{name:'Flèche double', mult:2.2, maxCd:2}},
        {name:'Traqueur', atk:4, hp:5, skill:{name:'Lame d’ombre', mult:2.3, maxCd:3}}
    ]
};
function renderSpecialization(){
    const m = document.getElementById('menu');
    if(player.level < 10){
        m.innerHTML = `<h3>⚔️ Spécialisation</h3><div class="small">Disponible au niveau 10.</div>`;
        return;
    }
    if(player.specialization){
        m.innerHTML = `<h3>⚔️ Spécialisation</h3>
            <div class="small">Déjà choisi: ${player.specialization.name}</div>`;
        return;
    }
    const list = SPECIALIZATIONS[player.class] || [];
    m.innerHTML = `<h3>⚔️ Spécialisation</h3>`;
    list.forEach((s,i)=>{
        m.innerHTML += `<button class="item-btn" onclick="chooseSpecialization(${i})">${s.name} (+${s.atk} ATK, +${s.hp} PV)</button>`;
    });
}
function chooseSpecialization(i){
    if(player.specialization) return;
    const list = SPECIALIZATIONS[player.class] || [];
    const s = list[i];
    if(!s) return;
    player.specialization = s;
    player.skill.name = s.skill.name;
    player.skill.mult = s.skill.mult;
    player.skill.maxCd = s.skill.maxCd;
    log(`⚔️ Spécialisation choisie: ${s.name}`);
    updateUI();
    saveGame();
}

// ===== COMPANIONS =====
const COMPANIONS = [
    {name:'Loup cendré', atk:3, price:40},
    {name:'Faucon', atk:4, price:60},
    {name:'Golem de pierre', atk:5, price:80}
];
function renderCompanion(){
    const m = document.getElementById('menu');
    if(player.companion){
        m.innerHTML = `<h3>🐾 Compagnon</h3>
            <div class="small">Actuel: ${player.companion.name} (ATK ${player.companion.atk})</div>`;
        return;
    }
    m.innerHTML = `<h3>🐾 Compagnon</h3>`;
    COMPANIONS.forEach((c,i)=>{
        m.innerHTML += `<button class="item-btn" ${player.gold>=c.price?'':'disabled'} onclick="recruitCompanion(${i})">${c.name} — ${c.price} or</button>`;
    });
}
function recruitCompanion(i){
    const c = COMPANIONS[i];
    if(!c) return;
    if(!spendGold(c.price)) return;
    player.companion = {...c};
    log(`🐾 Compagnon recruté: ${c.name}`);
    updateUI();
    renderCompanion();
    saveGame();
}

// ===== FORGE =====
function renderForge(){
    const m = document.getElementById('menu');
    m.innerHTML = `<h3>⚒️ Forge</h3>
        <div class="small">Enchanter une pièce équipée (coût: 2 Fragment cristallin + 20 or)</div>`;
    const slots = [
        {slot:'weapon', label:'🗡️ Arme'},
        {slot:'armor', label:'🛡️ Armure'},
        {slot:'helmet', label:'🪖 Casque'},
        {slot:'ring', label:'💍 Bague'},
        {slot:'amulet', label:'📿 Amulette'}
    ];
    slots.forEach(s=>{
        const item = player.equipment[s.slot];
        if(!item) return;
        m.innerHTML += `<button class="item-btn" onclick="enchantItem('${s.slot}')">${s.label}: ${item.name}</button>`;
    });
}

// ===== ARTEFACTS =====
function renderArtifacts(){
    const m = document.getElementById('menu');
    const icons = {
        'Totem du Chef':'🗿',
        'Graine de Sylve':'🌿',
        'Cœur de Brume':'🌫️',
        'Couronne de Braise':'🔥',
        'Éclat polaire':'❄️',
        'Œil Astral':'🔮',
        'Cœur du Néant':'🕳️'
    };
    function artifactStats(a){
        const parts = [];
        if(a.atk) parts.push(`+${a.atk} ATK`);
        if(a.hp) parts.push(`+${a.hp} PV`);
        if(a.loot) parts.push(`+${Math.round(a.loot*100)}% loot`);
        if(a.lifesteal) parts.push(`+${Math.round(a.lifesteal*100)}% vol de vie`);
        return parts.length ? parts.join(', ') : 'Aucun bonus';
    }
    const all = []
        .concat(player.inventory.weapons, player.inventory.armors, player.inventory.helmets, player.inventory.rings, player.inventory.amulets)
        .filter(it=>it.rarity==='Légendaire');
    const equipped = Object.values(player.equipment).filter(it=>it && it.rarity==='Légendaire');
    m.innerHTML = `<h3>✨ Artefacts</h3>
        <div class="small">Équipés: ${equipped.length}</div>
        <div class="small">Inventaire: ${all.length}</div>
        <div class="small">Artefact unique: ${player.artifact ? player.artifact.name : 'Aucun'}</div>`;
    if(player.artifacts.length){
        m.innerHTML += `<div class="small">Artefacts uniques:</div>`;
        player.artifacts.forEach((a,i)=>{
            const icon = icons[a.name] || '✨';
            m.innerHTML += `<button class="item-btn" onclick="equipArtifact(${i})">${icon} Équiper ${a.name}</button>
                <div class="small">${a.desc || ''} ${artifactStats(a)}</div>`;
        });
    }
    if(equipped.length){
        m.innerHTML += `<div class="small">Équipés:</div>`;
        equipped.forEach(it=>{
            const stat = it.atk?`+${it.atk} ATK`:(it.def?`+${it.def} DEF`:`+${it.hp} PV`);
            m.innerHTML += `<div class="small">★ ${it.name} (${stat})</div>`;
        });
    }
    if(all.length){
        m.innerHTML += `<div class="small">Inventaire:</div>`;
        all.forEach(it=>{
            const stat = it.atk?`+${it.atk} ATK`:(it.def?`+${it.def} DEF`:`+${it.hp} PV`);
            m.innerHTML += `<div class="small">★ ${it.name} (${stat})</div>`;
        });
    }
    if(!equipped.length && !all.length){
        m.innerHTML += `<div class="small">Aucun artefact pour le moment.</div>`;
    }
}

function unlockArtifact(artifact){
    if(player.artifacts.find(a=>a.id===artifact.id)) return;
    player.artifacts.push(artifact);
    log(`🏺 Artefact obtenu: ${artifact.name}`);
}

function equipArtifact(i){
    const a = player.artifacts[i];
    if(!a) return;
    player.artifact = a;
    log(`✨ Artefact équipé: ${a.name}`);
    updateUI();
    renderArtifacts();
    saveGame();
}
function enchantItem(slot){
    if(!spendDropByName('Fragment cristallin',2)) return;
    if(!spendGold(20)) return;
    const item = player.equipment[slot];
    if(!item) return;
    if(slot==='amulet'){item.hp = (item.hp||0) + 6;}
    else if(item.atk){item.atk += 2;}
    else if(item.def){item.def += 2;}
    log(`⚒️ Enchantement: ${item.name}`);
    updateUI();
    renderForge();
    saveGame();
}
// ===== TALENTS =====
const TALENTS = {
    strength:{name:'Force', desc:'+1 ATK par point', max:10},
    vitality:{name:'Vitalité', desc:'+5 PV max par point', max:10},
    alchemy:{name:'Alchimie', desc:'+2 soin potion par point', max:10},
    luck:{name:'Chance', desc:'+2% loot par point', max:10}
};
function renderTalents(){
    const m = document.getElementById('menu');
    m.innerHTML = `<h3>✨ Talents</h3>
        <div class="small">Points disponibles: ${player.talentPoints}</div>`;
    Object.entries(TALENTS).forEach(([key, t])=>{
        const val = player.talents[key] || 0;
        const can = player.talentPoints > 0 && val < t.max;
        m.innerHTML += `
            <div class="small">${t.name}: ${val}/${t.max} — ${t.desc}</div>
            <button class="item-btn" ${can?'':'disabled'} onclick="upgradeTalent('${key}')">Améliorer</button>`;
    });
}
function upgradeTalent(key){
    if(player.talentPoints <= 0) return;
    const t = TALENTS[key];
    if(!t) return;
    if(player.talents[key] >= t.max) return;
    player.talentPoints--;
    player.talents[key] += 1;
    log(`✨ Talent amélioré: ${t.name}`);
    updateUI();
    renderTalents();
    saveGame();
}

// ===== PNJ =====
const NPCS = [
    {name:'Eira la Guide', line:'Les ruines cachent des secrets anciens.'},
    {name:'Brann le Forgeron', line:'Une bonne lame change le destin.'},
    {name:'Sélène l’Oracle', line:'Écoute les murmures du vent.'}
];
const FACTION_NPCS = {
    Explorateurs:{name:'Kael le Cartographe', line:'Les routes sûres valent de l’or.'},
    Arcanes:{name:'Lyra l’Alchimiste', line:'Chaque essence a un prix.'},
    Chasseurs:{name:'Doran le Traqueur', line:'Je lis les traces comme un livre.'}
};
function renderNPC(){
    const m = document.getElementById('menu');
    const npc = NPCS[Math.floor(Math.random()*NPCS.length)];
    const factionList = [
        {name:'Explorateurs', line:FACTION_NPCS.Explorateurs.line},
        {name:'Arcanes', line:FACTION_NPCS.Arcanes.line},
        {name:'Chasseurs', line:FACTION_NPCS.Chasseurs.line}
    ];
    m.innerHTML = `<h3>🧙 PNJ</h3>
        <div class="small"><b>${npc.name}:</b> ${npc.line}</div>
        <div class="small">Contacts de factions:</div>
        ${factionList.map(f=>`<div class="small"><b>${FACTION_NPCS[f.name].name}:</b> ${f.line}</div>`).join('')}
        <div class="small">Actions de factions:</div>
        ${factionList.map(f=>`<button class="item-btn" onclick="npcFaction('${f.name}')">${f.name}</button>`).join('')}
        <button class="item-btn" onclick="npcRumor()">Demander une rumeur</button>
        <button class="item-btn" onclick="npcHeal()">Bénédiction (10 or)</button>
        <button class="item-btn" onclick="npcQuest()">Nouvelle quête</button>`;
}
function npcRumor(){
    const hints = [
        'Les coffres des donjons sont plus généreux.',
        'La chance favorise les audacieux.',
        'Les Abysses réclament un grand niveau.'
    ];
    const hint = hints[Math.floor(Math.random()*hints.length)];
    log(`🗣️ Rumeur: ${hint}`);
}
function npcHeal(){
    if(!spendGold(10)) return;
    const maxHpTotal = player.maxHp + getBonusHp();
    player.hp = Math.min(maxHpTotal, player.hp + 20);
    log('✨ Bénédiction reçue (+20 PV)');
    updateUI();
    renderNPC();
    saveGame();
}
function npcQuest(){
    const i = Math.floor(Math.random()*quests.length);
    replaceQuestAt(i);
    log('📜 Une nouvelle quête t’a été donnée.');
    updateUI();
    renderNPC();
    saveGame();
}

function npcFaction(name){
    const rep = factions[name] || 0;
    const rank = getFactionRank(rep);
    log(`🏛️ ${name} — Réputation ${rank} (${rep})`);
    if(name==='Explorateurs' && rep>=25){
        log('🧭 Bonus: accès à cartes rares (loot +)');
    }
    if(name==='Arcanes' && rep>=25){
        log('🔮 Bonus: alchimie renforcée');
    }
    if(name==='Chasseurs' && rep>=25){
        log('🏹 Bonus: dégâts améliorés');
    }
}

// ===== SHOP =====
function renderShop(){
    const m = document.getElementById('menu');
    m.innerHTML = `<h3>🏪 Marchand</h3>
        <div class="small">Or: ${player.gold}</div>`;
    const potionPrice = 15;
    const equipPrice = 40;
    m.innerHTML += `<button class="item-btn" ${player.gold>=potionPrice?'':'disabled'} onclick="buyPotion()">Acheter potion (+1) — ${potionPrice} or</button>`;
    m.innerHTML += `<button class="item-btn" ${player.gold>=equipPrice?'':'disabled'} onclick="buyRandomEquip()">Acheter équipement aléatoire — ${equipPrice} or</button>`;
    m.innerHTML += `<button class="item-btn" onclick="buyLegendary()">Échange légendaire (10 Fragment cristallin)</button>`;
    if(player.inventory.drops.length===0){
        m.innerHTML += `<div class="small">Aucun drop à vendre.</div>`;
    } else {
        m.innerHTML += `<div class="small">Vendre des drops:</div>`;
        player.inventory.drops.forEach((d,i)=>{
            const value = d.rarity==='Commun' ? 3 : d.rarity==='Rare' ? 6 : 10;
            m.innerHTML += `<button class="item-btn" onclick="sellDrop(${i})">Vendre ${d.name} x${d.qty} [${d.rarity}] — ${value*d.qty} or</button>`;
        });
    }
}
function buyPotion(){
    if(!spendGold(15)) return;
    player.potions += 1;
    log('🧪 Potion achetée');
    updateUI();
    renderShop();
    saveGame();
}
function buyRandomEquip(){
    if(!spendGold(40)) return;
    const item = generateItem();
    addLoot(item);
    log(`🧰 Achat: ${item.name} (${item.type})`);
    updateUI();
    renderShop();
    saveGame();
}
function buyLegendary(){
    if(!spendDropByName('Fragment cristallin',10)) return;
    const item = generateItem();
    item.rarity = 'Légendaire';
    item.name = item.name.replace(/Commun|Rare|Épique|Légendaire/, 'Légendaire');
    item.effect = item.effect || {lifesteal:0.1};
    addLoot(item);
    log(`✨ Légendaire obtenu: ${item.name}`);
    updateUI();
    renderShop();
    saveGame();
}
function sellDrop(i){
    const d = player.inventory.drops[i];
    if(!d) return;
    const value = d.rarity==='Commun' ? 3 : d.rarity==='Rare' ? 6 : 10;
    const total = value * d.qty;
    player.inventory.drops.splice(i,1);
    player.gold += total;
    log(`💰 Vendu: ${d.name} x${d.qty} (+${total} or)`);
    updateUI();
    renderShop();
    saveGame();
}
function useDropHeal(name, amount){
    if(!spendDropByName(name,1)) return;
    const maxHpTotal = player.maxHp + getBonusHp();
    player.hp = Math.min(maxHpTotal, player.hp + amount);
    log(`🧪 ${name} utilisée (+${amount} PV)`);
    updateUI();
    renderConsumables();
    saveGame();
}
function setEquipSort(mode, slot){
    equipSort = mode;
    showEquipList(slot);
}
function rarityScore(r){
    return r==='Commun' ? 1 : r==='Rare' ? 2 : 3;
}
function sortEquipList(list){
    const mapped = list.map((it,i)=>({it,i}));
    if(equipSort==='name'){
        return mapped.sort((a,b)=>a.it.name.localeCompare(b.it.name));
    }
    if(equipSort==='rarity'){
        return mapped.sort((a,b)=>rarityScore(b.it.rarity)-rarityScore(a.it.rarity));
    }
    return mapped.sort((a,b)=>{
        const aVal = a.it.atk ?? a.it.def ?? a.it.hp ?? 0;
        const bVal = b.it.atk ?? b.it.def ?? b.it.hp ?? 0;
        return bVal - aVal;
    });
}

// ===== EQUIP FUNCTIONS =====
function equipWeapon(i){player.equipment.weapon = player.inventory.weapons[i]; log(`🗡️ Arme équipée : ${player.equipment.weapon.name}`); updateUI(); renderEquipment();}
function equipArmor(i){player.equipment.armor = player.inventory.armors[i]; log(`🛡️ Armure équipée : ${player.equipment.armor.name}`); updateUI(); renderEquipment();}
function equipHelmet(i){player.equipment.helmet = player.inventory.helmets[i]; log(`🪖 Casque équipé : ${player.equipment.helmet.name}`); updateUI(); renderEquipment();}
function equipRing(i){player.equipment.ring = player.inventory.rings[i]; log(`💍 Bague équipée : ${player.equipment.ring.name}`); updateUI(); renderEquipment();}
function equipAmulet(i){player.equipment.amulet = player.inventory.amulets[i]; log(`📿 Amulette équipée : ${player.equipment.amulet.name}`); updateUI(); renderEquipment();}

function autoEquip(){
    const best = {
        weapon: pickBest(player.inventory.weapons, 'weapon'),
        armor: pickBest(player.inventory.armors, 'armor'),
        helmet: pickBest(player.inventory.helmets, 'helmet'),
        ring: pickBest(player.inventory.rings, 'ring'),
        amulet: pickBest(player.inventory.amulets, 'amulet')
    };
    let changed = false;
    Object.keys(best).forEach(slot=>{
        if(best[slot]){
            player.equipment[slot] = best[slot];
            changed = true;
        }
    });
    if(changed){
        log('⚙️ Auto-équipement effectué.');
        updateUI();
        renderEquipment();
        saveGame();
    } else {
        log('⚙️ Aucun équipement à auto-équiper.');
    }
}

function pickBest(list, slot){
    if(!list || list.length===0) return null;
    return list.reduce((best, it)=>{
        if(!best) return it;
        return scoreItem(it, slot) > scoreItem(best, slot) ? it : best;
    }, null);
}

function scoreItem(it, slot){
    const base = it.atk ?? it.def ?? it.hp ?? 0;
    const rarity = it.rarity==='Commun' ? 1 : it.rarity==='Rare' ? 2 : it.rarity==='Épique' ? 3 : 4;
    const effect = it.effect ? 2 : 0;
    const slotBias = slot==='weapon' ? 1.2 : slot==='amulet' ? 1.05 : 1;
    return base * slotBias + rarity + effect;
}

// ===== STATS =====
let statsOpen=false;
function showStats(){
    if(!classChosen){return;}
    statsOpen=!statsOpen;
    const m=document.getElementById('menu');
    if(!statsOpen){m.innerHTML='';return;}
    const hpPercent=player.hp/player.maxHp*100;
    const xpPercent=player.xp/(player.level*XP_PER_LEVEL)*100;
    m.innerHTML=`<div class="stats-menu">
        <h3>👤 ${player.class} – Niveau ${player.level}</h3>
        <div>PV: ${player.hp}/${player.maxHp}</div>
        <div class="bar-container"><div class="bar hp" style="width:${hpPercent}%"></div></div>
        <div>XP: ${player.xp}/${player.level*XP_PER_LEVEL}</div>
        <div class="bar-container"><div class="bar xp" style="width:${xpPercent}%"></div></div>
        <div>ATK: ${getAtk()}</div>
        <div>DEF: ${getDef()}</div>
        <div>Potions: ${player.potions}</div>
        <div>Classe: ${player.class}</div>
        <div>Spécialisation: ${player.specialization?player.specialization.name:'Aucune'}</div>
        <div>Compagnon: ${player.companion?player.companion.name:'Aucun'}</div>
        <div>Quêtes actives: ${quests.length}</div>
        ${quests[0] ? `<div>Quête principale: ${quests[0].name}</div>` : ''}
        ${respawnBonus.label ? `<div class="small">Bonus de retour: ${respawnBonus.label}</div>` : ''}
        </div>`;
}

// ===== ACTIONS =====
document.getElementById('actions').innerHTML=
`<button class="primary-action" onclick="attack()">Attaquer</button>
 <button class="primary-action" onclick="useSkill()">Compétence</button>
 <button class="primary-action" onclick="potion()">Potion</button>
 <button onclick="toggleInventory()">Inventaire</button>
 <button onclick="toggleEquipment()">Équipement</button>
 <button onclick="showStats()">Stats</button>
 <button onclick="toggleSecondary()">Menu+</button>`;

document.getElementById('secondaryActions').innerHTML=
`<div class="action-label">Exploration</div>
 <button onclick="fightZoneBoss()">Boss de zone</button>
 <button onclick="startArena()">Arène</button>
 <button onclick="renderQuestMenu()">Quêtes</button>
 <div class="action-label">Personnage</div>
 <button onclick="renderTalents()">Talents</button>
 <button onclick="renderSpecialization()">Spécialisation</button>
 <button onclick="renderCompanion()">Compagnon</button>
 <button onclick="renderArtifacts()">Artefacts</button>
 <div class="action-label">Services</div>
 <button onclick="renderShop()">Marchand</button>
 <button onclick="renderForge()">Forge</button>
 <button onclick="renderCrafting()">Artisanat</button>
 <button onclick="renderUpgrade()">Amélioration</button>
 <button onclick="renderConsumables()">Consommables</button>
 <div class="action-label">Social</div>
 <button onclick="renderNPC()">PNJ</button>
 <button onclick="renderFactions()">Factions</button>
 <button onclick="renderBestiary()">Bestiaire</button>
 <button onclick="renderAchievements()">Succès</button>`;

document.getElementById('dungeonActions').innerHTML=
`<button onclick="dungeonAttack()">Attaquer</button>
 <button onclick="dungeonSkill()">Compétence</button>
 <button onclick="dungeonPotion()">Potion</button>
 <button onclick="solvePuzzle()">Énigme</button>
 <button onclick="disarmTrap()">Désamorcer</button>
 <button onclick="nextRoom()">Salle suivante</button>
 <button onclick="exitDungeon()">Quitter</button>`;

function setActionsEnabled(enabled){
    const actions = document.getElementById('actions');
    const dungeonActions = document.getElementById('dungeonActions');
    const secondary = document.getElementById('secondaryActions');
    if(actions) actions.style.display = enabled ? '' : 'none';
    if(dungeonActions) dungeonActions.style.display = enabled ? '' : 'none';
    if(secondary){
        secondary.style.display = enabled ? 'none' : 'none';
        secondary.classList.remove('show');
    }
    const dungeonBtn = document.querySelector('button[onclick="enterDungeon()"]');
    if(dungeonBtn) dungeonBtn.style.display = enabled ? '' : 'none';
}

function toggleSecondary(){
    const s = document.getElementById('secondaryActions');
    if(!s) return;
    const show = s.classList.toggle('show');
    s.style.display = show ? 'flex' : 'none';
}

// ===== DONJON =====
function buildDungeon(){
    const rooms = [];
    const pool = ['combat','combat','combat','chest','trap','puzzle','shrine','merchant'];
    rooms.push({type:pool[Math.floor(Math.random()*pool.length)]});
    rooms.push({type:pool[Math.floor(Math.random()*pool.length)]});
    rooms.push({type:'chest'});
    rooms.push({type:pool[Math.floor(Math.random()*pool.length)]});
    rooms.push({type:'boss'});
    dungeon = {level:player.level, rooms, current:0};
}
function enterDungeon(){
    if(!classChosen){return;}
    inArena = false;
    inDungeon = true;
    buildDungeon();
    document.getElementById('game').style.display='none';
    document.getElementById('dungeonUI').style.display='block';
    document.getElementById('dungeonLog').innerHTML='';
    dungeonLog('🏰 Tu entres dans le donjon.');
    loadRoom();
}
function loadRoom(){
    const room = dungeon.rooms[dungeon.current];
    dungeonRoomCleared = false;
    dungeonRoomType = room.type;
    if(room.type==='combat'){
        dungeonEnemy = initEnemy(dungeon.level, 'normal');
        dungeonLog(`👹 Un ${dungeonEnemy.name} apparaît !`);
    } else if(room.type==='boss'){
        dungeonEnemy = initEnemy(dungeon.level, 'boss');
        dungeonLog(`🔥 Boss: ${dungeonEnemy.name} te défie !`);
    } else {
        dungeonEnemy = null;
        if(room.type==='chest'){
            dungeonLog('🎁 Tu trouves un coffre...');
            const drop = generateDrop();
            addDrop(drop);
            applyQuestProgress({chests:1});
            dungeonLog(`🎁 Drop: ${drop.name} x${drop.qty} [${drop.rarity}]`);
            dungeonRoomCleared = true;
        } else if(room.type==='trap'){
            dungeonLog('⚠️ Piège! Tente de désamorcer.');
        } else if(room.type==='puzzle'){
            dungeonLog('🧩 Une énigme bloque le passage.');
        } else if(room.type==='shrine'){
            dungeonLog('✨ Sanctuaire: tu te sens plus fort.');
            const heal = 12 + player.level*2;
            player.hp = Math.min(player.maxHp + getBonusHp(), player.hp + heal);
            grantGold(5);
            dungeonRoomCleared = true;
        } else if(room.type==='merchant'){
            dungeonLog('🏪 Un marchand itinérant apparaît.');
            renderShop();
            dungeonRoomCleared = true;
        }
    }
    updateDungeonUI();
    updateUI();
    saveGame();
}

function solvePuzzle(){
    if(dungeonRoomType!=='puzzle') return;
    const success = Math.random() < 0.7;
    if(success){
        dungeonLog('✅ Énigme résolue !');
        grantXP(10);
        dungeonRoomCleared = true;
    } else {
        dungeonLog('❌ Échec... le passage reste bloqué.');
    }
    updateDungeonUI();
    updateUI();
}

function disarmTrap(){
    if(dungeonRoomType!=='trap') return;
    const success = Math.random() < 0.65;
    if(success){
        dungeonLog('✅ Piège désamorcé.');
        const drop = generateDrop();
        addDrop(drop);
        dungeonLog(`🎁 Drop: ${drop.name} x${drop.qty} [${drop.rarity}]`);
        dungeonRoomCleared = true;
    } else {
        dungeonLog('💥 Piège déclenché !');
        player.hp -= Math.max(5, Math.floor(player.level*2));
        if(player.hp<=0){
            dungeonLog('💀 Tu es mort ! Redémarrage...');
            setTimeout(restartGame,1500);
        }
    }
    updateDungeonUI();
    updateUI();
}
function nextRoom(){
    if(!dungeonRoomCleared){
        dungeonLog('⛔ Termine cette salle avant d’avancer.');
        return;
    }
    if(inArena){
        arenaWave++;
        if(arenaWave > 5){
            dungeonLog('🏆 Arène terminée ! Récompense bonus.');
            grantXP(80);
            grantGold(80);
            unlockAchievement('arena_win');
            exitDungeon();
            return;
        }
        dungeonLog(`⚔️ Vague ${arenaWave}`);
        dungeonEnemy = initEnemy(player.level + arenaWave, 'normal');
        dungeonRoomCleared = false;
        updateDungeonUI();
        return;
    }
    if(dungeon.current >= dungeon.rooms.length-1){
        dungeonLog('🏆 Donjon terminé !');
        grantXP(Math.floor((30 + dungeon.level*10) * currentZone.rewardMult));
        exitDungeon();
        return;
    }
    dungeon.current++;
    loadRoom();
}
function exitDungeon(){
    inDungeon = false;
    inArena = false;
    document.getElementById('game').style.display='block';
    document.getElementById('dungeonUI').style.display='none';
    updateUI();
}

// ===== ARENA =====
function startArena(){
    if(!classChosen) return;
    inArena = true;
    arenaWave = 1;
    document.getElementById('game').style.display='none';
    document.getElementById('dungeonUI').style.display='block';
    document.getElementById('dungeonLog').innerHTML='';
    dungeonLog('🏟️ Arène: survive aux vagues !');
    dungeonEnemy = initEnemy(player.level + arenaWave, 'normal');
    updateDungeonUI();
    updateUI();
}

// ===== INIT CLASS CHOICE =====
function chooseClass(){
    const classes = [
        {name:'Guerrier', hp:60, atk:8, def:3, skill:{name:'Coup puissant', mult:2, cooldown:0, maxCd:3}},
        {name:'Mage', hp:40, atk:12, def:1, skill:{name:'Boule de feu', mult:2.5, cooldown:0, maxCd:3}},
        {name:'Archer', hp:50, atk:10, def:2, skill:{name:'Tir rapide', mult:1.8, cooldown:0, maxCd:2}}
    ];
    const classScreen = document.getElementById('classScreen');
    const cards = classes.map((c,i)=>{
        const role = c.name==='Guerrier' ? 'Tank brutal' : c.name==='Mage' ? 'Dégâts magiques' : 'DPS mobile';
        const desc = c.name==='Guerrier'
            ? 'Encaisse fort et frappe au corps à corps.'
            : c.name==='Mage'
            ? 'Gros dégâts à distance, fragile.'
            : 'Rapide et précis, bon équilibre.';
        return `
        <div class="class-card">
            <div class="class-tag">${role}</div>
            <h3 class="class-name">${c.name}</h3>
            <p class="class-desc">${desc}</p>
            <div class="class-stats">
                <span>PV ${c.hp}</span>
                <span>ATK ${c.atk}</span>
                <span>DEF ${c.def}</span>
            </div>
            <button class="class-pick" onclick="setClass(${i})">Choisir ${c.name}</button>
        </div>`;
    }).join('');
    classScreen.innerHTML = `
        <div class="class-modal">
            <h2 class="class-title">Choisis ta classe</h2>
            <p class="class-sub">Ton destin se scelle ici. Tu pourras changer plus tard, mais commence fort.</p>
            <div class="class-grid">${cards}</div>
        </div>`;
    classScreen.style.display = 'flex';
    requestAnimationFrame(()=>classScreen.classList.add('show'));
    document.getElementById('questBoard').style.display = 'none';
    document.getElementById('game').style.display = 'none';
    document.getElementById('dungeonUI').style.display = 'none';
    setActionsEnabled(false);
}
function renderZoneMap(){
    const map = document.getElementById('zoneMap');
    if(!map) return;
    map.innerHTML = zones.map(z=>{
        const locked = player.level < z.reqLevel;
        const active = z.id===currentZone.id ? 'active' : '';
        const defeated = z.boss && player.defeatedBosses.includes(z.boss.name);
        const mark = defeated ? ' ✅' : '';
        const label = locked ? `${z.name} (Nv ${z.reqLevel})${mark}` : `${z.name} (★${z.diff})${mark}`;
        const sub = locked ? `Progression ${Math.min(player.level, z.reqLevel)}/${z.reqLevel}` : `Récompenses x${z.rewardMult}`;
        const pct = locked ? Math.min(100, Math.floor((player.level / z.reqLevel) * 100)) : 100;
        return `<button class="zone ${active} ${locked?'locked':''}" ${locked?'disabled':''} onclick="selectZone('${z.id}')">
            <div>${label}</div>
            <div class="sub">${sub}</div>
            <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
        </button>`;
    }).join('');
}
function selectZone(id){
    const z = zones.find(x=>x.id===id);
    if(!z) return;
    if(player.level < z.reqLevel) return;
    currentZone = z;
    enemy = initEnemy(player.level);
    updateUI();
    saveGame();
}

function fightZoneBoss(){
    if(player.level < currentZone.reqLevel) return;
    const b = currentZone.boss;
    if(!b) return;
    if(player.defeatedBosses.includes(b.name)){
        log(`👑 Boss de zone déjà vaincu: ${b.name}.`);
        return;
    }
    enemy = {
        name: b.name,
        hp: Math.floor((b.hp + player.level*6) * (1 + currentZone.diff*0.05)),
        maxHp: Math.floor((b.hp + player.level*6) * (1 + currentZone.diff*0.05)),
        atk: Math.floor((b.atk + player.level*2) * (1 + currentZone.diff*0.05)),
        type:'boss',
        affix:{name:'Légendaire', hp:1, atk:1},
        isZoneBoss:true,
        lore: b.lore || '',
        artifact: b.artifact || null
    };
    log(`👑 Boss de zone: ${b.name} apparaît ! ${b.lore?`— ${b.lore}`:''}`);
    updateUI();
}
function setClass(i){
    const classes = [
        {name:'Guerrier', hp:60, atk:8, def:3, skill:{name:'Coup puissant', mult:2, cooldown:0, maxCd:3}},
        {name:'Mage', hp:40, atk:12, def:1, skill:{name:'Boule de feu', mult:2.5, cooldown:0, maxCd:3}},
        {name:'Archer', hp:50, atk:10, def:2, skill:{name:'Tir rapide', mult:1.8, cooldown:0, maxCd:2}}
    ];
    const c = classes[i];
    player.class = c.name;
    player.hp = c.hp; player.maxHp = c.hp; player.atk = c.atk;
    player.equipment = {weapon:null, armor:null, helmet:null, ring:null, amulet:null};
    player.skill = {...c.skill};
    player.inventory = {weapons:[], armors:[], helmets:[], rings:[], amulets:[], drops:[]};
    const classScreen = document.getElementById('classScreen');
    classScreen.classList.remove('show');
    classScreen.style.display = 'none';
    classScreen.innerHTML = '';
    document.getElementById('questBoard').style.display = '';
    document.getElementById('game').style.display = '';
    classChosen = true;
    setActionsEnabled(true);
    updateUI();
    saveGame();
}

function showStartMenu(){
    const startScreen = document.getElementById('startScreen');
    const lastSave = getLastSaveInfo();
    const loadLabel = lastSave ? `Charger une partie (${lastSave})` : 'Charger une partie';
    const loadDisabled = lastSave ? '' : 'disabled';
    startScreen.innerHTML = `
        <div class="start-modal">
            <h2 class="start-title">Donjon & Quêtes</h2>
            <p class="start-sub">Choisis ton destin et pars à l’aventure.</p>
            <div class="start-actions">
                <button class="start-btn" onclick="startNewGame()">Nouvelle partie</button>
                <button class="start-btn secondary" ${loadDisabled} onclick="loadGame()">${loadLabel}</button>
                <button class="start-btn secondary" onclick="openOptions()">Options</button>
            </div>
            ${lastSave ? `<div class="start-save">Dernière sauvegarde : ${lastSave}</div>` : ''}
            <div class="start-hint">Conseil : commence par une classe adaptée à ton style.</div>
        </div>`;
    startScreen.style.display = 'flex';
    document.getElementById('questBoard').style.display = 'none';
    document.getElementById('game').style.display = 'none';
    document.getElementById('dungeonUI').style.display = 'none';
    setActionsEnabled(false);
    requestAnimationFrame(()=>startScreen.classList.add('show'));
}

function startNewGame(){
    const startScreen = document.getElementById('startScreen');
    startScreen.classList.remove('show');
    startScreen.style.display = 'none';
    startScreen.innerHTML = '';
    resetNewGame();
    chooseClass();
}

function loadGame(){
    const raw = localStorage.getItem('rpgSave');
    if(!raw){
        alert('Aucune sauvegarde trouvée.');
        return;
    }
    const data = JSON.parse(raw);
    player = data.player;
    if(!player.talents) player.talents = {strength:0, vitality:0, alchemy:0, luck:0};
    if(typeof player.gold!=='number') player.gold = 0;
    if(typeof player.talentPoints!=='number') player.talentPoints = 0;
    if(!('specialization' in player)) player.specialization = null;
    if(!('companion' in player)) player.companion = null;
    if(!('artifact' in player)) player.artifact = null;
    if(!('artifacts' in player)) player.artifacts = [];
    if(!('defeatedBosses' in player)) player.defeatedBosses = [];
    questLevel = data.questLevel || 1;
    if(Array.isArray(data.quests)){
        quests = data.quests;
    } else if(data.currentQuest){
        quests = [data.currentQuest];
    } else {
        initQuests(3);
    }
    quests.forEach(q=>{
        if(!q.reward) q.reward = {xp:0, gold:0, loot:false};
        if(!q.reward.gold) q.reward.gold = 0;
        if(q.progress && q.progress.drop===undefined) q.progress.drop = 0;
        if(q.progress && q.progress.zoneKills===undefined) q.progress.zoneKills = 0;
        if(q.objective && q.objective.zoneId && !q.objective.zoneName){
            const z = zones.find(x=>x.id===q.objective.zoneId);
            q.objective.zoneName = z ? z.name : '';
        }
        if(!q.faction) q.faction = 'Explorateurs';
    });
    factions = data.factions || {Explorateurs:0, Arcanes:0, Chasseurs:0};
    dailyQuest = data.dailyQuest || dailyQuest;
    weeklyQuest = data.weeklyQuest || weeklyQuest;
    bestiary = data.bestiary || {};
    achievements = data.achievements || {};
    initDailyWeekly();
    currentZone = zones.find(z=>z.id===data.currentZoneId) || zones[0];
    classChosen = data.classChosen;
    respawnBonus = data.respawnBonus || {hp:0, atk:0, potions:0, label:''};
    if(classChosen){
        const startScreen = document.getElementById('startScreen');
        startScreen.classList.remove('show');
        startScreen.style.display = 'none';
        startScreen.innerHTML = '';
        document.getElementById('questBoard').style.display = '';
        document.getElementById('game').style.display = '';
        setActionsEnabled(true);
        enemy = initEnemy(player.level);
        updateUI();
    } else {
        const startScreen = document.getElementById('startScreen');
        startScreen.classList.remove('show');
        startScreen.style.display = 'none';
        startScreen.innerHTML = '';
        chooseClass();
    }
}

function resetNewGame(){
    classChosen = false;
    respawnBonus = {hp:0, atk:0, potions:0, label:''};
    factions = {Explorateurs:0, Arcanes:0, Chasseurs:0};
    player = {
        hp:50, maxHp:50, atk:8, level:1, xp:0, potions:3, gold:0, talentPoints:0,
        talents:{strength:0, vitality:0, alchemy:0, luck:0},
        skill:{name:'Coup puissant', mult:2, cooldown:0, maxCd:3},
        equipment:{weapon:null, armor:null, helmet:null, ring:null, amulet:null},
        inventory:{weapons:[], armors:[], helmets:[], rings:[], amulets:[], drops:[]},
        class:null,
        specialization:null,
        companion:null,
        artifact:null,
        artifacts:[],
        defeatedBosses:[]
    };
    questLevel = 1;
    initQuests(3);
    currentZone = zones[0];
    enemy = initEnemy(1);
    dungeon = {level:1, rooms:[], current:0};
    inDungeon = false;
    inArena = false;
    arenaWave = 0;
    dungeonEnemy = null;
    dungeonRoomCleared = false;
    dailyQuest = null;
    weeklyQuest = null;
    bestiary = {};
    achievements = {};
    initSeasonalEvent();
    initDailyWeekly();
    saveGame();
}

function openOptions(){
    const optionsScreen = document.getElementById('optionsScreen');
    optionsScreen.innerHTML = `
        <div class="options-modal">
            <h2 class="options-title">Options</h2>
            <div class="options-grid">
                <div class="opt-row">
                    <label>Musique</label>
                    <input id="optMusic" type="range" min="0" max="100" value="${settings.music}">
                </div>
                <div class="opt-row">
                    <label>SFX</label>
                    <input id="optSfx" type="range" min="0" max="100" value="${settings.sfx}">
                </div>
                <div class="opt-row">
                    <label>Vitesse des animations</label>
                    <select id="optAnim">
                        <option value="0.8">Rapide</option>
                        <option value="1">Normal</option>
                        <option value="1.3">Lent</option>
                    </select>
                </div>
                <div class="opt-row">
                    <label>Textes flottants</label>
                    <select id="optFloat">
                        <option value="1">Activés</option>
                        <option value="0">Désactivés</option>
                    </select>
                </div>
            </div>
            <div class="opt-actions">
                <button class="opt-btn" onclick="saveOptions()">Sauvegarder</button>
                <button class="opt-btn secondary" onclick="closeOptions()">Retour</button>
            </div>
        </div>`;
    optionsScreen.style.display = 'flex';
    requestAnimationFrame(()=>optionsScreen.classList.add('show'));
    document.getElementById('optAnim').value = String(settings.animSpeed);
    document.getElementById('optFloat').value = settings.floatTexts ? '1' : '0';
}

// ===== EVENTS (SAISON + DAILY/WEEKLY) =====
function initSeasonalEvent(){
    const month = new Date().getMonth();
    const events = [
        {name:'Hiver Ancien', desc:'+5% loot', bonus:{loot:0.05}},
        {name:'Saison des Cendres', desc:'+2 ATK', bonus:{atk:2}},
        {name:'Équinoxe Arcanique', desc:'+1 potion au départ', bonus:{potions:1}}
    ];
    seasonalEvent = events[month % events.length];
    const banner = document.getElementById('eventBanner');
    banner.style.display = 'block';
    banner.textContent = `Événement: ${seasonalEvent.name} — ${seasonalEvent.desc}`;
    if(seasonalEvent.bonus?.potions){
        player.potions += seasonalEvent.bonus.potions;
    }
}

function initDailyWeekly(){
    const today = new Date().toDateString();
    const weekKey = `${new Date().getFullYear()}-W${Math.ceil((new Date().getDate())/7)}`;
    if(!dailyQuest || dailyQuest.key !== today){
        dailyQuest = {key:today, quest:generateQuest(1), claimed:false};
    }
    if(!weeklyQuest || weeklyQuest.key !== weekKey){
        weeklyQuest = {key:weekKey, quest:generateQuest(3), claimed:false};
    }
}

function closeOptions(){
    const optionsScreen = document.getElementById('optionsScreen');
    optionsScreen.classList.remove('show');
    optionsScreen.style.display = 'none';
    optionsScreen.innerHTML = '';
}

function saveOptions(){
    settings.music = Number(document.getElementById('optMusic').value);
    settings.sfx = Number(document.getElementById('optSfx').value);
    settings.animSpeed = Number(document.getElementById('optAnim').value);
    settings.floatTexts = document.getElementById('optFloat').value === '1';
    localStorage.setItem('rpgSettings', JSON.stringify(settings));
    applySettings();
    closeOptions();
}

function applySettings(){
    document.documentElement.style.setProperty('--anim-speed', settings.animSpeed);
}

function loadSettings(){
    const raw = localStorage.getItem('rpgSettings');
    if(raw){
        settings = {...settings, ...JSON.parse(raw)};
    }
    applySettings();
}

function saveGame(){
    const payload = {
        player,
        questLevel,
        quests,
        factions,
        dailyQuest,
        weeklyQuest,
        bestiary,
        achievements,
        currentZoneId: currentZone.id,
        classChosen,
        respawnBonus,
        savedAt: Date.now()
    };
    localStorage.setItem('rpgSave', JSON.stringify(payload));
}

function getLastSaveInfo(){
    const raw = localStorage.getItem('rpgSave');
    if(!raw) return '';
    try{
        const data = JSON.parse(raw);
        if(!data.savedAt) return '';
        const d = new Date(data.savedAt);
        const date = d.toLocaleDateString('fr-FR');
        const time = d.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
        return `${date} ${time}`;
    } catch(e){
        return '';
    }
}

function computeRespawnBonus(){
    const zoneBonus = Math.max(0, currentZone.diff - 1) * 4;
    const levelBonus = Math.max(0, player.level - 1) * 2;
    const questBonus = Math.max(0, questLevel - 1) * 3;
    const score = zoneBonus + levelBonus + questBonus;
    const bonus = {
        hp: Math.floor(score * 2),
        atk: Math.floor(score / 4),
        potions: Math.floor(score / 10)
    };
    bonus.label = `+${bonus.hp} PV, +${bonus.atk} ATK, +${bonus.potions} potions`;
    return bonus;
}

function fullResetWithBonus(){
    if(!classChosen) return;
    respawnBonus = computeRespawnBonus();
    const classBase =
        player.class==='Guerrier' ? {hp:60, atk:8} :
        player.class==='Mage' ? {hp:40, atk:12} :
        {hp:50, atk:10};
    player.level = 1;
    player.xp = 0;
    player.maxHp = classBase.hp + respawnBonus.hp;
    player.hp = player.maxHp;
    player.atk = classBase.atk + respawnBonus.atk;
    player.potions = RESPAWN_BASE_POTIONS + respawnBonus.potions;
    player.gold = 0;
    player.talentPoints = 0;
    player.talents = {strength:0, vitality:0, alchemy:0, luck:0};
    player.specialization = null;
    player.companion = null;
    player.artifact = null;
    player.artifacts = [];
    player.defeatedBosses = [];
    factions = {Explorateurs:0, Arcanes:0, Chasseurs:0};
    player.equipment = {weapon:null, armor:null, helmet:null, ring:null, amulet:null};
    player.inventory = {weapons:[], armors:[], helmets:[], rings:[], amulets:[], drops:[]};
    player.skill.cooldown = 0;
    questLevel = 1;
    initQuests(3);
    currentZone = zones[0];
    enemy = initEnemy(player.level);
}

// ===== RESTART =====
function restartGame(){
    if(!classChosen){return;}
    fullResetWithBonus();
    if(inDungeon) exitDungeon();
    updateUI();
    saveGame();
}

// ===== INIT =====
renderZoneMap();
initQuests(3);
updateUI();
loadSettings();
initSeasonalEvent();
initDailyWeekly();
showStartMenu();
</script>
</body>
</html>
