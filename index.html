<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plaine – Donjon & Quêtes</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Space+Grotesk:wght@400;500;600&display=swap');
:root{
  --neo-bg-1:#181226;
  --neo-bg-2:#120d1a;
  --neo-ink:#f7f3ff;
  --neo-muted:#cfc8dc;
  --neo-border:rgba(127,0,255,0.28);
  --neo-a:#ff3b7f;
  --neo-b:#7f00ff;
  --neo-c:#00ffd5;
  --neo-shadow:0 10px 22px rgba(0,0,0,0.5);
}
body{margin:0;background:radial-gradient(1200px 600px at 15% 10%,rgba(127,0,255,0.25),transparent 60%),radial-gradient(900px 600px at 85% 20%,rgba(0,255,213,0.2),transparent 60%),#08060d;color:#eee;font-family:"Space Grotesk", sans-serif;display:flex;justify-content:center;align-items:flex-start;padding:20px;gap:20px}
#questBoard{width:260px;position:sticky;top:20px;display:block}
#mapBoard{width:260px;position:sticky;top:20px;display:block}
#mobilePanels{display:none;width:100%;gap:10px;justify-content:center}
#mobilePanels button{padding:10px 12px;font-size:13px;border-radius:12px;background:linear-gradient(180deg,#181226,#120d1a);border:1px solid rgba(127,0,255,0.25);box-shadow:0 10px 20px rgba(0,0,0,0.5);color:#f5f2ff}
#mobilePanels button.active{background:linear-gradient(90deg,var(--neo-c),var(--neo-b));border:none;color:#0b0b12}
#mobilePanels .panel-btn{border:none;color:#0b0b12}
#mobilePanels .panel-btn.map{background:linear-gradient(90deg,var(--neo-b),var(--neo-c))}
#mobilePanels .panel-btn.quest{background:linear-gradient(90deg,var(--neo-c),#5b8dff)}
#mobilePanels .panel-btn.back{background:linear-gradient(180deg,#1b1524,#120d18);border:1px solid rgba(255,255,255,0.08);color:#f5f2ff}
#mobilePanels .panel-btn.back{background:#1b1524;color:#f5f2ff;border:1px solid #2e243a}
#questPanel{padding:20px;background:rgba(12,12,12,0.95);border-radius:16px;box-shadow:0 0 25px #00ffd5;position:relative;overflow:hidden}
#mapPanel{margin-top:0;padding:20px;background:rgba(18,8,24,0.95);border-radius:16px;box-shadow:0 0 25px #7f00ff;position:relative;overflow:hidden}
#questPanel::before,#mapPanel::before{content:"";position:absolute;inset:-2px;border-radius:18px;pointer-events:none;background:conic-gradient(from 180deg,#00ffd5,transparent 30%,#7f00ff,transparent 60%,#00ffd5);filter:blur(18px);opacity:0.25;animation:haloSpin 6s linear infinite}
#questPanel::after,#mapPanel::after{content:"";position:absolute;inset:1px;border-radius:15px;pointer-events:none;border:1px solid rgba(255,255,255,0.08);box-shadow:inset 0 0 14px rgba(0,255,213,0.12)}
@keyframes haloSpin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
#game,#dungeonUI{width:950px;padding:30px;background:rgba(12,12,18,0.95);border-radius:16px;box-shadow:0 0 40px rgba(255,59,127,0.6);margin-bottom:20px;}
#hud{display:flex;justify-content:space-between;gap:10px;align-items:center;background:#12101a;border:1px solid #2a2436;border-radius:12px;padding:8px 10px;margin-bottom:8px}
#hud .hud-left{display:flex;gap:8px;flex-wrap:wrap}
#hud .hud-right{display:flex;gap:8px;flex-wrap:wrap}
#hud .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#1a1424;border:1px solid #2b2338;color:#d7cfea}
#zoneMap{display:flex;flex-direction:column;gap:8px;justify-content:center;margin-top:10px}
#zoneMap .zone{background:#122;border:1px solid #355;border-radius:10px;padding:8px 10px;color:#cfe;cursor:pointer;display:flex;flex-direction:column;gap:4px}
#zoneMap .zone.active{background:#00ffd5;color:#000;border-color:#00ffd5;animation:pulse 1.6s ease-in-out infinite}
#zoneMap .zone .sub{font-size:11px;color:#9fc}
#zoneMap .zone.locked{opacity:0.55}
#zoneMap .zone .bar{height:6px;border-radius:6px;background:#1b1b24;border:1px solid #2a2436;overflow:hidden}
#zoneMap .zone .bar .fill{height:100%;background:linear-gradient(90deg,#00ffd5,#7f00ff)}
@keyframes pulse{0%{box-shadow:0 0 0 rgba(0,255,213,0.4)}50%{box-shadow:0 0 14px rgba(0,255,213,0.6)}100%{box-shadow:0 0 0 rgba(0,255,213,0.4)}}
#questPanel h2{margin:0 0 10px 0;color:#00ffd5;text-align:center}
#mapPanel h2{margin:0 0 10px 0;color:#b27bff;text-align:center}
#questList{display:flex;flex-direction:column;gap:10px}
#questList .quest{background:#111;border:1px solid #244;border-radius:10px;padding:10px}
#questList .quest .title{font-weight:600;color:#00ffd5}
#questList .quest .meta{font-size:13px;color:#aaa;margin-top:4px}
#dungeonUI{display:none;}
h1{text-align:center;color:#ff3b7f;font-family:"Cinzel", serif;letter-spacing:1px}
#log,#dungeonLog{height:150px;overflow-y:auto;background:#111;padding:10px;border-radius:10px;box-shadow:0 0 15px #ff3b7f;margin-bottom:10px}
button{padding:12px 18px;margin:5px;border:none;border-radius:12px;background:linear-gradient(180deg,var(--neo-bg-1),var(--neo-bg-2));color:var(--neo-ink);font-size:16px;cursor:pointer;box-shadow:var(--neo-shadow);transition:transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease}
button:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(0,0,0,0.55);filter:brightness(1.05)}
button:active{transform:translateY(0);filter:brightness(0.98)}
button:focus-visible{outline:2px solid var(--neo-c);outline-offset:2px}
button.btn-lg{font-size:15px;padding:11px 16px}
button.btn-md{font-size:14px;padding:9px 14px}
button.btn-sm{font-size:13px;padding:8px 12px}
button.btn-combat{background:linear-gradient(90deg,var(--neo-a),var(--neo-b));border:none;color:#fff}
button.btn-service{background:linear-gradient(90deg,var(--neo-c),#5b8dff);border:none;color:#0b0b12}
button.btn-social{background:linear-gradient(90deg,#8a5bff,#00ffd5);border:none;color:#0b0b12}
button.btn-util{background:linear-gradient(180deg,#191327,#110d18);border:1px solid var(--neo-border)}
button.btn-menu{background:linear-gradient(180deg,#1c1630,#120d1a);border:1px solid rgba(255,255,255,0.08)}
.emoji{display:inline-block;font-size:1.1em;line-height:1;vertical-align:-0.12em}
.bar-container{width:100%;height:20px;background:#222;border-radius:10px;margin-bottom:8px}
.bar{height:100%;border-radius:10px;transition:width 0.4s}
.hp{background:linear-gradient(90deg,#00ff66,#00cc55)}
.xp{background:linear-gradient(90deg,#7f00ff,#b84dff)}
.monster-bar{background:linear-gradient(90deg,#ff0000,#ff6666)}
.monster-img{width:96px;height:96px;image-rendering:pixelated;background:#111;border:1px solid #2b2338;border-radius:10px;padding:4px;display:block;margin:6px auto}
.hit-shake{animation:hitShake 0.25s ease}
.boss-pulse{animation:bossPulse 1.6s ease-in-out infinite}
@keyframes hitShake{0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-3px)}100%{transform:translateX(0)}}
@keyframes bossPulse{0%{filter:drop-shadow(0 0 6px rgba(127,0,255,0.4))}50%{filter:drop-shadow(0 0 18px rgba(0,255,213,0.7))}100%{filter:drop-shadow(0 0 6px rgba(127,0,255,0.4))}}
#actions,#menu,#dungeonActions,#secondaryActions{display:flex;flex-wrap:wrap;justify-content:center}
#actions{gap:6px;align-items:center}
#actions button{padding:9px 14px;font-size:14px;border-radius:12px;background:linear-gradient(180deg,#191327,#110d18);border:1px solid var(--neo-border);box-shadow:var(--neo-shadow);color:var(--neo-ink)}
#actions button.primary-action{background:linear-gradient(90deg,var(--neo-a),var(--neo-b));border:none;box-shadow:0 0 16px rgba(255,59,127,0.35)}
#menu{margin-top:10px;min-height:60px;background:#0f0f16;border:1px solid #242030;border-radius:12px;padding:10px}
#menu h3{margin:6px 0 8px 0;text-align:center;color:#ffe7ff;font-family:"Cinzel", serif}
.secondary-panel{margin-top:6px;display:none;gap:8px;padding:8px;border-radius:12px;background:#12101a;border:1px solid #2a2436}
.secondary-panel.show{display:flex}
#secondaryActions{gap:6px}
#secondaryActions button{padding:8px 12px;font-size:13px;border-radius:10px;background:linear-gradient(180deg,#191327,#100c17);border:1px solid rgba(0,255,213,0.22);box-shadow:var(--neo-shadow);color:#efe8ff}
.action-label{width:100%;text-align:center;color:#8f8aa0;font-size:12px;margin:2px 0}
.item-btn{background:linear-gradient(180deg,#171327,#0f0b16);border:1px solid rgba(127,0,255,0.25);margin:4px;border-radius:10px;color:#f2edff;box-shadow:var(--neo-shadow)}
.item-btn:hover{filter:brightness(1.06)}
.talent-row{display:flex;align-items:center;justify-content:space-between;gap:10px;background:#14101d;border:1px solid #2b2338;border-radius:12px;padding:8px 10px;margin:6px 0}
.talent-row .small{margin:0}
.talent-row .item-btn{margin:0}
.small{font-size:14px;color:#bbb}
.event-banner{margin:6px 0;padding:6px 10px;border-radius:10px;background:#1a1424;border:1px solid #2b2338;color:#d7cfea;font-size:12px}
.quest-menu{display:flex;flex-direction:column;gap:10px}
.quest-card{background:#0f0f16;border:1px solid #242030;border-radius:12px;padding:10px}
.quest-head{display:flex;justify-content:space-between;align-items:center;gap:10px}
.quest-faction{font-size:11px;background:#1a1424;border:1px solid #2b2338;border-radius:999px;padding:2px 8px;color:#d7cfea}
.quest-actions{display:flex;gap:8px;flex-wrap:wrap}
.quest-sort{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#1a1424;border:1px solid #2b2338;font-size:11px;color:#d7cfea}
.list-card{background:#0f0f16;border:1px solid #242030;border-radius:12px;padding:8px;margin:6px 0}
#toast{position:fixed;top:20px;right:20px;z-index:2000;display:flex;flex-direction:column;gap:8px}
.toast-item{background:#1a1424;border:1px solid #2b2338;color:#ffe7ff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,0.45);min-width:220px}
.toast-title{font-weight:600;margin-bottom:4px}
#hoverTip{position:fixed;z-index:3000;pointer-events:none;background:#14101d;color:#f3eefc;border:1px solid #2b2338;border-radius:10px;padding:6px 8px;box-shadow:0 10px 25px rgba(0,0,0,0.45);font-size:12px;max-width:260px;display:none}
.hover-suppressed{display:none !important}
.bestiary-img{width:64px;height:64px;image-rendering:pixelated;border-radius:8px;border:1px solid #2b2338;background:#111;padding:2px}
.bestiary-row{display:flex;gap:10px;align-items:center}
#classScreen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(135deg,rgba(8,6,13,0.98),rgba(10,8,20,0.95));backdrop-filter:blur(6px);z-index:50}
#startScreen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(135deg,rgba(6,6,10,0.98),rgba(18,10,28,0.96));backdrop-filter:blur(6px);z-index:60}
#difficultyScreen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(135deg,rgba(6,6,10,0.98),rgba(18,10,28,0.96));backdrop-filter:blur(6px);z-index:70}
.class-modal{width:min(980px,92vw);padding:28px 28px 22px;border-radius:20px;background:rgba(10,10,16,0.92);border:1px solid rgba(255,255,255,0.08);box-shadow:0 20px 80px rgba(0,0,0,0.6)}
.class-title{font-family:"Cinzel", serif;text-align:center;font-size:32px;margin:0 0 8px;color:#ffe7ff}
.class-sub{text-align:center;color:#b9b2c7;margin:0 0 22px}
.class-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
.class-card{position:relative;padding:18px;border-radius:16px;background:linear-gradient(135deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.08);transition:transform 0.2s, box-shadow 0.2s, border-color 0.2s}
.class-card:hover{transform:translateY(-4px);box-shadow:0 14px 30px rgba(0,0,0,0.4);border-color:rgba(255,255,255,0.22)}
.class-name{font-family:"Cinzel", serif;font-size:22px;margin:0 0 6px;color:#00ffd5}
.class-tag{display:inline-block;font-size:12px;color:#0a0a0f;background:#00ffd5;padding:3px 8px;border-radius:999px;margin-bottom:10px}
.class-desc{font-size:14px;color:#cfc8dc;min-height:44px;margin:0 0 10px}
.class-stats{display:flex;gap:10px;flex-wrap:wrap;font-size:13px;color:#dcd6e6;margin:0 0 12px}
.class-stats span{background:#16131f;border:1px solid #2b2338;padding:4px 8px;border-radius:10px}
.class-pick{width:100%;margin:0;padding:10px 12px;background:linear-gradient(90deg,var(--neo-a),var(--neo-b));box-shadow:0 0 20px rgba(255,59,127,0.5)}
.hidden{display:none !important}
#startScreen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(135deg,rgba(6,6,10,0.98),rgba(18,10,28,0.96));backdrop-filter:blur(6px);z-index:60}
.start-modal{width:min(760px,92vw);padding:34px;border-radius:22px;background:rgba(10,10,16,0.95);border:1px solid rgba(255,255,255,0.08);box-shadow:0 30px 90px rgba(0,0,0,0.65);text-align:center}
.start-title{font-family:"Cinzel", serif;font-size:38px;margin:0 0 6px;color:#ffe7ff;letter-spacing:1px}
.start-sub{margin:0 0 26px;color:#b9b2c7}
.start-actions{display:grid;grid-template-columns:1fr;gap:12px}
.start-btn{padding:14px 18px;border-radius:12px;font-size:18px;background:linear-gradient(90deg,var(--neo-c),var(--neo-b));box-shadow:0 0 22px rgba(0,255,213,0.35)}
.start-btn.secondary{background:#1b1524;color:#f5f2ff;border:1px solid #2e243a;box-shadow:none}
.start-hint{margin-top:16px;font-size:12px;color:#8f8aa0}
.start-save{margin-top:10px;font-size:12px;color:#a9a3b7}
.screen{opacity:0;transform:scale(0.98);transition:opacity calc(0.25s * var(--anim-speed,1)) ease, transform calc(0.25s * var(--anim-speed,1)) ease}
.screen.show{opacity:1;transform:scale(1)}
#optionsScreen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(135deg,rgba(6,6,10,0.98),rgba(18,10,28,0.96));backdrop-filter:blur(6px);z-index:70}
#confirmScreen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:radial-gradient(800px 500px at 20% 10%,rgba(0,255,213,0.15),transparent 55%),radial-gradient(900px 600px at 80% 20%,rgba(127,0,255,0.18),transparent 60%),rgba(6,6,10,0.92);backdrop-filter:blur(8px);z-index:80}
#worldBossScreen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:radial-gradient(900px 600px at 20% 10%,rgba(0,255,213,0.18),transparent 55%),radial-gradient(1000px 700px at 80% 20%,rgba(127,0,255,0.2),transparent 60%),#05040a;z-index:90;overflow:hidden}
#worldBossScreen .boss-backdrop{position:absolute;inset:-20%;background:conic-gradient(from 180deg,rgba(0,255,213,0.12),transparent 35%,rgba(127,0,255,0.18),transparent 70%);filter:blur(30px);animation:bossDrift 14s linear infinite;pointer-events:none}
#worldBossScreen .boss-stars{position:absolute;inset:0;background:
    radial-gradient(2px 2px at 20% 30%,rgba(255,255,255,0.4),transparent 50%),
    radial-gradient(2px 2px at 60% 70%,rgba(255,255,255,0.35),transparent 50%),
    radial-gradient(1px 1px at 80% 20%,rgba(255,255,255,0.35),transparent 50%),
    radial-gradient(1px 1px at 35% 80%,rgba(255,255,255,0.3),transparent 50%);opacity:0.6;animation:starPulse 6s ease-in-out infinite;pointer-events:none}
.boss-wrap{position:relative;width:min(980px,94vw);padding:22px;border-radius:24px;background:rgba(10,10,16,0.9);border:1px solid rgba(255,255,255,0.08);box-shadow:0 40px 120px rgba(0,0,0,0.7)}
.boss-header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px}
.boss-title{font-family:"Cinzel", serif;font-size:28px;color:#ffe7ff;margin:0}
.boss-sub{color:#b9b2c7;font-size:13px}
.boss-grid{display:grid;grid-template-columns:1.2fr 0.8fr;gap:16px}
.boss-portrait{display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(18,12,28,0.9),rgba(10,8,18,0.9));border:1px solid rgba(127,0,255,0.25);border-radius:18px;padding:16px}
.boss-portrait img{width:180px;height:180px;filter:drop-shadow(0 0 22px rgba(127,0,255,0.6))}
.boss-debuffs{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
.debuff-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#1a1424;border:1px solid #2b2338;color:#d7cfea;font-size:11px}
.boss-cinematic{position:absolute;inset:0;pointer-events:none;animation:bossEntry 2.2s ease forwards}
.boss-cinematic .ring{position:absolute;inset:15%;border:2px solid rgba(0,255,213,0.35);border-radius:50%;filter:blur(0.5px);animation:ringPulse 2.2s ease forwards}
.boss-cinematic .burst{position:absolute;inset:0;background:radial-gradient(400px 300px at 50% 50%,rgba(127,0,255,0.35),transparent 70%);opacity:0;animation:burst 2.2s ease forwards}
.boss-zoom{position:absolute;inset:0;pointer-events:none;backdrop-filter:blur(0px);animation:bossZoom 2.2s ease forwards}
.phase-fx{position:absolute;inset:0;pointer-events:none;opacity:0}
.phase-fx.fx1{background:radial-gradient(400px 300px at 30% 40%,rgba(0,255,213,0.25),transparent 70%);animation:phasePulse 1s ease}
.phase-fx.fx2{background:conic-gradient(from 0deg,rgba(127,0,255,0.18),transparent 30%,rgba(255,59,127,0.18),transparent 60%);animation:phaseSpin 1.2s ease}
.phase-fx.fx3{background:radial-gradient(500px 400px at 50% 50%,rgba(255,0,77,0.2),transparent 70%);animation:phasePulse 1s ease}
.phase-fx.fx4{background:radial-gradient(600px 400px at 60% 40%,rgba(0,120,255,0.2),transparent 70%);animation:phaseSpin 1.1s ease}
.boss-bars{display:grid;gap:8px}
.boss-log{height:180px;overflow-y:auto;background:#0f0b16;border:1px solid #242030;border-radius:12px;padding:10px}
.boss-actions{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:10px}
.boss-badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#1a1424;border:1px solid #2b2338;color:#d7cfea;font-size:12px}
.boss-intro{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:radial-gradient(600px 400px at 50% 40%,rgba(0,255,213,0.25),transparent 60%),rgba(5,4,10,0.75);backdrop-filter:blur(6px);z-index:2;animation:introFade 2.4s ease forwards;pointer-events:none}
.boss-cinematic,.boss-zoom,.boss-flash,.boss-shock,.phase-fx{pointer-events:none}
.boss-intro h1{font-family:"Cinzel", serif;color:#ffe7ff;font-size:40px;letter-spacing:2px;text-shadow:0 0 18px rgba(127,0,255,0.6)}
.boss-flash{position:absolute;inset:0;background:radial-gradient(600px 400px at 50% 50%,rgba(127,0,255,0.35),transparent 70%);opacity:0;pointer-events:none;animation:bossFlash 0.8s ease}
.boss-shock{position:absolute;inset:0;border:2px solid rgba(0,255,213,0.35);border-radius:24px;opacity:0;pointer-events:none;animation:bossShock 0.8s ease}
@keyframes bossDrift{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
@keyframes starPulse{0%{opacity:0.4}50%{opacity:0.7}100%{opacity:0.4}}
@keyframes introFade{0%{opacity:1}70%{opacity:1}100%{opacity:0}}
@keyframes bossFlash{0%{opacity:0}30%{opacity:1}100%{opacity:0}}
@keyframes bossShock{0%{opacity:0}40%{opacity:1}100%{opacity:0}}
@keyframes bossEntry{0%{opacity:0}20%{opacity:1}80%{opacity:1}100%{opacity:0}}
@keyframes ringPulse{0%{transform:scale(0.6);opacity:0}40%{transform:scale(1.05);opacity:0.8}100%{transform:scale(1.3);opacity:0}}
@keyframes burst{0%{opacity:0}30%{opacity:1}100%{opacity:0}}
@keyframes bossZoom{0%{opacity:0}20%{opacity:1;backdrop-filter:blur(0px)}80%{opacity:1;backdrop-filter:blur(6px)}100%{opacity:0;backdrop-filter:blur(0px)}}
@keyframes phasePulse{0%{opacity:0}30%{opacity:1}100%{opacity:0}}
@keyframes phaseSpin{0%{opacity:0;transform:rotate(0deg)}40%{opacity:1}100%{opacity:0;transform:rotate(220deg)}}
.options-modal{width:min(720px,92vw);padding:28px;border-radius:20px;background:rgba(10,10,16,0.95);border:1px solid rgba(255,255,255,0.08);box-shadow:0 30px 90px rgba(0,0,0,0.65)}
.options-title{font-family:"Cinzel", serif;font-size:30px;margin:0 0 10px;color:#ffe7ff;text-align:center}
.options-grid{display:grid;grid-template-columns:1fr;gap:14px}
.opt-row{display:flex;align-items:center;justify-content:space-between;gap:14px;background:#16131f;border:1px solid #2b2338;padding:12px 14px;border-radius:12px}
.opt-row label{color:#e3dff0}
.opt-row input[type="range"]{width:220px}
.opt-row select{background:#0f0c14;color:#fff;border:1px solid #2b2338;border-radius:8px;padding:6px 8px}
.opt-actions{display:flex;justify-content:center;gap:10px;margin-top:16px}
.opt-btn{padding:10px 16px;border-radius:10px;background:linear-gradient(90deg,var(--neo-a),var(--neo-b))}
.opt-btn.secondary{background:#1b1524;color:#f5f2ff;border:1px solid #2e243a;box-shadow:none}
.difficulty-modal{width:min(720px,92vw);padding:28px;border-radius:20px;background:rgba(10,10,16,0.95);border:1px solid rgba(255,255,255,0.08);box-shadow:0 30px 90px rgba(0,0,0,0.65)}
.modal-wrap{position:relative}
.modal-glow{position:absolute;inset:-2px;border-radius:24px;pointer-events:none;background:conic-gradient(from 180deg,#00ffd5,transparent 30%,#7f00ff,transparent 60%,#00ffd5);filter:blur(18px);opacity:0.28}
.class-modal,.start-modal,.options-modal,.difficulty-modal{animation:popIn 0.25s ease}
.difficulty-title{font-family:"Cinzel", serif;font-size:30px;margin:0 0 10px;color:#ffe7ff;text-align:center}
.difficulty-sub{text-align:center;color:#b9b2c7;margin:0 0 18px}
.difficulty-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
.difficulty-card{background:#0f0f16;border:1px solid #242030;border-radius:12px;padding:12px}
.difficulty-card h3{margin:0 0 6px 0;color:#00ffd5;font-family:"Cinzel", serif}
.difficulty-card p{margin:0 0 10px 0;color:#cfc8dc;font-size:14px}
.difficulty-pick{width:100%;margin:0;padding:10px 12px;background:linear-gradient(90deg,var(--neo-c),var(--neo-b));box-shadow:0 0 20px rgba(0,255,213,0.35)}
.confirm-modal{width:min(620px,92vw);padding:24px;border-radius:18px;background:rgba(10,10,16,0.95);border:1px solid rgba(255,255,255,0.08);box-shadow:0 30px 90px rgba(0,0,0,0.65);text-align:center}
.confirm-modal{animation:popIn 0.25s ease}
.confirm-glow{position:absolute;inset:-2px;border-radius:20px;pointer-events:none;background:conic-gradient(from 180deg,#00ffd5,transparent 30%,#7f00ff,transparent 60%,#00ffd5);filter:blur(16px);opacity:0.35}
.confirm-modal-wrap{position:relative}
.confirm-btn{padding:10px 16px;border-radius:10px;background:linear-gradient(90deg,var(--neo-a),var(--neo-b));box-shadow:0 10px 26px rgba(127,0,255,0.25)}
.confirm-btn.secondary{background:#1b1524;color:#f5f2ff;border:1px solid #2e243a;box-shadow:none}
@keyframes popIn{from{transform:scale(0.96);opacity:0}to{transform:scale(1);opacity:1}}
.confirm-title{font-family:"Cinzel", serif;font-size:26px;margin:0 0 8px;color:#ffe7ff}
.confirm-sub{margin:0 0 16px;color:#b9b2c7}
.confirm-warn{background:#1a1424;border:1px solid #2b2338;border-radius:12px;padding:10px 12px;color:#f1e8ff;font-size:13px}
.confirm-actions{display:flex;justify-content:center;gap:10px;margin-top:16px}
.confirm-btn{padding:10px 16px;border-radius:10px;background:linear-gradient(90deg,var(--neo-a),var(--neo-b))}
.confirm-btn.secondary{background:#1b1524;color:#f5f2ff;border:1px solid #2e243a;box-shadow:none}
@media (max-width: 720px){
    body{padding:12px;gap:12px;font-size:17px}
    #game,#dungeonUI{width:100%;padding:20px}
    #questBoard,#mapBoard{width:100%;position:static}
    #questPanel,#mapPanel{padding:16px}
    #hud .pill{font-size:13px}
    button{font-size:17px}
    #actions button{font-size:15px}
    #secondaryActions button{font-size:14px}
    .emoji{font-size:0.95em}
    #mobilePanels{
        display:flex;
        position:fixed;
        left:50%;
        transform:translateX(-50%);
        bottom:12px;
        gap:8px;
        padding:8px;
        background:rgba(10,10,16,0.92);
        border:1px solid #2b2338;
        border-radius:14px;
        z-index:1000;
        justify-content:center;
        width:min(520px, calc(100% - 24px));
    }
    #mobilePanels button{flex:1}
    body{padding-bottom:90px}
    #questBoard,#mapBoard{display:none}
    #questBoard.show,#mapBoard.show{display:block}
    #zoneMap .zone{padding:12px 14px;gap:6px;font-size:16px}
    #zoneMap .zone .sub{font-size:13px}
    #zoneMap .zone .bar{height:8px}
    #questList .quest{padding:12px}
    .quest-card,.list-card{padding:12px}
}
</style>
</head>
<body>

<div id="startScreen" class="screen"></div>
<div id="classScreen" class="screen"></div>
<div id="optionsScreen" class="screen"></div>
<div id="difficultyScreen" class="screen"></div>
<div id="confirmScreen" class="screen"></div>
<div id="worldBossScreen" class="screen"></div>
<div id="toast"></div>
<div id="hoverTip"></div>

<div id="mobilePanels">
  <button id="btnCombatPanel" class="panel-btn back" onclick="closeMobilePanels()"><span class="emoji">⚔️</span> Combat</button>
  <button id="btnQuestPanel" class="panel-btn quest" onclick="toggleMobilePanel('quest')"><span class="emoji">📜</span> Quêtes</button>
  <button id="btnMapPanel" class="panel-btn map" onclick="toggleMobilePanel('map')"><span class="emoji">🗺️</span> Carte</button>
  <button id="btnMenuPanel" class="panel-btn back" onclick="toggleSecondary()"><span class="emoji">➕</span> Menu</button>
  <button id="btnBackPanel" class="panel-btn back" style="display:none" onclick="closeMobilePanels()"><span class="emoji">⬅️</span> Retour</button>
</div>

<div id="questBoard">
  <div id="questPanel">
    <h2><span class="emoji">📜</span> Quêtes</h2>
    <div id="questList"></div>
  </div>
</div>

<div id="game">
<h1 id="zoneTitle">Plaine</h1>
<div id="eventBanner" class="event-banner" style="display:none;"></div>
<div id="hud"></div>
<div id="stats"></div>
<div class="bar-container"><div id="hpBar" class="bar hp"></div></div>
<div class="bar-container"><div id="xpBar" class="bar xp"></div></div>

<div id="monsterContainer">
 <div id="monsterStats"></div>
 <img id="monsterImg" class="monster-img" alt="Monstre">
 <div class="bar-container"><div id="monsterHpBar" class="bar monster-bar"></div></div>
</div>

<div id="log"></div>
<div id="actions"></div>
<div id="secondaryActions" class="secondary-panel"></div>
<div id="menu"></div>
<button onclick="enterDungeon()"><span class="emoji">🗝️</span> Entrer dans un donjon</button>
</div>

<div id="mapBoard">
  <div id="mapPanel">
    <h2><span class="emoji">🗺️</span> Carte</h2>
    <div id="zoneMap"></div>
  </div>
</div>

<div id="dungeonUI">
<h1><span class="emoji">🏰</span> Donjon</h1>
<div id="dungeonPlayer"></div>
<div class="bar-container"><div id="dungeonPlayerHpBar" class="bar hp"></div></div>
<img id="dungeonMonsterImg" class="monster-img" alt="Monstre">
<div id="dungeonStats"></div>
<div class="bar-container"><div id="dungeonHpBar" class="bar monster-bar"></div></div>
<div id="dungeonLog"></div>
<div id="dungeonActions"></div>
</div>

<script>
// ===== CONFIG =====
const XP_PER_LEVEL = 60;
const POTION_HEAL = 20;
const RESPAWN_BASE_POTIONS = 3;
const SPRITE_PATHS = [
    '../assets/monsters/',
    'assets/monsters/'
];

// ===== PLAYER =====
let player = {
    hp:50, maxHp:50, atk:8, level:1, xp:0, potions:3, gold:0, talentPoints:0,
    talents:{strength:0, vitality:0, alchemy:0, luck:0},
    skill:{name:'Coup puissant', mult:2, cooldown:0, maxCd:3},
    equipment:{weapon:null, armor:null, helmet:null, ring:null, amulet:null},
    inventory:{weapons:[], armors:[], helmets:[], rings:[], amulets:[], drops:[]},
    class:null,
    specialization:null,
    companion:null,
    artifact:null,
    artifacts:[],
    defeatedBosses:[],
    debuffs:[],
    guard:false,
    focus:false
};
let bestiary = {};
let achievements = {};

function getClassDefs(){
    return [
        {name:'Guerrier', role:'Tank brutal', desc:'Encaisse fort et frappe au corps à corps.', hp:60, atk:8, def:3, skill:{name:'Coup puissant', mult:2.0, cooldown:0, maxCd:3}},
        {name:'Mage', role:'Dégâts magiques', desc:'Gros dégâts à distance, fragile.', hp:40, atk:12, def:1, skill:{name:'Boule de feu', mult:2.5, cooldown:0, maxCd:3}},
        {name:'Archer', role:'DPS mobile', desc:'Rapide et précis, bon équilibre.', hp:50, atk:10, def:2, skill:{name:'Tir rapide', mult:1.8, cooldown:0, maxCd:2}},
        {name:'Seigneur', role:'Commandant', desc:'Très tanky, pression constante.', hp:72, atk:9, def:3, skill:{name:'Frappe royale', mult:2.0, cooldown:0, maxCd:3}},
        {name:'Roi', role:'Monarque', desc:'Équilibré, fort en duel prolongé.', hp:62, atk:10, def:2, skill:{name:'Décret', mult:2.2, cooldown:0, maxCd:3}},
        {name:'Dresseur', role:'Maître des bêtes', desc:'Synergie avec compagnon, dégâts soutenus.', hp:54, atk:9, def:2, skill:{name:'Ordre sauvage', mult:1.9, cooldown:0, maxCd:3}},
        {name:'Druide', role:'Nature', desc:'Polyvalent, contrôle et survie.', hp:58, atk:9, def:2, skill:{name:'Ronces', mult:2.1, cooldown:0, maxCd:3}},
        {name:'Assassin', role:'Furtif', desc:'Très offensif, très fragile.', hp:42, atk:13, def:1, skill:{name:'Assaut de l’ombre', mult:2.8, cooldown:0, maxCd:3}}
    ];
}

// ===== QUEST & DONJON =====
let questLevel = 1;
let quests = [];
let dungeon = {level:1, rooms:[], current:0};
let inDungeon = false;
let dungeonEnemy = null;
let dungeonRoomCleared = false;
let dungeonRoomType = '';
let inArena = false;
let arenaWave = 0;
let seasonalEvent = null;
let dailyQuest = null;
let weeklyQuest = null;
let difficulty = {id:'normal', name:'Normal', enemyMult:1, lootBonus:0};
let worldBoss = null;
let worldBossPhase = 0;
let worldBossActive = false;
const zones = [
    {id:'village', name:'Village', diff:0, rewardMult:0, reqLevel:1, safe:true, monsters:[
        {name:'Rat des ruelles',hp:10,atk:2}
    ], boss:null},
    {id:'plaine', name:'Plaine', diff:1, rewardMult:1, reqLevel:1, monsters:[
        {name:'Gobelin',hp:28,atk:6},
        {name:'Loup',hp:26,atk:8},
        {name:'Squelette',hp:32,atk:7}
    ], boss:{name:'Chef gobelin', hp:60, atk:10, lore:'Un chef brutal qui règne sur les pillards.', artifact:{id:'totem-gob', name:'Totem du Chef', atk:2, hp:10, desc:'Bonus d’attaque et vitalité.'}}},
    {id:'foret', name:'Forêt Sombre', diff:2, rewardMult:1.2, reqLevel:3, monsters:[
        {name:'Orc',hp:38,atk:9},
        {name:'Druide corrompu',hp:34,atk:10},
        {name:'Araignée géante',hp:36,atk:9}
    ], boss:{name:'Sylve infectée', hp:75, atk:13, lore:'Un esprit corrompu qui flétrit la forêt.', artifact:{id:'seed-sylve', name:'Graine de Sylve', hp:20, desc:'Régénération légère (PV +).'}}},
    {id:'marais', name:'Marais', diff:3, rewardMult:1.4, reqLevel:5, monsters:[
        {name:'Spectre',hp:40,atk:11},
        {name:'Sangsue géante',hp:42,atk:10},
        {name:'Shaman des boues',hp:38,atk:12}
    ], boss:{name:'Seigneur des brumes', hp:90, atk:15, lore:'Maître des eaux troubles, il engloutit tout.', artifact:{id:'mist-core', name:'Cœur de Brume', atk:3, desc:'+ATK et chance de loot.' , loot:0.03}}},
    {id:'volcan', name:'Volcan', diff:4, rewardMult:1.7, reqLevel:8, monsters:[
        {name:'Élémentaire de feu',hp:45,atk:14},
        {name:'Salamandre',hp:44,atk:13},
        {name:'Guerrier d’obsidienne',hp:48,atk:15}
    ], boss:{name:'Titan de lave', hp:110, atk:18, lore:'Un colosse incandescent fait de lave.', artifact:{id:'ember-crown', name:'Couronne de Braise', atk:4, desc:'Puissance ardente.'}}},
    {id:'montagnes', name:'Montagnes Gelées', diff:5, rewardMult:2.0, reqLevel:12, monsters:[
        {name:'Golem de givre',hp:58,atk:18},
        {name:'Valkyrie déchue',hp:54,atk:19},
        {name:'Yéti',hp:62,atk:17}
    ], boss:{name:'Roi givre', hp:130, atk:20, lore:'Souverain des neiges éternelles.', artifact:{id:'ice-shard', name:'Éclat polaire', hp:30, desc:'PV max augmentés.'}}},
    {id:'ruines', name:'Ruines Astrales', diff:6, rewardMult:2.4, reqLevel:16, monsters:[
        {name:'Gardien runique',hp:70,atk:22},
        {name:'Oracle brisé',hp:66,atk:24},
        {name:'Spectre stellaire',hp:64,atk:23}
    ], boss:{name:'Primordial astral', hp:150, atk:23, lore:'Un ancien gardien des étoiles.', artifact:{id:'astral-eye', name:'Œil Astral', atk:5, loot:0.04, desc:'ATK + chance de loot.'}}},
    {id:'abysses', name:'Abysses', diff:7, rewardMult:2.9, reqLevel:20, monsters:[
        {name:'Titan abysse',hp:82,atk:27},
        {name:'Sanguinaire',hp:78,atk:29},
        {name:'Briseur d’âmes',hp:86,atk:28}
    ], boss:{name:'Seigneur des abysses', hp:180, atk:28, lore:'Il dévore les âmes tombées.', artifact:{id:'void-heart', name:'Cœur du Néant', atk:6, hp:20, lifesteal:0.08, desc:'Puissance et vol de vie.'}}}
];
function getDefaultZone(){
    return zones.find(z=>z.id==='plaine') || zones[0];
}
let currentZone = getDefaultZone();

// ===== UTILS =====
const MONSTER_SPRITES = {
    'Gobelin':'gobelin.png',
    'Loup':'loup.png',
    'Squelette':'squelette.png',
    'Orc':'orc.png',
    'Druide corrompu':'druide_corrompu.png',
    'Araignée géante':'araignee_geante.png',
    'Spectre':'spectre.png',
    'Sangsue géante':'sangsue_geante.png',
    'Shaman des boues':'shaman_boues.png',
    'Élémentaire de feu':'elementaire_feu.png',
    'Salamandre':'salamandre.png',
    'Guerrier d’obsidienne':'guerrier_obsidienne.png',
    'Golem de givre':'golem_givre.png',
    'Valkyrie déchue':'valkyrie_dechue.png',
    'Yéti':'yeti.png',
    'Gardien runique':'gardien_runique.png',
    'Oracle brisé':'oracle_brise.png',
    'Spectre stellaire':'spectre_stellaire.png',
    'Titan abysse':'titan_abysse.png',
    'Sanguinaire':'sanguinaire.png',
    'Briseur d’âmes':'briseur_ames.png',
    'Démon corrompu':'demon_corrompu.png',
    'Seigneur Squelette':'seigneur_squelette.png',
    'Hydre d’acier':'hydre_acier.png',
    'Reine arachnide':'araignee_geante.png',
    'Colosse runique':'colosse_runique.png',
    'Dragon de cendre':'dragon_cendre.png',
    'Spectre primordial':'spectre_primordial.png',
    'Chef gobelin':'chef_gobelin.png',
    'Sylve infectée':'sylve_infectee.png',
    'Seigneur des brumes':'seigneur_brume.png',
    'Titan de lave':'titan_lave.png',
    'Roi givre':'roi_givre.png',
    'Primordial astral':'primordial_astral.png',
    'Seigneur des abysses':'seigneur_abysses.png'
};


const ACHIEVEMENTS_LIST = [
    {id:'first_blood', name:'Premier sang', desc:'Vaincre 1 monstre'},
    {id:'hunter_10', name:'Chasseur', desc:'Vaincre 10 monstres'},
    {id:'boss_hunter', name:'Tueur de boss', desc:'Vaincre un boss de zone'},
    {id:'rich_100', name:'Riche', desc:'Atteindre 100 or'},
    {id:'legendary_1', name:'Légendaire', desc:'Obtenir un objet légendaire'},
    {id:'arena_win', name:'Champion', desc:'Terminer l’arène'}
];

const BESTIARY_DESC = {
    'Gobelin':'Petit pillard rusé.',
    'Loup':'Prédateur rapide des plaines.',
    'Squelette':'Guerrier revenu d’entre les morts.',
    'Orc':'Brute endurante et agressive.',
    'Druide corrompu':'Esprit sauvage dévoyé.',
    'Araignée géante':'Arachnide venimeux.',
    'Spectre':'Âme errante et glaciale.',
    'Sangsue géante':'Parasite vorace des marais.',
    'Shaman des boues':'Sorcier des marécages.',
    'Élémentaire de feu':'Incarnation des flammes.',
    'Salamandre':'Créature ardente et vive.',
    'Guerrier d’obsidienne':'Armure animée par la lave.',
    'Golem de givre':'Colosse de glace.',
    'Valkyrie déchue':'Ancienne gardienne dépravée.',
    'Yéti':'Bête massive des neiges.',
    'Gardien runique':'Automate ancestral.',
    'Oracle brisé':'Devineresse hantée.',
    'Spectre stellaire':'Ombre venue des étoiles.',
    'Titan abysse':'Monstre colossal des profondeurs.',
    'Sanguinaire':'Bourreau des abysses.',
    'Briseur d’âmes':'Prédateur d’esprits.',
    'Chef gobelin':'Seigneur des pillards.',
    'Sylve infectée':'Esprit forestier corrompu.',
    'Seigneur des brumes':'Maître du marais.',
    'Titan de lave':'Colosse incandescent.',
    'Roi givre':'Souverain des glaces.',
    'Primordial astral':'Gardien des ruines.',
    'Seigneur des abysses':'Tyran des profondeurs.'
};

function pickSpriteBase(){
    const raw = location.pathname || '';
    const path = decodeURIComponent(raw);
    if(path.includes('/Html & Css/') || (path.includes('/Html') && path.includes('Css/'))){
        return SPRITE_PATHS[0];
    }
    return SPRITE_PATHS[1];
}

function setMonsterImage(imgId, name){
    const img = document.getElementById(imgId);
    if(!img) return;
    if(name === 'Colosse Éternel'){
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="192" height="192" viewBox="0 0 192 192">
            <defs>
                <radialGradient id="core" cx="50%" cy="50%" r="55%">
                    <stop offset="0%" stop-color="#00ffd5"/>
                    <stop offset="55%" stop-color="#7f00ff"/>
                    <stop offset="100%" stop-color="#0b0712"/>
                </radialGradient>
                <linearGradient id="plate" x1="0" x2="1">
                    <stop offset="0%" stop-color="#1a1424"/>
                    <stop offset="100%" stop-color="#0f0b16"/>
                </linearGradient>
            </defs>
            <rect width="192" height="192" rx="22" ry="22" fill="#0b0712"/>
            <circle cx="96" cy="96" r="70" fill="url(#core)" opacity="0.9"/>
            <circle cx="96" cy="96" r="34" fill="#0b0712"/>
            <circle cx="96" cy="96" r="14" fill="#00ffd5"/>
            <circle cx="96" cy="96" r="8" fill="#ffffff" opacity="0.9"/>
            <path d="M24 120 Q96 90 168 120" fill="none" stroke="#7f00ff" stroke-width="5" opacity="0.7"/>
            <path d="M30 70 Q60 50 90 60" fill="none" stroke="#00ffd5" stroke-width="3" opacity="0.6"/>
            <path d="M102 60 Q132 50 162 70" fill="none" stroke="#00ffd5" stroke-width="3" opacity="0.6"/>
            <rect x="30" y="130" width="132" height="22" rx="10" fill="url(#plate)" stroke="#2b2338" stroke-width="1"/>
            <circle cx="48" cy="141" r="4" fill="#7f00ff"/>
            <circle cx="144" cy="141" r="4" fill="#00ffd5"/>
        </svg>`;
        img.src = 'data:image/svg+xml;base64,' + btoa(svg);
        img.style.display = 'block';
        return;
    }
    const file = MONSTER_SPRITES[name];
    if(!file){
        img.style.display = 'none';
        return;
    }
    const primary = pickSpriteBase() + file;
    const fallback = (primary.startsWith('../') ? SPRITE_PATHS[1] : SPRITE_PATHS[0]) + file;
    img.onerror = () => {
        if(img.src.endsWith(fallback)) return;
        img.src = fallback;
    };
    img.src = primary;
    img.style.display = 'block';
}

function updateBestiary(name, type){
    if(!name) return;
    if(!bestiary[name]){
        bestiary[name] = {kills:0, firstSeen: Date.now(), type};
    }
    bestiary[name].kills += 1;
}

function unlockAchievement(id){
    if(achievements[id]) return;
    achievements[id] = {unlocked:true, time:Date.now()};
    const a = ACHIEVEMENTS_LIST.find(x=>x.id===id);
    if(a){
        log(`🏅 Succès débloqué: ${a.name}`);
        showToast(`Succès débloqué`, a.name);
    }
}

function checkAchievements(){
    const totalKills = Object.values(bestiary).reduce((s,b)=>s + (b.kills||0),0);
    if(totalKills >= 1) unlockAchievement('first_blood');
    if(totalKills >= 10) unlockAchievement('hunter_10');
    if(player.gold >= 100) unlockAchievement('rich_100');
    if(player.artifacts && player.artifacts.length > 0) unlockAchievement('legendary_1');
}

function showToast(title, message){
    const box = document.getElementById('toast');
    if(!box) return;
    const el = document.createElement('div');
    el.className = 'toast-item';
    el.innerHTML = `<div class="toast-title">${title}</div><div class="small">${message}</div>`;
    box.appendChild(el);
    setTimeout(()=>{el.remove();}, 2500);
}

function applyHoverInfo(root){
    if(!root) return;
    root.querySelectorAll('.item-btn').forEach(btn=>{
        if(btn.getAttribute('data-no-hover') === '1') return;
        let info = btn.getAttribute('data-info') || btn.getAttribute('title') || '';
        if(!info){
            const next = btn.nextElementSibling;
            if(next && next.classList.contains('small')){
                info = next.textContent.trim();
                btn.setAttribute('data-info', info);
                next.classList.add('hover-suppressed');
            }
        }
        if(info) btn.title = info;
    });
}

function initHoverInfo(){
    const menu = document.getElementById('menu');
    const questList = document.getElementById('questList');
    const tip = document.getElementById('hoverTip');
    const body = document.body;
    function showTip(text, x, y){
        if(!tip || !text) return;
        tip.textContent = text;
        tip.style.display = 'block';
        const pad = 12;
        const maxX = window.innerWidth - pad;
        const maxY = window.innerHeight - pad;
        let left = x + 14;
        let top = y + 14;
        if(left > maxX) left = maxX;
        if(top > maxY) top = maxY;
        tip.style.left = left + 'px';
        tip.style.top = top + 'px';
    }
    function hideTip(){
        if(tip) tip.style.display = 'none';
    }
    function getInfo(btn){
        let info = btn.getAttribute('data-info') || btn.getAttribute('title') || '';
        if(!info){
            const next = btn.nextElementSibling;
            if(next && next.classList.contains('small')){
                info = next.textContent.trim();
            }
        }
        return info;
    }
    function handleClick(root, e){
        if(!window.matchMedia('(max-width: 720px)').matches) return;
        const btn = e.target.closest('.item-btn');
        if(!btn || !root.contains(btn)) return;
        const info = getInfo(btn);
        if(info) showToast('Info', info);
    }
    function handleMove(root, e){
        const btn = e.target.closest('.item-btn');
        if(!btn || !root.contains(btn)) return;
        const info = getInfo(btn);
        if(info) showTip(info, e.clientX, e.clientY);
    }
    function handleOut(root, e){
        if(!e.relatedTarget || !root.contains(e.relatedTarget)) hideTip();
    }
    if(menu){
        const obs = new MutationObserver(()=>applyHoverInfo(menu));
        obs.observe(menu, {childList:true, subtree:true});
        applyHoverInfo(menu);
        menu.addEventListener('click', (e)=>handleClick(menu, e));
        menu.addEventListener('mousemove', (e)=>handleMove(menu, e));
        menu.addEventListener('mouseleave', hideTip);
        menu.addEventListener('mouseout', (e)=>handleOut(menu, e));
    }
    if(questList){
        const obs2 = new MutationObserver(()=>applyHoverInfo(questList));
        obs2.observe(questList, {childList:true, subtree:true});
        applyHoverInfo(questList);
        questList.addEventListener('click', (e)=>handleClick(questList, e));
        questList.addEventListener('mousemove', (e)=>handleMove(questList, e));
        questList.addEventListener('mouseleave', hideTip);
        questList.addEventListener('mouseout', (e)=>handleOut(questList, e));
    }
    if(body){
        const obs3 = new MutationObserver(()=>applyHoverInfo(body));
        obs3.observe(body, {childList:true, subtree:true});
        applyHoverInfo(body);
        body.addEventListener('mousemove', (e)=>handleMove(body, e));
        body.addEventListener('mouseout', (e)=>handleOut(body, e));
    }
}

function renderBestiary(){
    currentMenu = 'bestiary';
    const m = document.getElementById('menu');
    const spriteBase = pickSpriteBase();
    const spriteFallback = spriteBase.startsWith('../') ? SPRITE_PATHS[1] : SPRITE_PATHS[0];
    const entries = Object.entries(bestiary);
    m.innerHTML = `<h3>📖 Bestiaire</h3>`;
    if(entries.length===0){
        m.innerHTML += `<div class="small">Aucun monstre rencontré.</div>`;
        return;
    }
    entries.sort((a,b)=>b[1].kills - a[1].kills);
    entries.forEach(([name,data])=>{
        const info = getMonsterInfo(name);
        const img = MONSTER_SPRITES[name] ? `${spriteBase}${MONSTER_SPRITES[name]}` : '';
        const imgFallback = MONSTER_SPRITES[name] ? `${spriteFallback}${MONSTER_SPRITES[name]}` : '';
        const desc = BESTIARY_DESC[name] || 'Créature mystérieuse.';
        m.innerHTML += `<div class="list-card">
            <div class="bestiary-row">
                ${img ? `<img class="bestiary-img" src="${img}" onerror="this.onerror=null;this.src='${imgFallback}'" alt="${name}">` : ''}
                <div>
                    <div><b>${name}</b></div>
                    <div class="small">${desc}</div>
                    <div class="small">HP: ${info.hp} | ATK: ${info.atk} | Type: ${info.type}</div>
                    <div class="small">Kills: ${data.kills}</div>
                </div>
            </div>
        </div>`;
    });
}

function renderAchievements(){
    currentMenu = 'achievements';
    const m = document.getElementById('menu');
    m.innerHTML = `<h3>🏅 Succès</h3>`;
    ACHIEVEMENTS_LIST.forEach(a=>{
        const unlocked = achievements[a.id]?.unlocked;
        m.innerHTML += `<div class="list-card">
            <div><b>${a.name}</b> ${unlocked ? '✅' : '❌'}</div>
            <div class="small">${a.desc}</div>
        </div>`;
    });
}

function getMonsterInfo(name){
    for(const z of zones){
        for(const m of z.monsters){
            if(m.name===name) return {hp:m.hp, atk:m.atk, type:'normal'};
        }
        if(z.boss && z.boss.name===name){
            return {hp:z.boss.hp, atk:z.boss.atk, type:'boss'};
        }
    }
    return {hp:'?', atk:'?', type:'?'};
}
function log(msg){
    const l=document.getElementById('log');
    l.innerHTML+=msg+'<br>';
    l.scrollTop=l.scrollHeight;
    if(worldBossActive) worldBossLog(msg);
}
function dungeonLog(msg){const l=document.getElementById('dungeonLog');l.innerHTML+=msg+'<br>';l.scrollTop=l.scrollHeight;}
function worldBossLog(msg){
    const l=document.getElementById('bossLog');
    if(!l) return;
    l.innerHTML+=msg+'<br>';
    l.scrollTop=l.scrollHeight;
}

function playBossTheme(){}
function stopBossTheme(){}
function bossSfx(){}
function rarityColor(r){return r==='Commun'?'#aaa':r==='Rare'?'#00bfff':r==='Épique'?'#d600ff':'#ffb200';}
function getTalentAtk(){return (player.talents?.strength||0);}
function getFactionAtk(){return applyFactionPerks().atk;}
function getSpecAtk(){return player.specialization?.atk || 0;}
function getSpecHp(){return player.specialization?.hp || 0;}
function getCompanionAtk(){return player.companion?.atk || 0;}
function getEventAtk(){return seasonalEvent?.bonus?.atk || 0;}
function getArtifactAtk(){return player.artifact?.atk || 0;}
function getArtifactHp(){return player.artifact?.hp || 0;}
function getArtifactLoot(){return player.artifact?.loot || 0;}
function getArtifactLifesteal(){return player.artifact?.lifesteal || 0;}
function getFactionHp(){return applyFactionPerks().hp;}
function getTalentBonusHp(){return (player.talents?.vitality||0) * 5;}
function getLuckBonus(){return (player.talents?.luck||0) * 0.02;}
function getPotionHeal(){
    let heal = POTION_HEAL + (player.talents?.alchemy||0) * 2;
    if(hasDebuff('epuisement')) heal = Math.floor(heal * 0.5);
    return heal;
}
function getEventLootBonus(){return seasonalEvent?.bonus?.loot || 0;}
function getAtk(){
    let atk = player.atk+(player.equipment.weapon?player.equipment.weapon.atk:0)+(player.equipment.ring?player.equipment.ring.atk:0)+getTalentAtk()+getFactionAtk()+getSpecAtk()+getEventAtk()+getArtifactAtk();
    if(hasDebuff('malediction')) atk = Math.max(1, atk-2);
    return atk;
}
function getDef(){
    let def = (player.equipment.armor?player.equipment.armor.def:0)+(player.equipment.helmet?player.equipment.helmet.def:0);
    if(hasDebuff('fragilite')) def = Math.max(0, def-2);
    return def;
}
function getBonusHp(){return (player.equipment.amulet?player.equipment.amulet.hp:0)+getTalentBonusHp()+getFactionHp()+getSpecHp()+getArtifactHp();}
function clamp(v,min,max){return Math.max(min,Math.min(max,v));}

function addDebuff(id, name, turns, effect){
    if(!player.debuffs) player.debuffs = [];
    const existing = player.debuffs.find(d=>d.id===id);
    if(existing){
        existing.turns = Math.max(existing.turns, turns);
        return;
    }
    player.debuffs.push({id,name,turns,effect});
}
function hasDebuff(id){
    return !!(player.debuffs || []).find(d=>d.id===id && d.turns>0);
}
function tickDebuffs(){
    if(!player.debuffs || player.debuffs.length===0) return;
    let dot = 0;
    player.debuffs.forEach(d=>{
        if(d.turns<=0) return;
        if(d.effect==='bleed') dot += 4;
        d.turns -= 1;
    });
    player.debuffs = player.debuffs.filter(d=>d.turns>0);
    if(dot>0){
        player.hp -= dot;
        log(`🩸 Saignement: -${dot} PV`);
    }
}

function getDebuffBadges(){
    if(!player.debuffs || player.debuffs.length===0) return [];
    return player.debuffs.map(d=>`Debuff: ${d.name} (${d.turns})`);
}

// ===== ENEMIES =====
function initEnemy(level=1, type='normal'){
    const monsters = (currentZone.monsters && currentZone.monsters.length)
        ? currentZone.monsters
        : (zones.find(z=>z.monsters && z.monsters.length && !z.safe)?.monsters || [{name:'Rat',hp:10,atk:2}]);
    const bosses=[
        {name:'Démon corrompu',hp:85,atk:16},
        {name:'Seigneur Squelette',hp:80,atk:15},
        {name:'Hydre d’acier',hp:90,atk:17},
        {name:'Reine arachnide',hp:88,atk:18},
        {name:'Colosse runique',hp:98,atk:20},
        {name:'Dragon de cendre',hp:110,atk:22},
        {name:'Spectre primordial',hp:105,atk:23}
    ];
    const m = type==='boss'
        ? bosses[Math.floor(Math.random()*bosses.length)]
        : monsters[Math.floor(Math.random()*monsters.length)];
    const scale = type==='boss' ? 1.35 : 1;
    const zoneScale = 1 + (currentZone.diff-1)*0.12;
    let hp = Math.floor((m.hp + level*5) * scale * zoneScale * difficulty.enemyMult);
    let atk = Math.floor((m.atk + level*2) * scale * zoneScale * difficulty.enemyMult);
    const affixes = [
        {name:'Féroce', hp:1.0, atk:1.2},
        {name:'Colossal', hp:1.25, atk:0.95},
        {name:'Sanguinaire', hp:1.1, atk:1.1},
        {name:'Rapide', hp:0.9, atk:1.15},
        {name:'Maudit', hp:1.05, atk:1.05}
    ];
    let affix = null;
    if(Math.random() < 0.25){
        affix = affixes[Math.floor(Math.random()*affixes.length)];
        hp = Math.floor(hp * affix.hp);
        atk = Math.floor(atk * affix.atk);
    }
    return {name:m.name,hp:hp,maxHp:hp,atk:atk,type, affix};
}
let enemy=initEnemy();

// ===== LOOT =====
function rollRarity(){
    const r=Math.random();
    const luck = getLuckBonus() + (seasonalEvent?.bonus?.loot || 0) + (difficulty?.lootBonus || 0);
    if(r<0.7) return 'Commun';
    if(r<0.93) return 'Rare';
    if(r<0.995 - luck) return 'Épique';
    return 'Légendaire';
}
function generateItem(){
    const types=['weapon','armor','helmet','ring','amulet'];
    const type=types[Math.floor(Math.random()*types.length)];
    const rarity=rollRarity();
    const mult=rarity==='Commun'?1:rarity==='Rare'?1.5:2.2;
    const base = Math.max(1, Math.floor(player.level*2*mult));

    const names={
        weapon:['Lame','Hache','Dague','Épée','Marteau'],
        armor:['Cuirasse','Armure','Plastron'],
        helmet:['Casque','Heaume','Visière'],
        ring:['Anneau','Bague','Sceau'],
        amulet:['Talisman','Amulette','Pendentif']
    };
    const n=names[type][Math.floor(Math.random()*names[type].length)];

    if(type==='weapon' || type==='ring'){
        const atk=base + (type==='weapon'?2:0);
        const effect = rarity==='Légendaire' ? {lifesteal:0.1} : null;
        return {type, name:`${n} ${rarity}`, atk, rarity, effect};
    }
    if(type==='amulet'){
        const hp = base * 4;
        const effect = rarity==='Légendaire' ? {lifesteal:0.05} : null;
        return {type, name:`${n} ${rarity}`, hp, rarity, effect};
    }
    const def=base;
    const effect = rarity==='Légendaire' ? {lifesteal:0.05} : null;
    return {type, name:`${n} ${rarity}`, def, rarity, effect};
}
function addLoot(item){
    if(item.type==='weapon') player.inventory.weapons.push(item);
    if(item.type==='armor') player.inventory.armors.push(item);
    if(item.type==='helmet') player.inventory.helmets.push(item);
    if(item.type==='ring') player.inventory.rings.push(item);
    if(item.type==='amulet') player.inventory.amulets.push(item);
}
function generateDrop(){
    const rarity = rollRarity();
    const pool = [
        'Essence néon',
        'Éclat d’ombre',
        'Poussière astrale',
        'Fragment cristallin',
        'Peau de bête',
        'Cendre arcanique'
    ];
    const name = pool[Math.floor(Math.random()*pool.length)];
    return {name, rarity, qty:1};
}
function addDrop(drop){
    const existing = player.inventory.drops.find(d => d.name === drop.name && d.rarity === drop.rarity);
    if(existing) existing.qty += drop.qty;
    else player.inventory.drops.push(drop);
    applyQuestProgress({dropName:drop.name, dropQty:drop.qty});
}
function dropRarityScore(r){
    return r==='Commun' ? 1 : r==='Rare' ? 2 : 3;
}
function getDropQty(name){
    return player.inventory.drops
        .filter(d => d.name === name)
        .reduce((sum,d)=>sum + d.qty, 0);
}
function spendDropByName(name, qty){
    let remaining = qty;
    const buckets = player.inventory.drops
        .filter(d => d.name === name)
        .sort((a,b)=>dropRarityScore(a.rarity)-dropRarityScore(b.rarity));
    for(const d of buckets){
        if(remaining <= 0) break;
        const use = Math.min(d.qty, remaining);
        d.qty -= use;
        remaining -= use;
    }
    player.inventory.drops = player.inventory.drops.filter(d => d.qty > 0);
    return remaining === 0;
}
function checkQuestCompletion(q, source){
    if(q.completed) return;
    const done =
        (q.objective.kills ? q.progress.kills >= q.objective.kills : true) &&
        (q.objective.chests ? q.progress.chests >= q.objective.chests : true) &&
        (q.objective.boss ? q.progress.boss : true) &&
        (q.objective.drop ? (q.progress.drop||0) >= q.objective.drop.qty : true) &&
        (q.objective.zoneKills ? (q.progress.zoneKills||0) >= q.objective.zoneKills : true);
    if(!done) return;
    q.completed = true;
    const doneMsg = `🏆 Quête terminée: ${q.name} ! (Va la valider)`;
    if(source==='dungeon') dungeonLog(doneMsg); else log(doneMsg);
    showToast('Quête terminée', q.name);
    updateUI();
}

function renderQuestBoard(){
    const list = document.getElementById('questList');
    if(!quests.length){
        list.innerHTML = '<div class="small">Aucune quête active.</div>';
        return;
    }
    list.innerHTML = quests.map((q,i)=>{
        const status = q.completed ? (q.claimed ? 'Validée' : 'Terminée') : 'En cours';
        const canClaim = q.completed && !q.claimed;
        const dropLine = q.objective.drop ? `<div class="meta">Objet ${q.objective.drop.name}: ${q.progress.drop||0}/${q.objective.drop.qty}</div>` : '';
        const zoneLine = q.objective.zoneKills ? `<div class="meta">Zone ${q.objective.zoneName}: ${q.progress.zoneKills||0}/${q.objective.zoneKills}</div>` : '';
        return `
        <div class="quest">
            <div class="title">${q.name}</div>
            ${q.objective.kills ? `<div class="meta">Kills ${q.progress.kills}/${q.objective.kills}</div>` : ''}
            ${q.objective.chests ? `<div class="meta">Coffres ${q.progress.chests}/${q.objective.chests}</div>` : ''}
            ${q.objective.boss ? `<div class="meta">Boss ${q.progress.boss?'✅':'❌'}</div>` : ''}
            ${dropLine}
            ${zoneLine}
            <div class="meta">Récompense: ${q.reward.xp} XP, ${q.reward.gold||0} or${q.reward.loot?' + loot':''}</div>
            <div class="meta">Statut: ${status}</div>
            <button class="item-btn" ${canClaim?'':'disabled'} onclick="claimQuest(${i})">Valider la quête</button>
        </div>`;
    }).join('');
}

// ===== QUEST MENU =====
let questSortMode = 'status';
function renderQuestMenu(){
    currentMenu = 'quests';
    const m = document.getElementById('menu');
    const sorted = sortQuests(quests.map((q,i)=>({q,i})));
    m.innerHTML = `<h3>📜 Quêtes</h3>
        <div class="quest-sort">
            <button class="item-btn" onclick="setQuestSort('status')">Statut</button>
            <button class="item-btn" onclick="setQuestSort('faction')">Faction</button>
            <button class="item-btn" onclick="setQuestSort('reward')">Récompense</button>
        </div>
        <div class="small">Actives: ${quests.length}</div>
        ${dailyQuest ? `<div class="small">Quête quotidienne: ${dailyQuest.quest.name}</div>` : ''}
        ${weeklyQuest ? `<div class="small">Quête hebdo: ${weeklyQuest.quest.name}</div>` : ''}
        <div class="quest-menu">${sorted.map(({q,i})=>renderQuestCard(q,i)).join('')}</div>`;
}
function renderQuestCard(q, idx){
    const status = q.completed ? (q.claimed ? 'Validée' : 'Terminée') : 'En cours';
    const canClaim = q.completed && !q.claimed;
    const dropLine = q.objective.drop ? `<div class="small">Objet ${q.objective.drop.name}: ${q.progress.drop||0}/${q.objective.drop.qty}</div>` : '';
    const zoneLine = q.objective.zoneKills ? `<div class="small">Zone ${q.objective.zoneName}: ${q.progress.zoneKills||0}/${q.objective.zoneKills}</div>` : '';
    return `
    <div class="quest-card">
        <div class="quest-head">
            <div><b>${q.name}</b> <span class="badge">${status}</span></div>
            <span class="quest-faction">${q.faction}</span>
        </div>
        ${q.objective.kills ? `<div class="small">Kills ${q.progress.kills}/${q.objective.kills}</div>` : ''}
        ${q.objective.chests ? `<div class="small">Coffres ${q.progress.chests}/${q.objective.chests}</div>` : ''}
        ${q.objective.boss ? `<div class="small">Boss ${q.progress.boss?'✅':'❌'}</div>` : ''}
        ${dropLine}
        ${zoneLine}
        <div class="small">Récompense: ${q.reward.xp} XP, ${q.reward.gold||0} or${q.reward.loot?' + loot':''}</div>
        <div class="quest-actions">
            <button class="item-btn" ${canClaim?'':'disabled'} onclick="claimQuest(${idx})">Valider</button>
            <button class="item-btn" onclick="abandonQuest(${idx})">Abandonner</button>
        </div>
    </div>`;
}
function setQuestSort(mode){
    questSortMode = mode;
    renderQuestMenu();
}
function sortQuests(list){
    if(questSortMode==='faction'){
        return list.sort((a,b)=>a.q.faction.localeCompare(b.q.faction));
    }
    if(questSortMode==='reward'){
        return list.sort((a,b)=>(b.q.reward.gold||0)-(a.q.reward.gold||0));
    }
    return list.sort((a,b)=>Number(a.q.completed)-Number(b.q.completed));
}
function abandonQuest(i){
    if(!quests[i]) return;
    quests.splice(i,1);
    quests.push(generateQuest(questLevel++));
    log('🗑️ Quête abandonnée.');
    updateUI();
    renderQuestMenu();
    saveGame();
}
function claimQuest(i){
    const q = quests[i];
    if(!q || !q.completed || q.claimed) return;
    q.claimed = true;
    const xpGain = q.reward.xp || 0;
    if(xpGain > 0) grantXP(xpGain);
    const goldGain = q.reward.gold || 0;
    if(goldGain > 0) grantGold(goldGain);
    if(q.reward.loot){
        const drop = generateDrop();
        addDrop(drop);
        log(`🎁 Récompense de quête: ${drop.name} x${drop.qty} [${drop.rarity}]`);
    }
    addReputation(q.faction, 5);
    log(`✅ Quête validée: ${q.name}`);
    replaceQuestAt(i);
    updateUI();
    saveGame();
}
function generateQuest(level){
    const types = ['hunt','chest','boss','drop','zone'];
    const type = types[Math.floor(Math.random()*types.length)];
    const baseKills = 3 + level * 2;
    const baseChests = 1 + Math.floor(level/2);
    const reward = {xp: 35 + level * 16, gold: 20 + level * 8, loot: true};
    let objective = {kills:0, chests:0, boss:false};
    let progress = {kills:0, chests:0, boss:false, drop:0, zoneKills:0};
    let name = `Aventure ${level}`;
    let faction = 'Explorateurs';
    if(type==='hunt'){
        objective.kills = baseKills;
        name = `Chasse ${level}`;
        faction = 'Chasseurs';
    } else if(type==='chest'){
        objective.chests = baseChests + 1;
        name = `Trésors ${level}`;
        faction = 'Explorateurs';
    } else if(type==='boss'){
        objective.kills = Math.max(2, Math.floor(level/2));
        objective.boss = true;
        name = `Boss ${level}`;
        faction = 'Chasseurs';
    } else if(type==='drop'){
        const pool = ['Essence néon','Éclat d’ombre','Poussière astrale','Fragment cristallin'];
        const dropName = pool[Math.floor(Math.random()*pool.length)];
        objective.drop = {name:dropName, qty:2 + Math.floor(level/2)};
        objective.kills = Math.max(2, Math.floor(level/2));
        name = `Collecte ${level}`;
        faction = 'Arcanes';
    } else if(type==='zone'){
        const unlocked = zones.filter(z=>player.level >= z.reqLevel);
        const z = unlocked[Math.floor(Math.random()*unlocked.length)];
        objective.zoneId = z.id;
        objective.zoneName = z.name;
        objective.zoneKills = 4 + level;
        name = `Purge ${z.name}`;
        faction = 'Explorateurs';
    }
    return {name, objective, progress, reward, completed:false, claimed:false, faction};
}
function initQuests(count=3){
    quests = [];
    for(let i=0;i<count;i++){
        quests.push(generateQuest(questLevel));
        questLevel++;
    }
}
function replaceQuestAt(i){
    quests[i] = generateQuest(questLevel);
    questLevel++;
    saveGame();
}

function applyQuestProgress({kills=0, chests=0, boss=false, dropName='', dropQty=0, zoneId=''}){
    const source = inDungeon ? 'dungeon' : 'world';
    quests.forEach(q=>{
        if(kills && q.objective.kills){
            q.progress.kills += kills;
        }
        if(chests && q.objective.chests){
            q.progress.chests += chests;
        }
        if(boss && q.objective.boss){
            q.progress.boss = true;
        }
        if(dropName && q.objective.drop && q.objective.drop.name === dropName){
            q.progress.drop = (q.progress.drop||0) + dropQty;
        }
        if(zoneId && q.objective.zoneKills && q.objective.zoneId === zoneId){
            q.progress.zoneKills = (q.progress.zoneKills||0) + kills;
        }
        checkQuestCompletion(q, source);
    });
    if(dailyQuest){
        applyQuestToSpecial(dailyQuest, {kills, chests, boss, dropName, dropQty, zoneId}, source);
    }
    if(weeklyQuest){
        applyQuestToSpecial(weeklyQuest, {kills, chests, boss, dropName, dropQty, zoneId}, source);
    }
}

function applyQuestToSpecial(holder, payload, source){
    const q = holder.quest;
    if(!q || q.completed) return;
    const {kills, chests, boss, dropName, dropQty, zoneId} = payload;
    if(kills && q.objective.kills){q.progress.kills += kills;}
    if(chests && q.objective.chests){q.progress.chests += chests;}
    if(boss && q.objective.boss){q.progress.boss = true;}
    if(dropName && q.objective.drop && q.objective.drop.name === dropName){q.progress.drop = (q.progress.drop||0) + dropQty;}
    if(zoneId && q.objective.zoneKills && q.objective.zoneId === zoneId){q.progress.zoneKills = (q.progress.zoneKills||0) + kills;}
    checkQuestCompletion(q, source);
    if(q.completed && !holder.claimed){
        holder.claimed = true;
        grantXP(q.reward.xp || 0);
        grantGold(q.reward.gold || 0);
        log(`🎯 Quête spéciale complétée: ${q.name}`);
    }
}

// ===== UI =====
function updateUI(){
    if(!classChosen){
        document.getElementById('stats').innerHTML='Choisis une classe pour commencer.';
        document.getElementById('hpBar').style.width='0%';
        document.getElementById('xpBar').style.width='0%';
        document.getElementById('monsterStats').innerHTML='';
        document.getElementById('monsterHpBar').style.width='0%';
        return;
    }
    if(seasonalEvent){
        const banner = document.getElementById('eventBanner');
        banner.style.display = 'block';
        banner.textContent = `Événement: ${seasonalEvent.name} — ${seasonalEvent.desc}`;
    } else {
        const banner = document.getElementById('eventBanner');
        banner.style.display = 'none';
    }
    const maxHpTotal = player.maxHp + getBonusHp();
    if(player.hp > maxHpTotal) player.hp = maxHpTotal;
    const title = document.getElementById('zoneTitle');
    if(title) title.textContent = currentZone.name;
    document.getElementById('stats').innerHTML=`👤 ${player.class} | 🌍 ${currentZone.name} | ❤️ ${player.hp}/${maxHpTotal} | ⚔️ ${getAtk()} | 🛡️ ${getDef()} | ⭐ Lv ${player.level} | 🧪 ${player.potions} | 💰 ${player.gold} | ✨ ${player.talentPoints}`;
    const hud = document.getElementById('hud');
    const totalBosses = zones.filter(z=>z.boss).length;
    const defeatedCount = player.defeatedBosses.length;
      const buffs = [];
      if(player.specialization) buffs.push(`Spé: ${player.specialization.name}`);
      if(player.companion) buffs.push(`Compagnon: ${player.companion.name}`);
      if(player.artifact) buffs.push(`Artefact: ${player.artifact.name}`);
      if(seasonalEvent) buffs.push(`Event: ${seasonalEvent.name}`);
      buffs.push(...getDebuffBadges());
    hud.innerHTML = `
        <div class="hud-left">${buffs.map(b=>`<span class="pill">${b}</span>`).join('')}</div>
        <div class="hud-right">
            <span class="pill">Boss ${defeatedCount}/${totalBosses}</span>
            <span class="pill">Loot+ ${(Math.round((getLuckBonus()+getEventLootBonus()+getArtifactLoot())*100))}%</span>
            <span class="pill">ATK ${getAtk()}</span>
            <span class="pill">PV ${player.hp}/${maxHpTotal}</span>
        </div>`;
    document.getElementById('hpBar').style.width=clamp(player.hp/maxHpTotal*100,0,100)+'%';
    document.getElementById('xpBar').style.width=clamp(player.xp/(player.level*XP_PER_LEVEL)*100,0,100)+'%';
    const monsterContainer = document.getElementById('monsterContainer');
    if(currentZone.safe){
        if(monsterContainer) monsterContainer.style.display = 'none';
        document.getElementById('monsterHpBar').style.width='0%';
    } else {
        if(!enemy) enemy = initEnemy(player.level);
        if(monsterContainer) monsterContainer.style.display = 'block';
        const aff = enemy.affix ? ` (${enemy.affix.name})` : '';
        document.getElementById('monsterStats').innerHTML=`👹 ${enemy.name}${aff} HP: ${enemy.hp}/${enemy.maxHp}`;
        document.getElementById('monsterHpBar').style.width=clamp(enemy.hp/enemy.maxHp*100,0,100)+'%';
        const img = document.getElementById('monsterImg');
        if(img) img.style.display = 'block';
        setMonsterImage('monsterImg', enemy.name);
    }
    renderQuestBoard();
    renderZoneMap();
    buildSecondaryActions();
    updateActionVisibility();
    updateWorldBossUI();
    checkAchievements();
}
function updateDungeonUI(){
    let line = '';
    if(inArena){
        line = `Arène | Vague ${arenaWave}`;
    } else {
        const room = dungeon.rooms[dungeon.current];
        line = `Niveau ${dungeon.level} | Salle ${dungeon.current+1}/${dungeon.rooms.length} | Type: ${room.type}`;
    }
    const maxHpTotal = player.maxHp + getBonusHp();
    if(player.hp > maxHpTotal) player.hp = maxHpTotal;
    document.getElementById('dungeonPlayer').innerHTML=`👤 ${player.class} | ❤️ ${player.hp}/${maxHpTotal} | ⚔️ ${getAtk()} | 🛡️ ${getDef()}`;
    document.getElementById('dungeonPlayerHpBar').style.width=clamp(player.hp/maxHpTotal*100,0,100)+'%';
    if(dungeonEnemy){
        const aff = dungeonEnemy.affix ? ` (${dungeonEnemy.affix.name})` : '';
        line += ` | 👹 ${dungeonEnemy.name}${aff} ${dungeonEnemy.hp}/${dungeonEnemy.maxHp}`;
        document.getElementById('dungeonHpBar').style.width=clamp(dungeonEnemy.hp/dungeonEnemy.maxHp*100,0,100)+'%';
        setMonsterImage('dungeonMonsterImg', dungeonEnemy.name);
    } else {
        document.getElementById('dungeonHpBar').style.width='0%';
        const img = document.getElementById('dungeonMonsterImg');
        if(img) img.style.display = 'none';
    }
    document.getElementById('dungeonStats').innerHTML=line;
}

// ===== COMBAT (MONDE) =====
function attack(){
    if(currentZone.safe){log('🏠 Le Village est une zone sûre.');return;}
    if(!enemy) return;
    if(player.hp<=0)return;
    let dmg=Math.floor(Math.random()*4)+getAtk();
    if(player.focus){dmg=Math.floor(dmg*1.4); player.focus=false;}
    enemy.hp-=dmg;
    const img = document.getElementById('monsterImg');
    if(img){img.classList.add('hit-shake'); setTimeout(()=>img.classList.remove('hit-shake'),250);}
    log(`⚔️ Tu infliges ${dmg} dégâts à ${enemy.name}`);
    applyLifesteal(dmg);
    companionStrike(enemy);
    if(enemy.hp<=0){winCombat(false);return;}
    enemyTurn(false);
}
function useSkill(){
    if(currentZone.safe){log('🏠 Le Village est une zone sûre.');return;}
    if(!enemy) return;
    if(player.skill.cooldown>0){log('⏳ Compétence en recharge');return;}
    let dmg=Math.floor(getAtk()*player.skill.mult);
    if(player.focus){dmg=Math.floor(dmg*1.4); player.focus=false;}
    enemy.hp-=dmg;
    const img = document.getElementById('monsterImg');
    if(img){img.classList.add('hit-shake'); setTimeout(()=>img.classList.remove('hit-shake'),250);}
    player.skill.cooldown=player.skill.maxCd;
    log(`🔥 ${player.skill.name} inflige ${dmg} dégâts !`);
    applyLifesteal(dmg);
    companionStrike(enemy);
    if(enemy.hp<=0){winCombat(false);return;}
    enemyTurn(false);
}
function quickStrike(){
    if(!worldBossActive || !enemy || enemy.type!=='worldBoss'){log('🌌 Cette action est réservée au boss mondial.');return;}
    if(currentZone.safe){log('🏠 Le Village est une zone sûre.');return;}
    if(!enemy) return;
    if(player.hp<=0)return;
    const dmg=Math.max(1, Math.floor(getAtk()*0.7));
    enemy.hp-=dmg;
    const img = document.getElementById('monsterImg');
    if(img){img.classList.add('hit-shake'); setTimeout(()=>img.classList.remove('hit-shake'),250);}
    if(Math.random()<0.2) addDebuff('saignement','Saignement',2,'bleed');
    log(`⚡ Frappe rapide: ${dmg} dégâts`);
    if(enemy.hp<=0){winCombat(false);return;}
    enemyTurn(false);
}
function guard(){
    if(!worldBossActive || !enemy || enemy.type!=='worldBoss'){log('🌌 Cette action est réservée au boss mondial.');return;}
    if(currentZone.safe){log('🏠 Le Village est une zone sûre.');return;}
    if(player.hp<=0)return;
    player.guard=true;
    log('🛡️ Parade: réduit les prochains dégâts.');
    enemyTurn(false);
}
function focus(){
    if(!worldBossActive || !enemy || enemy.type!=='worldBoss'){log('🌌 Cette action est réservée au boss mondial.');return;}
    if(currentZone.safe){log('🏠 Le Village est une zone sûre.');return;}
    if(player.hp<=0)return;
    player.focus=true;
    log('🎯 Concentration: prochain coup plus puissant.');
    enemyTurn(false);
}
function enemyTurn(isDungeon){
    const foe = isDungeon ? dungeonEnemy : enemy;
    if(!foe) return;
    let dmg=Math.max(1,foe.atk-getDef());
    if(player.guard){dmg=Math.max(1, Math.floor(dmg*0.5)); player.guard=false;}
    player.hp-=dmg;
    if(isDungeon){
        dungeonLog(`💥 ${foe.name} inflige ${dmg}`);
    } else {
        log(`💥 ${foe.name} inflige ${dmg}`);
    }
    if(!isDungeon){
        checkWorldBossPhase(foe);
        tickDebuffs();
    }
    if(player.hp<=0){
        if(difficulty?.oneLife){
            const msg = '💀 Mort définitive (Impossible). Partie terminée.';
            if(isDungeon) dungeonLog(msg); else log(msg);
            showToast('Game Over', 'Mode Impossible: une seule vie.');
            localStorage.removeItem('rpgSave');
            setActionsEnabled(false);
            closeWorldBossScreen();
            showStartMenu();
        } else {
            if(isDungeon) dungeonLog('💀 Tu es mort ! Redémarrage...');
            else log('💀 Tu es mort ! Redémarrage...');
            if(worldBossActive) closeWorldBossScreen();
            setTimeout(restartGame,1500);
        }
        return;
    }
    tickCooldown();
    updateUI();
    if(isDungeon) updateDungeonUI();
}
function potion(){
    if(player.potions<=0) return;
    player.potions--;
    const maxHpTotal = player.maxHp + getBonusHp();
    player.hp=Math.min(maxHpTotal,player.hp+getPotionHeal());
    log('🧪 Potion utilisée');
    updateUI();
}

// ===== COMBAT (DONJON) =====
function dungeonAttack(){
    if(player.hp<=0 || !dungeonEnemy) return;
    let dmg=Math.floor(Math.random()*4)+getAtk();
    if(player.focus){dmg=Math.floor(dmg*1.4); player.focus=false;}
    dungeonEnemy.hp-=dmg;
    const img = document.getElementById('dungeonMonsterImg');
    if(img){img.classList.add('hit-shake'); setTimeout(()=>img.classList.remove('hit-shake'),250);}
    dungeonLog(`⚔️ Tu infliges ${dmg} dégâts à ${dungeonEnemy.name}`);
    applyLifesteal(dmg);
    companionStrike(dungeonEnemy);
    if(dungeonEnemy.hp<=0){winCombat(true);return;}
    enemyTurn(true);
}
function dungeonSkill(){
    if(player.skill.cooldown>0){dungeonLog('⏳ Compétence en recharge');return;}
    let dmg=Math.floor(getAtk()*player.skill.mult);
    if(player.focus){dmg=Math.floor(dmg*1.4); player.focus=false;}
    dungeonEnemy.hp-=dmg;
    const img = document.getElementById('dungeonMonsterImg');
    if(img){img.classList.add('hit-shake'); setTimeout(()=>img.classList.remove('hit-shake'),250);}
    player.skill.cooldown=player.skill.maxCd;
    dungeonLog(`🔥 ${player.skill.name} inflige ${dmg} dégâts !`);
    applyLifesteal(dmg);
    companionStrike(dungeonEnemy);
    if(dungeonEnemy.hp<=0){winCombat(true);return;}
    enemyTurn(true);
}
function dungeonQuickStrike(){
    if(player.hp<=0 || !dungeonEnemy) return;
    const dmg=Math.max(1, Math.floor(getAtk()*0.7));
    dungeonEnemy.hp-=dmg;
    const img = document.getElementById('dungeonMonsterImg');
    if(img){img.classList.add('hit-shake'); setTimeout(()=>img.classList.remove('hit-shake'),250);}
    if(Math.random()<0.2) addDebuff('saignement','Saignement',2,'bleed');
    dungeonLog(`⚡ Frappe rapide: ${dmg} dégâts`);
    if(dungeonEnemy.hp<=0){winCombat(true);return;}
    enemyTurn(true);
}
function dungeonGuard(){
    if(player.hp<=0 || !dungeonEnemy) return;
    player.guard=true;
    dungeonLog('🛡️ Parade: réduit les prochains dégâts.');
    enemyTurn(true);
}
function dungeonFocus(){
    if(player.hp<=0 || !dungeonEnemy) return;
    player.focus=true;
    dungeonLog('🎯 Concentration: prochain coup plus puissant.');
    enemyTurn(true);
}
function dungeonPotion(){
    if(player.potions<=0) return;
    player.potions--;
    const maxHpTotal = player.maxHp + getBonusHp();
    player.hp=Math.min(maxHpTotal,player.hp+getPotionHeal());
    dungeonLog('🧪 Potion utilisée');
    updateUI();
    updateDungeonUI();
}

// ===== PROGRESSION =====
function grantXP(amount){
    player.xp+=amount;
    while(player.xp >= player.level*XP_PER_LEVEL){
        player.xp -= player.level*XP_PER_LEVEL;
        player.level++;
        player.maxHp += 10;
        player.hp = player.maxHp;
        player.atk += 2;
        player.talentPoints += 1;
        log(`⭐ Niveau ${player.level} atteint ! +10 PV, +2 ATK, +1 point de talent`);
        zones.forEach(z=>{
            if(z.reqLevel === player.level){
                showToast('Zone débloquée', z.name);
            }
        });
    }
}
function tickCooldown(){
    if(player.skill.cooldown>0) player.skill.cooldown--;
}

function grantGold(amount){
    player.gold += amount;
    const write = inDungeon ? dungeonLog : log;
    write(`💰 Tu gagnes ${amount} or`);
}

function spendGold(amount){
    if(player.gold < amount) return false;
    player.gold -= amount;
    return true;
}

function addReputation(faction, amount){
    if(!faction) return;
    if(factions[faction]===undefined) factions[faction]=0;
    const before = factions[faction];
    factions[faction] += amount;
    if(factions[faction] >= 25 && before < 25){
        log(`🏛️ Réputation ${faction} : Reconnue`);
        if(faction==='Arcanes'){player.potions += 1; log('🧪 Bonus Arcanes: +1 potion');}
    } else if(factions[faction] >= 50 && before < 50){
        log(`🏛️ Réputation ${faction} : Respectée`);
        if(faction==='Arcanes'){player.potions += 1; log('🧪 Bonus Arcanes: +1 potion');}
    }
}

function getFactionRank(rep){
    return rep>=50 ? 'Respectée' : rep>=25 ? 'Reconnue' : 'Inconnue';
}

function applyFactionPerks(){
    const repArc = factions.Arcanes || 0;
    const repExp = factions.Explorateurs || 0;
    const repCha = factions.Chasseurs || 0;
    const bonus = {
        hp: repExp>=50 ? 20 : repExp>=25 ? 10 : 0,
        atk: repCha>=50 ? 4 : repCha>=25 ? 2 : 0,
        potions: repArc>=50 ? 2 : repArc>=25 ? 1 : 0
    };
    bonus.label = `Factions: +${bonus.hp} PV, +${bonus.atk} ATK, +${bonus.potions} potions`;
    return bonus;
}

function initWorldBoss(){
    worldBossPhase = 0;
    return {
        name:'Colosse Éternel',
        hp:2300,
        maxHp:2300,
        atk:46,
        type:'worldBoss',
        phases:[
            {threshold:0.75, debuff:{id:'fragilite', name:'Fragilité', turns:4, effect:'defDown'}},
            {threshold:0.50, debuff:{id:'malediction', name:'Malédiction', turns:4, effect:'atkDown'}},
            {threshold:0.25, debuff:{id:'saignement', name:'Saignement', turns:4, effect:'bleed'}},
            {threshold:0.10, debuff:{id:'epuisement', name:'Épuisement', turns:3, effect:'potionDown'}}
        ]
    };
}

function fightWorldBoss(){
    if(!classChosen) return;
    if(inDungeon) return;
    worldBoss = initWorldBoss();
    enemy = worldBoss;
    worldBossActive = true;
    openWorldBossScreen();
    log('🌌 Un boss mondial apparaît: Colosse Éternel !');
    showToast('Boss mondial', 'Colosse Éternel');
    updateUI();
}

function checkWorldBossPhase(foe){
    if(!foe || foe.type!=='worldBoss') return;
    const pct = foe.hp / foe.maxHp;
    const phases = foe.phases || [];
    if(worldBossPhase >= phases.length) return;
    const next = phases[worldBossPhase];
    if(pct <= next.threshold){
        worldBossPhase += 1;
        addDebuff(next.debuff.id, next.debuff.name, next.debuff.turns, next.debuff.effect);
        log(`🌀 Phase ${worldBossPhase}: ${next.debuff.name} appliqué !`);
        showToast('Phase du boss', `${next.debuff.name} (${next.debuff.turns} tours)`);
        triggerBossPhaseFX();
        bossPhaseAttack();
    }
}

function triggerBossPhaseFX(){
    const wrap = document.querySelector('.boss-wrap');
    if(!wrap) return;
    const flash = document.createElement('div');
    flash.className = 'boss-flash';
    const shock = document.createElement('div');
    shock.className = 'boss-shock';
    const phaseFx = document.createElement('div');
    const phaseClass = 'fx' + Math.min(4, Math.max(1, worldBossPhase));
    phaseFx.className = 'phase-fx ' + phaseClass;
    wrap.appendChild(flash);
    wrap.appendChild(shock);
    wrap.appendChild(phaseFx);
    setTimeout(()=>{flash.remove(); shock.remove(); phaseFx.remove();}, 1200);
}
function bossPhaseAttack(){
    const extra = 12 + worldBossPhase*6;
    player.hp -= extra;
    log(`💥 Attaque de phase: -${extra} PV`);
    updateUI();
}

function openWorldBossScreen(){
    const screen = document.getElementById('worldBossScreen');
    if(!screen) return;
    screen.innerHTML = `
        <div class="boss-backdrop"></div>
        <div class="boss-stars"></div>
        <div class="boss-wrap">
            <div class="boss-cinematic"><div class="ring"></div><div class="burst"></div></div>
            <div class="boss-zoom"></div>
            <div class="boss-intro"><h1>COLOSSE ÉTERNEL</h1></div>
            <div class="boss-header">
                <div>
                    <h2 class="boss-title">Colosse Éternel</h2>
                    <div class="boss-sub">Premier boss mondial — plusieurs phases</div>
                </div>
                <div class="boss-badge">Phase <span id="bossPhaseLabel">1</span></div>
            </div>
            <div class="boss-grid">
                <div class="boss-portrait">
                    <img id="bossImg" alt="Boss mondial">
                </div>
                <div class="boss-bars">
                    <div class="bar-container"><div id="bossHpBar" class="bar monster-bar"></div></div>
                    <div id="bossStats" class="small"></div>
                    <div id="bossDebuffs" class="boss-debuffs"></div>
                    <div class="bar-container"><div id="bossPlayerHpBar" class="bar hp"></div></div>
                    <div id="bossPlayerStats" class="small"></div>
                    <div id="bossLog" class="boss-log"></div>
                </div>
            </div>
            <div class="boss-actions">
                <button class="btn-combat btn-md" onclick="attack()">⚔️ Attaquer</button>
                <button class="btn-combat btn-md" onclick="useSkill()">✨ Compétence</button>
                <button class="btn-combat btn-md" onclick="potion()">🧪 Potion</button>
                <button class="btn-combat btn-md" onclick="quickStrike()">⚡ Frappe</button>
                <button class="btn-util btn-md" onclick="guard()">🛡️ Parade</button>
                <button class="btn-util btn-md" onclick="focus()">🎯 Concentration</button>
                <button class="btn-menu btn-sm" onclick="closeWorldBossScreen()">↩️ Quitter</button>
            </div>
        </div>`;
    screen.style.display = 'flex';
    requestAnimationFrame(()=>screen.classList.add('show'));
    setMainVisibility(false);
    updateWorldBossUI();
    playBossTheme();
}

function closeWorldBossScreen(){
    const screen = document.getElementById('worldBossScreen');
    if(!screen) return;
    screen.classList.remove('show');
    screen.style.display = 'none';
    screen.innerHTML = '';
    worldBossActive = false;
    stopBossTheme();
    setMainVisibility(true);
}

function updateWorldBossUI(){
    if(!worldBossActive || !enemy) return;
    const bossImg = document.getElementById('bossImg');
    if(bossImg) setMonsterImage('bossImg', enemy.name);
    const maxHpTotal = player.maxHp + getBonusHp();
    const bossHp = document.getElementById('bossHpBar');
    const bossStats = document.getElementById('bossStats');
    const playerHp = document.getElementById('bossPlayerHpBar');
    const playerStats = document.getElementById('bossPlayerStats');
    const phaseLabel = document.getElementById('bossPhaseLabel');
    const debuffs = document.getElementById('bossDebuffs');
    if(bossHp) bossHp.style.width = clamp(enemy.hp/enemy.maxHp*100,0,100)+'%';
    if(bossStats) bossStats.textContent = `👹 ${enemy.name} HP ${enemy.hp}/${enemy.maxHp} | ATK ${enemy.atk}`;
    if(playerHp) playerHp.style.width = clamp(player.hp/maxHpTotal*100,0,100)+'%';
    if(playerStats) playerStats.textContent = `👤 ${player.class} HP ${player.hp}/${maxHpTotal} | ATK ${getAtk()} | DEF ${getDef()}`;
    if(phaseLabel) phaseLabel.textContent = String(Math.max(1, worldBossPhase+1));
    if(debuffs){
        const map = {
            fragilite:'🪓',
            malediction:'☠️',
            saignement:'🩸',
            epuisement:'🥀'
        };
        const list = (player.debuffs || []);
        debuffs.innerHTML = list.length
            ? list.map(d=>`<span class="debuff-chip">${map[d.id]||'⚠️'} ${d.name} (${d.turns})</span>`).join('')
            : `<span class="debuff-chip">✅ Aucun débuff</span>`;
    }
}

function renderFactions(){
    currentMenu = 'factions';
    const m = document.getElementById('menu');
    m.innerHTML = `<h3>🏛️ Factions</h3>
        <div class="small">Bonus actifs: ${applyFactionPerks().label}</div>`;
    Object.keys(factions).forEach(name=>{
        const rep = factions[name];
        const rank = getFactionRank(rep);
        m.innerHTML += `<div class="talent-row">
            <div class="small">${name}: ${rep} (${rank})</div>
            <button class="item-btn" data-no-hover="1" onclick="npcFaction('${name}')">Détails</button>
        </div>`;
    });
    m.innerHTML += `<div class="small">Les quêtes augmentent ta réputation.</div>`;
}

function triggerRandomEvent(source){
    const chance = source==='dungeon' ? 0.12 : 0.18;
    if(Math.random() > chance) return;
    const write = source==='dungeon' ? dungeonLog : log;
    const roll = Math.random();
    if(roll < 0.25){
        const g = 8 + Math.floor(Math.random()*12);
        player.gold += g;
        write(`✨ Événement: tu trouves une bourse (+${g} or)`);
    } else if(roll < 0.5){
        const heal = 8 + Math.floor(Math.random()*10);
        const maxHpTotal = player.maxHp + getBonusHp();
        player.hp = Math.min(maxHpTotal, player.hp + heal);
        write(`✨ Événement: source mystique (+${heal} PV)`);
    } else if(roll < 0.75){
        const loss = Math.min(player.gold, 6 + Math.floor(Math.random()*10));
        player.gold -= loss;
        write(`✨ Événement: pickpocket (-${loss} or)`);
    } else {
        const item = generateItem();
        addLoot(item);
        write(`✨ Événement: trésor trouvé (${item.name})`);
    }
}

function applyLifesteal(dmg){
    const weapon = player.equipment.weapon;
    const amulet = player.equipment.amulet;
    const effect = (weapon?.effect?.lifesteal || 0) + (amulet?.effect?.lifesteal || 0) + getArtifactLifesteal();
    if(effect>0){
        const heal = Math.max(1, Math.floor(dmg * effect));
        const maxHpTotal = player.maxHp + getBonusHp();
        player.hp = Math.min(maxHpTotal, player.hp + heal);
        if(inDungeon) dungeonLog(`🩸 Vol de vie: +${heal} PV`);
        else log(`🩸 Vol de vie: +${heal} PV`);
    }
}

function companionStrike(target){
    if(!player.companion || !target) return;
    const chance = 0.35;
    if(Math.random() > chance) return;
    const dmg = Math.max(1, Math.floor(player.companion.atk + player.level*0.5));
    target.hp -= dmg;
    if(inDungeon) dungeonLog(`🐾 ${player.companion.name} frappe (${dmg})`);
    else log(`🐾 ${player.companion.name} frappe (${dmg})`);
}

// ===== LOOT & WIN =====
function winCombat(isDungeon){
    const foe = isDungeon ? dungeonEnemy : enemy;
    if(foe.type==='worldBoss'){
        log(`🌌 Boss mondial vaincu: ${foe.name} !`);
        showToast('Victoire', 'Boss mondial vaincu !');
        grantXP(120);
        grantGold(120);
        worldBoss = null;
        worldBossPhase = 0;
        closeWorldBossScreen();
        enemy = initEnemy(player.level);
        updateUI();
        return;
    }
    const xpGain = Math.floor((12 + player.level*4 + (foe.type==='boss'?20:0)) * currentZone.rewardMult);
    grantXP(xpGain);
    const goldGain = Math.floor((6 + player.level*2 + (foe.type==='boss'?15:0)) * currentZone.rewardMult);
    grantGold(goldGain);
    if(isDungeon){
        dungeonLog(`✅ ${foe.name} vaincu ! +${xpGain} XP`);
    } else {
        log(`✅ ${foe.name} vaincu ! +${xpGain} XP`);
    }
    applyQuestProgress({kills:1, boss:foe.type==='boss', zoneId:currentZone.id});

    const dropChance = (isDungeon ? 0.88 : 0.7) + getLuckBonus() + getEventLootBonus() + getArtifactLoot();
    if(Math.random() < clamp(dropChance,0,0.99)){
        if(Math.random() < 0.6){
            const item = generateItem();
            addLoot(item);
            const msg = `🧰 Équipement: ${item.name} (${item.type})`;
            if(isDungeon) dungeonLog(msg); else log(msg);
        } else {
            const drop = generateDrop();
            addDrop(drop);
            const msg = `🎁 Drop: ${drop.name} x${drop.qty} [${drop.rarity}]`;
            if(isDungeon) dungeonLog(msg); else log(msg);
        }
    }

    if(isDungeon){
        dungeonEnemy = null;
        dungeonRoomCleared = true;
        if(inArena){
            dungeonLog('➡️ Vague nettoyée. Tu peux avancer.');
        } else {
            dungeonLog('➡️ Salle nettoyée. Tu peux avancer.');
        }
        updateDungeonUI();
    } else {
        enemy = initEnemy(player.level);
    }
    updateBestiary(foe.name, foe.type);
    if(foe.isZoneBoss) unlockAchievement('boss_hunter');
    if(foe.isZoneBoss && foe.artifact){
        player.defeatedBosses.push(foe.name);
        unlockArtifact(foe.artifact);
    }
    triggerRandomEvent(isDungeon ? 'dungeon' : 'world');
    updateUI();
    saveGame();
}

// ===== INVENTORY =====
let inventoryOpen=false;
let equipSort = 'power';
let classChosen=false;
let currentMenu=null;
let respawnBonus = {hp:0, atk:0, potions:0, label:''};
let settings = {music:70, sfx:80, animSpeed:1, floatTexts:true};
let factions = {Explorateurs:0, Arcanes:0, Chasseurs:0};
function closeMenu(){
    const m=document.getElementById('menu');
    if(m) m.innerHTML='';
    currentMenu = null;
    inventoryOpen = false;
    equipmentOpen = false;
    statsOpen = false;
}
function toggleMenu(key, renderFn){
    if(currentMenu===key){
        closeMenu();
        return;
    }
    currentMenu = key;
    inventoryOpen = key==='inventory';
    equipmentOpen = key==='equipment';
    statsOpen = key==='stats';
    renderFn();
}
function toggleInventory(){
    toggleMenu('inventory', renderInventory);
}
function renderInventory(){
    currentMenu = 'inventory';
    const m=document.getElementById('menu');
    m.innerHTML='<h3>🎒 Inventaire (Drops)</h3>';
    const drops = player.inventory.drops;
    if(drops.length===0){
        m.innerHTML+='<div class="small">Aucun drop pour le moment.</div>';
        return;
    }
    drops.forEach(d=>{
        m.innerHTML+=`<button class="item-btn" style="color:${rarityColor(d.rarity)}">${d.name} x${d.qty} [${d.rarity}]</button>`;
    });
}

// ===== EQUIPMENT =====
let equipmentOpen=false;
function toggleEquipment(){
    toggleMenu('equipment', renderEquipment);
}
function renderEquipment(){
    currentMenu = 'equipment';
    const m = document.getElementById('menu');
    m.innerHTML = '<h3>⚙️ Équipement</h3>';
    m.innerHTML += `<button class="item-btn" onclick="autoEquip()">Auto-équiper (meilleur)</button>`;
    const slots = [
        {slot:'weapon', label:'🗡️ Arme'},
        {slot:'armor', label:'🛡️ Armure'},
        {slot:'helmet', label:'🪖 Casque'},
        {slot:'ring', label:'💍 Bague'},
        {slot:'amulet', label:'📿 Amulette'}
    ];
    slots.forEach(s=>{
        const item = player.equipment[s.slot];
        if(item){
            const stat = item.atk?`+${item.atk} ATK`:(item.def?`+${item.def} DEF`:`+${item.hp} PV`);
            m.innerHTML += `<button class="item-btn" style="color:${rarityColor(item.rarity)}" onclick="showEquipList('${s.slot}')">${s.label}: ${item.name} (${stat}) [${item.rarity}]</button>`;
        } else {
            m.innerHTML += `<button class="item-btn" onclick="showEquipList('${s.slot}')">${s.label}: Vide</button>`;
        }
    });
}
function showEquipList(slot){
    currentMenu = 'equipment';
    const m = document.getElementById('menu');
    const label =
        slot==='weapon' ? '🗡️ Arme' :
        slot==='armor' ? '🛡️ Armure' :
        slot==='helmet' ? '🪖 Casque' :
        slot==='ring' ? '💍 Bague' :
        '📿 Amulette';
    m.innerHTML = `<h3>⚙️ Équipement – ${label}</h3>
        <div class="small">Tri:</div>
        <button class="item-btn" onclick="setEquipSort('power','${slot}')">Puissance</button>
        <button class="item-btn" onclick="setEquipSort('rarity','${slot}')">Rareté</button>
        <button class="item-btn" onclick="setEquipSort('name','${slot}')">Nom</button>`;

    const list =
        slot==='weapon' ? player.inventory.weapons :
        slot==='armor' ? player.inventory.armors :
        slot==='helmet' ? player.inventory.helmets :
        slot==='ring' ? player.inventory.rings :
        player.inventory.amulets;

    const sorted = sortEquipList(list);
    if(sorted.length===0){
        m.innerHTML += '<div class="small">Aucun objet pour ce slot.</div>';
    } else {
        sorted.forEach(({it, i})=>{
            const stat = it.atk?`+${it.atk} ATK`:(it.def?`+${it.def} DEF`:`+${it.hp} PV`);
            const fn =
                slot==='weapon' ? `equipWeapon(${i})` :
                slot==='armor' ? `equipArmor(${i})` :
                slot==='helmet' ? `equipHelmet(${i})` :
                slot==='ring' ? `equipRing(${i})` :
                `equipAmulet(${i})`;
            m.innerHTML += `<button class="item-btn" style="color:${rarityColor(it.rarity)}" onclick="${fn}">${it.name} (${stat}) [${it.rarity}]</button>`;
        });
    }
    m.innerHTML += `<button class="item-btn" onclick="renderEquipment()">⬅️ Retour</button>`;
}
function renderCrafting(){
    currentMenu = 'crafting';
    const m = document.getElementById('menu');
    m.innerHTML = `<h3>🛠️ Artisanat</h3>
        <div class="small">Recettes disponibles</div>`;

    const canEquip = getDropQty('Essence néon')>=3 && getDropQty('Fragment cristallin')>=2;
    const canPotions = getDropQty('Poussière astrale')>=2 && getDropQty('Cendre arcanique')>=1;

    m.innerHTML += `<div class="talent-row">
        <div class="small">Équipement aléatoire (3 Essence néon + 2 Fragment cristallin)</div>
        <button class="item-btn" data-no-hover="1" ${canEquip?'':'disabled'} onclick="craftEquipment()">Fabriquer</button>
    </div>`;
    m.innerHTML += `<div class="talent-row">
        <div class="small">Potions x2 (2 Poussière astrale + 1 Cendre arcanique)</div>
        <button class="item-btn" data-no-hover="1" ${canPotions?'':'disabled'} onclick="craftPotions()">Fabriquer</button>
    </div>`;
}
function craftEquipment(){
    if(!spendDropByName('Essence néon',3)) return;
    if(!spendDropByName('Fragment cristallin',2)) return;
    const item = generateItem();
    addLoot(item);
    log(`🛠️ Artisanat: ${item.name} (${item.type})`);
    renderCrafting();
    saveGame();
}
function craftPotions(){
    if(!spendDropByName('Poussière astrale',2)) return;
    if(!spendDropByName('Cendre arcanique',1)) return;
    player.potions += 2;
    log('🛠️ Artisanat: +2 potions');
    updateUI();
    renderCrafting();
    saveGame();
}
function renderUpgrade(){
    currentMenu = 'upgrade';
    const m = document.getElementById('menu');
    m.innerHTML = `<h3>⬆️ Amélioration</h3>
        <div class="small">Coût: 2 Essence néon + 1 Fragment cristallin</div>`;
    const can = getDropQty('Essence néon')>=2 && getDropQty('Fragment cristallin')>=1;
    const slots = [
        {slot:'weapon', label:'🗡️ Arme'},
        {slot:'armor', label:'🛡️ Armure'},
        {slot:'helmet', label:'🪖 Casque'},
        {slot:'ring', label:'💍 Bague'},
        {slot:'amulet', label:'📿 Amulette'}
    ];
    slots.forEach(s=>{
        const item = player.equipment[s.slot];
        if(!item) return;
        const stat = item.atk?`+${item.atk} ATK`:(item.def?`+${item.def} DEF`:`+${item.hp} PV`);
        m.innerHTML += `<button class="item-btn" ${can?'':'disabled'} onclick="upgradeItem('${s.slot}')">${s.label}: ${item.name} (${stat})</button>`;
    });
}
function upgradeItem(slot){
    if(!spendDropByName('Essence néon',2)) return;
    if(!spendDropByName('Fragment cristallin',1)) return;
    const item = player.equipment[slot];
    if(!item) return;
    if(slot==='amulet'){
        item.hp = (item.hp || 0) + 10;
    } else if(item.atk){
        item.atk += 1;
    } else if(item.def){
        item.def += 1;
    }
    log(`⬆️ Amélioration: ${item.name}`);
    updateUI();
    renderUpgrade();
    saveGame();
}
function renderConsumables(){
    currentMenu = 'consumables';
    const m = document.getElementById('menu');
    m.innerHTML = `<h3>🧪 Consommables</h3>`;
    const essence = getDropQty('Essence néon');
    const astral = getDropQty('Poussière astrale');
    if(essence===0 && astral===0){
        m.innerHTML += '<div class="small">Aucun consommable disponible.</div>';
        return;
    }
    if(essence>0){
        m.innerHTML += `<button class="item-btn" onclick="useDropHeal('Essence néon',10)">Essence néon (Soigne 10)</button>`;
    }
    if(astral>0){
        m.innerHTML += `<button class="item-btn" onclick="useDropHeal('Poussière astrale',15)">Poussière astrale (Soigne 15)</button>`;
    }
}

// ===== SPECIALISATIONS =====
const SPEC_CURVE = {
    heavy:{atk:[3,4,5,6,7], hp:[18,22,26,30,34], mult:[2.2,2.5,2.8,3.1,3.4]},
    tank:{atk:[2,3,4,5,6], hp:[22,26,30,34,38], mult:[2.0,2.3,2.6,2.9,3.2]},
    balanced:{atk:[3,4,5,6,7], hp:[12,16,20,24,28], mult:[2.2,2.5,2.8,3.1,3.4]},
    ranged:{atk:[4,5,6,7,8], hp:[8,12,16,18,20], mult:[2.3,2.6,2.9,3.2,3.5]},
    burst:{atk:[5,6,7,8,9], hp:[6,8,10,12,14], mult:[2.6,2.9,3.2,3.5,3.8]}
};
function makeSpecs(className, theme, names, skillNames){
    const levels = [10,15,20,25,30];
    const curve = SPEC_CURVE[theme] || SPEC_CURVE.balanced;
    const out = [];
    for(let i=0;i<levels.length;i++){
        out.push({
            name:names[i],
            level:levels[i],
            atk:curve.atk[i],
            hp:curve.hp[i],
            skill:{name:skillNames[i], mult:curve.mult[i], maxCd: i<2 ? 3 : 4 + (i===4?1:0)}
        });
    }
    return out;
}
const SPECIALIZATIONS = {
    Guerrier:makeSpecs('Guerrier','heavy',
        ['Berserker','Templier','Maître d’armes','Brise-ligne','Légionnaire'],
        ['Rage sanglante','Jugement','Assaut','Percée','Ultimatum']
    ),
    Mage:makeSpecs('Mage','burst',
        ['Pyromancien','Cryomancien','Sorcier astral','Évocateur','Archimage'],
        ['Explosion','Gel profond','Nova','Cataclysme','Singularité']
    ),
    Archer:makeSpecs('Archer','ranged',
        ['Sniper','Rôdeur','Chasseur d’élite','Faucon','Sage-vent'],
        ['Tir perforant','Salve','Volée','Barrage','Tempête']
    ),
    Seigneur:makeSpecs('Seigneur','tank',
        ['Suzerain','Régent','Souverain','Conquérant','Titan du trône'],
        ['Marteau d’honneur','Déferlante','Coup d’éclat','Brisure','Apothéose']
    ),
    Roi:makeSpecs('Roi','balanced',
        ['Roi-chevalier','Monarque d’acier','Roi solaire','Roi céleste','Roi immortel'],
        ['Ordre royal','Lame du trône','Couronne ardente','Zénith','Décret ultime']
    ),
    Dresseur:makeSpecs('Dresseur','balanced',
        ['Meneur','Dominateur','Alpha','Seigneur des bêtes','Mythe animal'],
        ['Morsure coordonnée','Meute','Ravage','Totem sauvage','Apogée']
    ),
    Druide:makeSpecs('Druide','heavy',
        ['Gardien des bois','Héraut des saisons','Sage sylvestre','Oracle des forêts','Avatar naturel'],
        ['Épines','Givre floral','Tempête racinaire','Cycle ancien','Équinoxe']
    ),
    Assassin:makeSpecs('Assassin','burst',
        ['Lame noire','Silencieux','Nuit rouge','Spectre','Exécuteur'],
        ['Coup létal','Saignée','Finisseurs','Linceul','Mort instantanée']
    )
};
function renderSpecialization(){
    currentMenu = 'specialization';
    const m = document.getElementById('menu');
    if(player.level < 10){
        m.innerHTML = `<h3>⚔️ Spécialisation</h3><div class="small">Disponible au niveau 10 (puis plus d’options aux niveaux 15 et 20).</div>`;
        return;
    }
    if(player.specialization){
        m.innerHTML = `<h3>⚔️ Spécialisation</h3>
            <div class="small">Déjà choisi: ${player.specialization.name}</div>`;
        return;
    }
    const list = SPECIALIZATIONS[player.class] || [];
    m.innerHTML = `<h3>⚔️ Spécialisation</h3>`;
    list.forEach((s,i)=>{
        const locked = player.level < s.level;
        const label = locked ? `${s.name} (Nv ${s.level})` : s.name;
        m.innerHTML += `<button class="item-btn" ${locked?'disabled':''} onclick="chooseSpecialization(${i})">${label} (+${s.atk} ATK, +${s.hp} PV)</button>`;
    });
}
function chooseSpecialization(i){
    if(player.specialization) return;
    const list = SPECIALIZATIONS[player.class] || [];
    const s = list[i];
    if(!s) return;
    if(player.level < (s.level || 10)) return;
    player.specialization = s;
    player.skill.name = s.skill.name;
    player.skill.mult = s.skill.mult;
    player.skill.maxCd = s.skill.maxCd;
    log(`⚔️ Spécialisation choisie: ${s.name}`);
    updateUI();
    saveGame();
}

// ===== COMPANIONS =====
const COMPANIONS = [
    {name:'Loup cendré', atk:3, price:40},
    {name:'Faucon', atk:4, price:60},
    {name:'Golem de pierre', atk:5, price:80}
];
function renderCompanion(){
    currentMenu = 'companion';
    const m = document.getElementById('menu');
    if(player.companion){
        m.innerHTML = `<h3>🐾 Compagnon</h3>
            <div class="small">Actuel: ${player.companion.name} (ATK ${player.companion.atk})</div>`;
        return;
    }
    m.innerHTML = `<h3>🐾 Compagnon</h3>`;
    COMPANIONS.forEach((c,i)=>{
        m.innerHTML += `<button class="item-btn" ${player.gold>=c.price?'':'disabled'} onclick="recruitCompanion(${i})">${c.name} — ${c.price} or</button>`;
    });
}
function recruitCompanion(i){
    const c = COMPANIONS[i];
    if(!c) return;
    if(!spendGold(c.price)) return;
    player.companion = {...c};
    log(`🐾 Compagnon recruté: ${c.name}`);
    updateUI();
    renderCompanion();
    saveGame();
}

// ===== FORGE =====
function renderForge(){
    currentMenu = 'forge';
    const m = document.getElementById('menu');
    m.innerHTML = `<h3>⚒️ Forge</h3>
        <div class="small">Enchanter une pièce équipée (coût: 2 Fragment cristallin + 20 or)</div>`;
    const slots = [
        {slot:'weapon', label:'🗡️ Arme'},
        {slot:'armor', label:'🛡️ Armure'},
        {slot:'helmet', label:'🪖 Casque'},
        {slot:'ring', label:'💍 Bague'},
        {slot:'amulet', label:'📿 Amulette'}
    ];
    slots.forEach(s=>{
        const item = player.equipment[s.slot];
        if(!item) return;
        m.innerHTML += `<div class="talent-row">
            <div class="small">${s.label}: ${item.name}</div>
            <button class="item-btn" data-no-hover="1" onclick="enchantItem('${s.slot}')">Améliorer</button>
        </div>`;
    });
}

// ===== ARTEFACTS =====
function renderArtifacts(){
    currentMenu = 'artifacts';
    const m = document.getElementById('menu');
    const icons = {
        'Totem du Chef':'🗿',
        'Graine de Sylve':'🌿',
        'Cœur de Brume':'🌫️',
        'Couronne de Braise':'🔥',
        'Éclat polaire':'❄️',
        'Œil Astral':'🔮',
        'Cœur du Néant':'🕳️'
    };
    function artifactStats(a){
        const parts = [];
        if(a.atk) parts.push(`+${a.atk} ATK`);
        if(a.hp) parts.push(`+${a.hp} PV`);
        if(a.loot) parts.push(`+${Math.round(a.loot*100)}% loot`);
        if(a.lifesteal) parts.push(`+${Math.round(a.lifesteal*100)}% vol de vie`);
        return parts.length ? parts.join(', ') : 'Aucun bonus';
    }
    const equippedLabel = player.artifact ? `${player.artifact.name} (${artifactStats(player.artifact)})` : 'Aucun';
    m.innerHTML = `<h3>✨ Artefacts</h3>
        <div class="small">Équipé: ${equippedLabel}</div>
        <div class="small">Uniques: ${player.artifacts.length}</div>`;
    if(player.artifacts.length){
        player.artifacts.forEach((a,i)=>{
            const icon = icons[a.name] || '✨';
            m.innerHTML += `<button class="item-btn" onclick="equipArtifact(${i})">${icon} ${a.name}</button>
                <div class="small">${artifactStats(a)}</div>`;
        });
    } else {
        m.innerHTML += `<div class="small">Aucun artefact pour le moment.</div>`;
    }
}

function unlockArtifact(artifact){
    if(player.artifacts.find(a=>a.id===artifact.id)) return;
    player.artifacts.push(artifact);
    log(`🏺 Artefact obtenu: ${artifact.name}`);
}

function equipArtifact(i){
    const a = player.artifacts[i];
    if(!a) return;
    player.artifact = a;
    log(`✨ Artefact équipé: ${a.name}`);
    updateUI();
    renderArtifacts();
    saveGame();
}
function enchantItem(slot){
    if(!spendDropByName('Fragment cristallin',2)) return;
    if(!spendGold(20)) return;
    const item = player.equipment[slot];
    if(!item) return;
    if(slot==='amulet'){item.hp = (item.hp||0) + 6;}
    else if(item.atk){item.atk += 2;}
    else if(item.def){item.def += 2;}
    log(`⚒️ Enchantement: ${item.name}`);
    updateUI();
    renderForge();
    saveGame();
}
// ===== TALENTS =====
const TALENTS = {
    strength:{name:'Force', desc:'+1 ATK par point', max:10},
    vitality:{name:'Vitalité', desc:'+5 PV max par point', max:10},
    alchemy:{name:'Alchimie', desc:'+2 soin potion par point', max:10},
    luck:{name:'Chance', desc:'+2% loot par point', max:10}
};
function renderTalents(){
    currentMenu = 'talents';
    const m = document.getElementById('menu');
    m.innerHTML = `<h3>✨ Talents</h3>
        <div class="small">Points disponibles: ${player.talentPoints}</div>`;
    Object.entries(TALENTS).forEach(([key, t])=>{
        const val = player.talents[key] || 0;
        const can = player.talentPoints > 0 && val < t.max;
        m.innerHTML += `
            <div class="talent-row">
                <div class="small">${t.name}: ${val}/${t.max} — ${t.desc}</div>
                <button class="item-btn" data-no-hover="1" ${can?'':'disabled'} onclick="upgradeTalent('${key}')">Améliorer</button>
            </div>`;
    });
}
function upgradeTalent(key){
    if(player.talentPoints <= 0) return;
    const t = TALENTS[key];
    if(!t) return;
    if(player.talents[key] >= t.max) return;
    player.talentPoints--;
    player.talents[key] += 1;
    log(`✨ Talent amélioré: ${t.name}`);
    updateUI();
    renderTalents();
    saveGame();
}

// ===== PNJ =====
const NPCS = [
    {name:'Eira la Guide', line:'Les ruines cachent des secrets anciens.'},
    {name:'Brann le Forgeron', line:'Une bonne lame change le destin.'},
    {name:'Sélène l’Oracle', line:'Écoute les murmures du vent.'}
];
const FACTION_NPCS = {
    Explorateurs:{name:'Kael le Cartographe', line:'Les routes sûres valent de l’or.'},
    Arcanes:{name:'Lyra l’Alchimiste', line:'Chaque essence a un prix.'},
    Chasseurs:{name:'Doran le Traqueur', line:'Je lis les traces comme un livre.'}
};
function renderNPC(){
    currentMenu = 'npc';
    const m = document.getElementById('menu');
    const npc = NPCS[Math.floor(Math.random()*NPCS.length)];
    const factionList = [
        {name:'Explorateurs', line:FACTION_NPCS.Explorateurs.line},
        {name:'Arcanes', line:FACTION_NPCS.Arcanes.line},
        {name:'Chasseurs', line:FACTION_NPCS.Chasseurs.line}
    ];
    m.innerHTML = `<h3>🧙 PNJ</h3>
        <div class="small"><b>${npc.name}:</b> ${npc.line}</div>
        <div class="small">Contacts de factions:</div>
        ${factionList.map(f=>`<div class="small"><b>${FACTION_NPCS[f.name].name}:</b> ${f.line}</div>`).join('')}
        <div class="small">Actions de factions:</div>
        ${factionList.map(f=>`<div class="talent-row">
            <div class="small">${f.name}</div>
            <button class="item-btn" data-no-hover="1" onclick="npcFaction('${f.name}')">Voir</button>
        </div>`).join('')}
        <div class="talent-row">
            <div class="small">Rumeur</div>
            <button class="item-btn" data-no-hover="1" onclick="npcRumor()">Demander</button>
        </div>
        <div class="talent-row">
            <div class="small">Bénédiction (10 or)</div>
            <button class="item-btn" data-no-hover="1" onclick="npcHeal()">Recevoir</button>
        </div>
        <div class="talent-row">
            <div class="small">Nouvelle quête</div>
            <button class="item-btn" data-no-hover="1" onclick="npcQuest()">Obtenir</button>
        </div>`;
}
function npcRumor(){
    const hints = [
        'Les coffres des donjons sont plus généreux.',
        'La chance favorise les audacieux.',
        'Les Abysses réclament un grand niveau.'
    ];
    const hint = hints[Math.floor(Math.random()*hints.length)];
    log(`🗣️ Rumeur: ${hint}`);
}
function npcHeal(){
    if(!spendGold(10)) return;
    const maxHpTotal = player.maxHp + getBonusHp();
    player.hp = Math.min(maxHpTotal, player.hp + 20);
    log('✨ Bénédiction reçue (+20 PV)');
    updateUI();
    renderNPC();
    saveGame();
}
function npcQuest(){
    const i = Math.floor(Math.random()*quests.length);
    replaceQuestAt(i);
    log('📜 Une nouvelle quête t’a été donnée.');
    updateUI();
    renderNPC();
    saveGame();
}

function npcFaction(name){
    const rep = factions[name] || 0;
    const rank = getFactionRank(rep);
    log(`🏛️ ${name} — Réputation ${rank} (${rep})`);
    if(name==='Explorateurs' && rep>=25){
        log('🧭 Bonus: accès à cartes rares (loot +)');
    }
    if(name==='Arcanes' && rep>=25){
        log('🔮 Bonus: alchimie renforcée');
    }
    if(name==='Chasseurs' && rep>=25){
        log('🏹 Bonus: dégâts améliorés');
    }
}

// ===== SHOP =====
function renderShop(){
    currentMenu = 'shop';
    const m = document.getElementById('menu');
    m.innerHTML = `<h3>🏪 Marchand</h3>
        <div class="small">Or: ${player.gold}</div>`;
    const potionPrice = 15;
    const equipPrice = 40;
    m.innerHTML += `<button class="item-btn" ${player.gold>=potionPrice?'':'disabled'} onclick="buyPotion()">Acheter potion (+1) — ${potionPrice} or</button>`;
    m.innerHTML += `<button class="item-btn" ${player.gold>=equipPrice?'':'disabled'} onclick="buyRandomEquip()">Acheter équipement aléatoire — ${equipPrice} or</button>`;
    m.innerHTML += `<button class="item-btn" onclick="buyLegendary()">Échange légendaire (10 Fragment cristallin)</button>`;
    if(player.inventory.drops.length===0){
        m.innerHTML += `<div class="small">Aucun drop à vendre.</div>`;
    } else {
        m.innerHTML += `<div class="small">Vendre des drops:</div>`;
        player.inventory.drops.forEach((d,i)=>{
            const value = d.rarity==='Commun' ? 3 : d.rarity==='Rare' ? 6 : 10;
            m.innerHTML += `<button class="item-btn" onclick="sellDrop(${i})">Vendre ${d.name} x${d.qty} [${d.rarity}] — ${value*d.qty} or</button>`;
        });
    }
}
function buyPotion(){
    if(!spendGold(15)) return;
    player.potions += 1;
    log('🧪 Potion achetée');
    updateUI();
    renderShop();
    saveGame();
}
function buyRandomEquip(){
    if(!spendGold(40)) return;
    const item = generateItem();
    addLoot(item);
    log(`🧰 Achat: ${item.name} (${item.type})`);
    updateUI();
    renderShop();
    saveGame();
}
function buyLegendary(){
    if(!spendDropByName('Fragment cristallin',10)) return;
    const item = generateItem();
    item.rarity = 'Légendaire';
    item.name = item.name.replace(/Commun|Rare|Épique|Légendaire/, 'Légendaire');
    item.effect = item.effect || {lifesteal:0.1};
    addLoot(item);
    log(`✨ Légendaire obtenu: ${item.name}`);
    updateUI();
    renderShop();
    saveGame();
}
function sellDrop(i){
    const d = player.inventory.drops[i];
    if(!d) return;
    const value = d.rarity==='Commun' ? 3 : d.rarity==='Rare' ? 6 : 10;
    const total = value * d.qty;
    player.inventory.drops.splice(i,1);
    player.gold += total;
    log(`💰 Vendu: ${d.name} x${d.qty} (+${total} or)`);
    updateUI();
    renderShop();
    saveGame();
}
function useDropHeal(name, amount){
    if(!spendDropByName(name,1)) return;
    const maxHpTotal = player.maxHp + getBonusHp();
    player.hp = Math.min(maxHpTotal, player.hp + amount);
    log(`🧪 ${name} utilisée (+${amount} PV)`);
    updateUI();
    renderConsumables();
    saveGame();
}
function setEquipSort(mode, slot){
    equipSort = mode;
    showEquipList(slot);
}
function rarityScore(r){
    return r==='Commun' ? 1 : r==='Rare' ? 2 : 3;
}
function sortEquipList(list){
    const mapped = list.map((it,i)=>({it,i}));
    if(equipSort==='name'){
        return mapped.sort((a,b)=>a.it.name.localeCompare(b.it.name));
    }
    if(equipSort==='rarity'){
        return mapped.sort((a,b)=>rarityScore(b.it.rarity)-rarityScore(a.it.rarity));
    }
    return mapped.sort((a,b)=>{
        const aVal = a.it.atk ?? a.it.def ?? a.it.hp ?? 0;
        const bVal = b.it.atk ?? b.it.def ?? b.it.hp ?? 0;
        return bVal - aVal;
    });
}

// ===== EQUIP FUNCTIONS =====
function equipWeapon(i){player.equipment.weapon = player.inventory.weapons[i]; log(`🗡️ Arme équipée : ${player.equipment.weapon.name}`); updateUI(); renderEquipment();}
function equipArmor(i){player.equipment.armor = player.inventory.armors[i]; log(`🛡️ Armure équipée : ${player.equipment.armor.name}`); updateUI(); renderEquipment();}
function equipHelmet(i){player.equipment.helmet = player.inventory.helmets[i]; log(`🪖 Casque équipé : ${player.equipment.helmet.name}`); updateUI(); renderEquipment();}
function equipRing(i){player.equipment.ring = player.inventory.rings[i]; log(`💍 Bague équipée : ${player.equipment.ring.name}`); updateUI(); renderEquipment();}
function equipAmulet(i){player.equipment.amulet = player.inventory.amulets[i]; log(`📿 Amulette équipée : ${player.equipment.amulet.name}`); updateUI(); renderEquipment();}

function autoEquip(){
    const best = {
        weapon: pickBest(player.inventory.weapons, 'weapon'),
        armor: pickBest(player.inventory.armors, 'armor'),
        helmet: pickBest(player.inventory.helmets, 'helmet'),
        ring: pickBest(player.inventory.rings, 'ring'),
        amulet: pickBest(player.inventory.amulets, 'amulet')
    };
    let changed = false;
    Object.keys(best).forEach(slot=>{
        if(best[slot]){
            player.equipment[slot] = best[slot];
            changed = true;
        }
    });
    if(changed){
        log('⚙️ Auto-équipement effectué.');
        updateUI();
        renderEquipment();
        saveGame();
    } else {
        log('⚙️ Aucun équipement à auto-équiper.');
    }
}

function pickBest(list, slot){
    if(!list || list.length===0) return null;
    return list.reduce((best, it)=>{
        if(!best) return it;
        return scoreItem(it, slot) > scoreItem(best, slot) ? it : best;
    }, null);
}

function scoreItem(it, slot){
    const base = it.atk ?? it.def ?? it.hp ?? 0;
    const rarity = it.rarity==='Commun' ? 1 : it.rarity==='Rare' ? 2 : it.rarity==='Épique' ? 3 : 4;
    const effect = it.effect ? 2 : 0;
    const slotBias = slot==='weapon' ? 1.2 : slot==='amulet' ? 1.05 : 1;
    return base * slotBias + rarity + effect;
}

// ===== STATS =====
let statsOpen=false;
function showStats(){
    if(!classChosen){return;}
    toggleMenu('stats', renderStatsMenu);
}
function renderStatsMenu(){
    currentMenu = 'stats';
    const m=document.getElementById('menu');
    const hpPercent=player.hp/player.maxHp*100;
    const xpPercent=player.xp/(player.level*XP_PER_LEVEL)*100;
    m.innerHTML=`<div class="stats-menu">
        <h3>👤 ${player.class} – Niveau ${player.level}</h3>
        <div>PV: ${player.hp}/${player.maxHp}</div>
        <div class="bar-container"><div class="bar hp" style="width:${hpPercent}%"></div></div>
        <div>XP: ${player.xp}/${player.level*XP_PER_LEVEL}</div>
        <div class="bar-container"><div class="bar xp" style="width:${xpPercent}%"></div></div>
        <div>ATK: ${getAtk()}</div>
        <div>DEF: ${getDef()}</div>
        <div>Potions: ${player.potions}</div>
        <div>Classe: ${player.class}</div>
        <div>Spécialisation: ${player.specialization?player.specialization.name:'Aucune'}</div>
        <div>Compagnon: ${player.companion?player.companion.name:'Aucun'}</div>
        <div>Quêtes actives: ${quests.length}</div>
        ${quests[0] ? `<div>Quête principale: ${quests[0].name}</div>` : ''}
        ${respawnBonus.label ? `<div class="small">Bonus de retour: ${respawnBonus.label}</div>` : ''}
        </div>`;
}

// ===== ACTIONS =====
document.getElementById('actions').innerHTML=
`<button id="btnAttack" class="primary-action btn-combat btn-lg" onclick="attack()">⚔️ Attaquer</button>
 <button id="btnSkill" class="primary-action btn-combat btn-lg" onclick="useSkill()">✨ Compétence</button>
 <button id="btnPotion" class="primary-action btn-combat btn-lg" onclick="potion()">🧪 Potion</button>
 <button id="btnInventory" class="btn-util btn-md" onclick="toggleInventory()">🎒 Inventaire</button>
 <button id="btnEquipment" class="btn-util btn-md" onclick="toggleEquipment()">🛡️ Équipement</button>
 <button id="btnStats" class="btn-util btn-md" onclick="showStats()">📊 Stats</button>
 <button id="btnMenuMain" class="btn-menu btn-md" onclick="toggleSecondary()">➕ Menu</button>
  `;

buildSecondaryActions();

document.getElementById('dungeonActions').innerHTML=
`<button class="btn-combat btn-md" onclick="dungeonAttack()">⚔️ Attaquer</button>
 <button class="btn-combat btn-md" onclick="dungeonSkill()">✨ Compétence</button>
 <button class="btn-combat btn-md" onclick="dungeonPotion()">🧪 Potion</button>
 <button class="btn-util btn-sm" onclick="solvePuzzle()">🧩 Énigme</button>
 <button class="btn-util btn-sm" onclick="disarmTrap()">🛠️ Désamorcer</button>
 <button class="btn-util btn-sm" onclick="nextRoom()">➡️ Salle</button>
 <button class="btn-menu btn-sm" onclick="exitDungeon()">⏏️ Quitter</button>`;

function setActionsEnabled(enabled){
    const actions = document.getElementById('actions');
    const dungeonActions = document.getElementById('dungeonActions');
    const secondary = document.getElementById('secondaryActions');
    if(actions) actions.style.display = enabled ? '' : 'none';
    if(dungeonActions) dungeonActions.style.display = enabled ? '' : 'none';
    if(secondary){
        secondary.style.display = enabled ? 'none' : 'none';
        secondary.classList.remove('show');
    }
    const dungeonBtn = document.querySelector('button[onclick="enterDungeon()"]');
    if(dungeonBtn) dungeonBtn.style.display = enabled ? '' : 'none';
}

function toggleSecondary(){
    const s = document.getElementById('secondaryActions');
    if(!s) return;
    const show = s.classList.toggle('show');
    s.style.display = show ? 'flex' : 'none';
}

function updateActionVisibility(){
    const inVillage = currentZone && currentZone.id === 'village';
    const attackBtn = document.getElementById('btnAttack');
    const skillBtn = document.getElementById('btnSkill');
    const potionBtn = document.getElementById('btnPotion');
    const invBtn = document.getElementById('btnInventory');
    const equipBtn = document.getElementById('btnEquipment');
    const statsBtn = document.getElementById('btnStats');
    const menuBtn = document.getElementById('btnMenuMain');
    const dungeonBtn = document.querySelector('button[onclick="enterDungeon()"]');
    const show = !inVillage;
    if(attackBtn) attackBtn.style.display = show ? '' : 'none';
    if(skillBtn) skillBtn.style.display = show ? '' : 'none';
    if(potionBtn) potionBtn.style.display = show ? '' : 'none';
    if(dungeonBtn) dungeonBtn.style.display = show ? '' : 'none';
    if(invBtn) invBtn.style.display = '';
    if(equipBtn) equipBtn.style.display = '';
    if(statsBtn) statsBtn.style.display = '';
    if(menuBtn) menuBtn.style.display = '';
}

function buildSecondaryActions(){
    const s = document.getElementById('secondaryActions');
    if(!s) return;
    const inVillage = currentZone && currentZone.id === 'village';
    let html = `
    <div class="action-label">Exploration</div>
    <button class="btn-combat btn-sm" onclick="fightWorldBoss()">🌌 Boss mondial</button>
    ${inVillage ? `<div class="small">Va dans une zone pour les boss de zone, l'arène et les quêtes.</div>` : `
    <button class="btn-combat btn-sm" onclick="fightZoneBoss()">👑 Boss</button>
    <button class="btn-combat btn-sm" onclick="startArena()">🏟️ Arène</button>
    <button class="btn-util btn-sm" onclick="toggleMenu('quests', renderQuestMenu)">📜 Quêtes</button>`}
    <div class="action-label">Personnage</div>
    <button class="btn-util btn-sm" onclick="toggleMenu('talents', renderTalents)">✨ Talents</button>
    <button class="btn-util btn-sm" onclick="toggleMenu('specialization', renderSpecialization)">⚔️ Spé</button>`;
    if(inVillage){
        html += `
        <div class="action-label">Services du Village</div>
        <button class="btn-service btn-sm" onclick="toggleMenu('shop', renderShop)">🏪 Marchand</button>
        <button class="btn-service btn-sm" onclick="toggleMenu('forge', renderForge)">⚒️ Forge</button>
        <button class="btn-service btn-sm" onclick="toggleMenu('crafting', renderCrafting)">🛠️ Artisanat</button>
        <button class="btn-service btn-sm" onclick="toggleMenu('companion', renderCompanion)">🐾 Compagnon</button>
        <button class="btn-service btn-sm" onclick="toggleMenu('artifacts', renderArtifacts)">✨ Artefacts</button>
        <button class="btn-service btn-sm" onclick="toggleMenu('upgrade', renderUpgrade)">⬆️ Amélioration</button>
        <button class="btn-service btn-sm" onclick="toggleMenu('consumables', renderConsumables)">🧴 Consommables</button>`;
    } else {
        html += `
        <div class="action-label">Services (au Village)</div>
        <div class="small">Va au Village pour accéder aux services.</div>`;
    }
    html += `
    <div class="action-label">Social</div>
    <button class="btn-social btn-sm" onclick="toggleMenu('npc', renderNPC)">🗣️ PNJ</button>
    <button class="btn-social btn-sm" onclick="toggleMenu('factions', renderFactions)">🏛️ Factions</button>
    <button class="btn-social btn-sm" onclick="toggleMenu('bestiary', renderBestiary)">📖 Bestiaire</button>
    <button class="btn-social btn-sm" onclick="toggleMenu('achievements', renderAchievements)">🏅 Succès</button>`;
    s.innerHTML = html;
}

// ===== DONJON =====
function buildDungeon(){
    const rooms = [];
    const pool = ['combat','combat','combat','chest','trap','puzzle','shrine','merchant'];
    rooms.push({type:pool[Math.floor(Math.random()*pool.length)]});
    rooms.push({type:pool[Math.floor(Math.random()*pool.length)]});
    rooms.push({type:'chest'});
    rooms.push({type:pool[Math.floor(Math.random()*pool.length)]});
    rooms.push({type:'boss'});
    dungeon = {level:player.level, rooms, current:0};
}
function enterDungeon(){
    if(!classChosen){return;}
    inArena = false;
    inDungeon = true;
    buildDungeon();
    document.getElementById('game').style.display='none';
    document.getElementById('dungeonUI').style.display='block';
    document.getElementById('dungeonLog').innerHTML='';
    dungeonLog('🏰 Tu entres dans le donjon.');
    loadRoom();
}
function loadRoom(){
    const room = dungeon.rooms[dungeon.current];
    dungeonRoomCleared = false;
    dungeonRoomType = room.type;
    if(room.type==='combat'){
        dungeonEnemy = initEnemy(dungeon.level, 'normal');
        dungeonLog(`👹 Un ${dungeonEnemy.name} apparaît !`);
    } else if(room.type==='boss'){
        dungeonEnemy = initEnemy(dungeon.level, 'boss');
        dungeonLog(`🔥 Boss: ${dungeonEnemy.name} te défie !`);
    } else {
        dungeonEnemy = null;
        if(room.type==='chest'){
            dungeonLog('🎁 Tu trouves un coffre...');
            const drop = generateDrop();
            addDrop(drop);
            applyQuestProgress({chests:1});
            dungeonLog(`🎁 Drop: ${drop.name} x${drop.qty} [${drop.rarity}]`);
            dungeonRoomCleared = true;
        } else if(room.type==='trap'){
            dungeonLog('⚠️ Piège! Tente de désamorcer.');
        } else if(room.type==='puzzle'){
            dungeonLog('🧩 Une énigme bloque le passage.');
        } else if(room.type==='shrine'){
            dungeonLog('✨ Sanctuaire: tu te sens plus fort.');
            const heal = 12 + player.level*2;
            player.hp = Math.min(player.maxHp + getBonusHp(), player.hp + heal);
            grantGold(5);
            dungeonRoomCleared = true;
        } else if(room.type==='merchant'){
            dungeonLog('🏪 Un marchand itinérant apparaît.');
            renderShop();
            dungeonRoomCleared = true;
        }
    }
    updateDungeonUI();
    updateUI();
    saveGame();
}

function solvePuzzle(){
    if(dungeonRoomType!=='puzzle') return;
    const success = Math.random() < 0.7;
    if(success){
        dungeonLog('✅ Énigme résolue !');
        grantXP(10);
        dungeonRoomCleared = true;
    } else {
        dungeonLog('❌ Échec... le passage reste bloqué.');
    }
    updateDungeonUI();
    updateUI();
}

function disarmTrap(){
    if(dungeonRoomType!=='trap') return;
    const success = Math.random() < 0.65;
    if(success){
        dungeonLog('✅ Piège désamorcé.');
        const drop = generateDrop();
        addDrop(drop);
        dungeonLog(`🎁 Drop: ${drop.name} x${drop.qty} [${drop.rarity}]`);
        dungeonRoomCleared = true;
    } else {
        dungeonLog('💥 Piège déclenché !');
        player.hp -= Math.max(5, Math.floor(player.level*2));
        if(player.hp<=0){
            dungeonLog('💀 Tu es mort ! Redémarrage...');
            setTimeout(restartGame,1500);
        }
    }
    updateDungeonUI();
    updateUI();
}
function nextRoom(){
    if(!dungeonRoomCleared){
        dungeonLog('⛔ Termine cette salle avant d’avancer.');
        return;
    }
    if(inArena){
        arenaWave++;
        if(arenaWave > 5){
            dungeonLog('🏆 Arène terminée ! Récompense bonus.');
            grantXP(80);
            grantGold(80);
            unlockAchievement('arena_win');
            exitDungeon();
            return;
        }
        dungeonLog(`⚔️ Vague ${arenaWave}`);
        dungeonEnemy = initEnemy(player.level + arenaWave, 'normal');
        dungeonRoomCleared = false;
        updateDungeonUI();
        return;
    }
    if(dungeon.current >= dungeon.rooms.length-1){
        dungeonLog('🏆 Donjon terminé !');
        grantXP(Math.floor((30 + dungeon.level*10) * currentZone.rewardMult));
        exitDungeon();
        return;
    }
    dungeon.current++;
    loadRoom();
}
function exitDungeon(){
    inDungeon = false;
    inArena = false;
    document.getElementById('game').style.display='block';
    document.getElementById('dungeonUI').style.display='none';
    updateUI();
}

// ===== MOBILE PANELS =====
function toggleMobilePanel(which){
    const quest = document.getElementById('questBoard');
    const map = document.getElementById('mapBoard');
    const questBtn = document.getElementById('btnQuestPanel');
    const mapBtn = document.getElementById('btnMapPanel');
    const backBtn = document.getElementById('btnBackPanel');
    if(!quest || !map || !questBtn || !mapBtn) return;
    const showQuest = which === 'quest' ? !quest.classList.contains('show') : false;
    const showMap = which === 'map' ? !map.classList.contains('show') : false;
    quest.classList.toggle('show', showQuest);
    map.classList.toggle('show', showMap);
    questBtn.classList.toggle('active', showQuest);
    mapBtn.classList.toggle('active', showMap);
    if(window.matchMedia('(max-width: 720px)').matches){
        if(showQuest || showMap){
            setMainVisibility(false);
        } else {
            setMainVisibility(true);
        }
    }
    if(backBtn){
        backBtn.style.display = (showQuest || showMap) ? 'inline-flex' : 'none';
    }
}

function closeMobilePanels(){
    const quest = document.getElementById('questBoard');
    const map = document.getElementById('mapBoard');
    const questBtn = document.getElementById('btnQuestPanel');
    const mapBtn = document.getElementById('btnMapPanel');
    const backBtn = document.getElementById('btnBackPanel');
    if(quest) quest.classList.remove('show');
    if(map) map.classList.remove('show');
    if(questBtn) questBtn.classList.remove('active');
    if(mapBtn) mapBtn.classList.remove('active');
    if(backBtn) backBtn.style.display = 'none';
    if(window.matchMedia('(max-width: 720px)').matches){
        setMainVisibility(true);
    }
}
function setMainVisibility(show){
    const game = document.getElementById('game');
    const dungeonUI = document.getElementById('dungeonUI');
    if(show){
        if(inDungeon){
            if(dungeonUI) dungeonUI.style.display = 'block';
            if(game) game.style.display = 'none';
        } else {
            if(game) game.style.display = 'block';
            if(dungeonUI) dungeonUI.style.display = 'none';
        }
    } else {
        if(game) game.style.display = 'none';
        if(dungeonUI) dungeonUI.style.display = 'none';
    }
}

// ===== ARENA =====
function startArena(){
    if(!classChosen) return;
    inArena = true;
    arenaWave = 1;
    document.getElementById('game').style.display='none';
    document.getElementById('dungeonUI').style.display='block';
    document.getElementById('dungeonLog').innerHTML='';
    dungeonLog('🏟️ Arène: survive aux vagues !');
    dungeonEnemy = initEnemy(player.level + arenaWave, 'normal');
    updateDungeonUI();
    updateUI();
}

// ===== INIT CLASS CHOICE =====
function chooseClass(){
    const classes = getClassDefs();
    const classScreen = document.getElementById('classScreen');
    const cards = classes.map((c,i)=>{
        const role = c.role || '';
        const desc = c.desc || '';
        return `
        <div class="class-card">
            <div class="class-tag">${role}</div>
            <h3 class="class-name">${c.name}</h3>
            <p class="class-desc">${desc}</p>
            <div class="class-stats">
                <span>PV ${c.hp}</span>
                <span>ATK ${c.atk}</span>
                <span>DEF ${c.def}</span>
            </div>
            <button class="class-pick" onclick="setClass(${i})">Choisir ${c.name}</button>
        </div>`;
    }).join('');
    classScreen.innerHTML = `
        <div class="modal-wrap">
            <div class="modal-glow"></div>
            <div class="class-modal">
                <h2 class="class-title">Choisis ta classe</h2>
                <p class="class-sub">Ton destin se scelle ici. Tu pourras changer plus tard, mais commence fort.</p>
                <div class="class-grid">${cards}</div>
            </div>
        </div>`;
    classScreen.style.display = 'flex';
    requestAnimationFrame(()=>classScreen.classList.add('show'));
    document.getElementById('questBoard').style.display = 'none';
    document.getElementById('game').style.display = 'none';
    document.getElementById('dungeonUI').style.display = 'none';
    hideMobilePanels();
    setActionsEnabled(false);
}

function hideMobilePanels(){
    const mobile = document.getElementById('mobilePanels');
    if(mobile) mobile.style.display = 'none';
    const qb = document.getElementById('questBoard');
    const mb = document.getElementById('mapBoard');
    if(qb) qb.classList.remove('show');
    if(mb) mb.classList.remove('show');
}

function showMobilePanels(){
    const mobile = document.getElementById('mobilePanels');
    if(mobile && window.matchMedia('(max-width: 720px)').matches){
        mobile.style.display = 'flex';
    }
}

function chooseDifficulty(){
    const difficulties = [
        {id:'facile', name:'Facile', desc:'Ennemis plus faibles, progression plus douce.', enemyMult:0.85, lootBonus:0},
        {id:'normal', name:'Normal', desc:'Équilibré pour tous les styles.', enemyMult:1, lootBonus:0},
        {id:'difficile', name:'Difficile', desc:'Ennemis coriaces, meilleures récompenses.', enemyMult:1.25, lootBonus:0.08},
        {id:'cauchemar', name:'Cauchemar', desc:'Très exigeant, réservée aux joueurs aguerris.', enemyMult:1.5, lootBonus:0.12},
        {id:'infernal', name:'Infernal', desc:'Punitive, erreurs mortelles.', enemyMult:1.8, lootBonus:0.18},
        {id:'impossible', name:'Impossible (1 vie)', desc:'Une seule vie. La mort est définitive.', enemyMult:2.2, lootBonus:0.25, oneLife:true}
    ];
    const screen = document.getElementById('difficultyScreen');
    const cards = difficulties.map((d)=>`
        <div class="difficulty-card">
            <h3>${d.name}</h3>
            <p>${d.desc}</p>
            <button class="difficulty-pick" onclick="confirmDifficulty('${d.id}')">Choisir ${d.name}</button>
        </div>
    `).join('');
    screen.innerHTML = `
        <div class="modal-wrap">
            <div class="modal-glow"></div>
            <div class="difficulty-modal">
                <h2 class="difficulty-title">Choisis la difficulté</h2>
                <p class="difficulty-sub">Tu pourras la changer plus tard dans une future option.</p>
                <div class="difficulty-grid">${cards}</div>
            </div>
        </div>`;
    screen.style.display = 'flex';
    requestAnimationFrame(()=>screen.classList.add('show'));
    document.getElementById('questBoard').style.display = 'none';
    document.getElementById('game').style.display = 'none';
    document.getElementById('dungeonUI').style.display = 'none';
    document.getElementById('mapBoard').style.display = 'none';
    hideMobilePanels();
    setActionsEnabled(false);
}

function setDifficulty(id){
    const map = {
        facile:{id:'facile', name:'Facile', enemyMult:0.85, lootBonus:0},
        normal:{id:'normal', name:'Normal', enemyMult:1, lootBonus:0},
        difficile:{id:'difficile', name:'Difficile', enemyMult:1.25, lootBonus:0.08},
        cauchemar:{id:'cauchemar', name:'Cauchemar', enemyMult:1.5, lootBonus:0.12},
        infernal:{id:'infernal', name:'Infernal', enemyMult:1.8, lootBonus:0.18},
        impossible:{id:'impossible', name:'Impossible (1 vie)', enemyMult:2.2, lootBonus:0.25, oneLife:true}
    };
    difficulty = map[id] || map.normal;
    const screen = document.getElementById('difficultyScreen');
    screen.classList.remove('show');
    screen.style.display = 'none';
    screen.innerHTML = '';
    document.getElementById('mapBoard').style.display = '';
    showMobilePanels();
    chooseClass();
}

function confirmDifficulty(id){
    if(id !== 'impossible'){
        setDifficulty(id);
        return;
    }
    const screen = document.getElementById('confirmScreen');
    if(!screen){
        setDifficulty(id);
        return;
    }
    screen.innerHTML = `
        <div class="confirm-modal-wrap">
            <div class="confirm-glow"></div>
            <div class="confirm-modal">
                <h2 class="confirm-title">Mode Impossible</h2>
                <p class="confirm-sub">Une seule vie. La mort supprime la sauvegarde.</p>
                <div class="confirm-warn">Tu acceptes un défi extrême. Es-tu sûr de continuer ?</div>
                <div class="confirm-actions">
                    <button class="confirm-btn secondary" onclick="closeConfirm()">Retour</button>
                    <button class="confirm-btn" onclick="acceptImpossible()">Continuer</button>
                </div>
            </div>
        </div>`;
    screen.style.display = 'flex';
    requestAnimationFrame(()=>screen.classList.add('show'));
}

function closeConfirm(){
    const screen = document.getElementById('confirmScreen');
    if(!screen) return;
    screen.classList.remove('show');
    screen.style.display = 'none';
    screen.innerHTML = '';
}

function acceptImpossible(){
    closeConfirm();
    setDifficulty('impossible');
}
function renderZoneMap(){
    const map = document.getElementById('zoneMap');
    if(!map) return;
    map.innerHTML = zones.map(z=>{
        const locked = player.level < z.reqLevel;
        const active = z.id===currentZone.id ? 'active' : '';
        const defeated = z.boss && player.defeatedBosses.includes(z.boss.name);
        const mark = defeated ? ' ✅' : '';
        const label = z.safe
            ? `${z.name} (Sûr)${mark}`
            : (locked ? `${z.name} (Nv ${z.reqLevel})${mark}` : `${z.name} (★${z.diff})${mark}`);
        const sub = z.safe
            ? 'Services et repos'
            : (locked ? `Progression ${Math.min(player.level, z.reqLevel)}/${z.reqLevel}` : `Récompenses x${z.rewardMult}`);
        const pct = z.safe ? 100 : (locked ? Math.min(100, Math.floor((player.level / z.reqLevel) * 100)) : 100);
        return `<button class="zone ${active} ${locked?'locked':''}" ${locked?'disabled':''} onclick="selectZone('${z.id}')">
            <div>${label}</div>
            <div class="sub">${sub}</div>
            <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
        </button>`;
    }).join('');
}
function selectZone(id){
    const z = zones.find(x=>x.id===id);
    if(!z) return;
    if(player.level < z.reqLevel) return;
    currentZone = z;
    enemy = z.safe ? null : initEnemy(player.level);
    updateUI();
    saveGame();
    if(window.matchMedia('(max-width: 720px)').matches){
        closeMobilePanels();
    }
}

function fightZoneBoss(){
    if(player.level < currentZone.reqLevel) return;
    const b = currentZone.boss;
    if(!b) return;
    if(player.defeatedBosses.includes(b.name)){
        log(`👑 Boss de zone déjà vaincu: ${b.name}.`);
        return;
    }
    enemy = {
        name: b.name,
        hp: Math.floor((b.hp + player.level*6) * (1 + currentZone.diff*0.05) * difficulty.enemyMult),
        maxHp: Math.floor((b.hp + player.level*6) * (1 + currentZone.diff*0.05) * difficulty.enemyMult),
        atk: Math.floor((b.atk + player.level*2) * (1 + currentZone.diff*0.05) * difficulty.enemyMult),
        type:'boss',
        affix:{name:'Légendaire', hp:1, atk:1},
        isZoneBoss:true,
        lore: b.lore || '',
        artifact: b.artifact || null
    };
    log(`👑 Boss de zone: ${b.name} apparaît ! ${b.lore?`— ${b.lore}`:''}`);
    updateUI();
}
function setClass(i){
    const classes = getClassDefs();
    const c = classes[i];
    player.class = c.name;
    player.hp = c.hp; player.maxHp = c.hp; player.atk = c.atk;
    player.equipment = {weapon:null, armor:null, helmet:null, ring:null, amulet:null};
    player.skill = {...c.skill};
    player.inventory = {weapons:[], armors:[], helmets:[], rings:[], amulets:[], drops:[]};
    const classScreen = document.getElementById('classScreen');
    classScreen.classList.remove('show');
    classScreen.style.display = 'none';
    classScreen.innerHTML = '';
    document.getElementById('questBoard').style.display = '';
    document.getElementById('game').style.display = '';
    classChosen = true;
    setActionsEnabled(true);
    showMobilePanels();
    updateUI();
    saveGame();
}

function showStartMenu(){
    const startScreen = document.getElementById('startScreen');
    const lastSave = getLastSaveInfo();
    const loadLabel = lastSave ? `Charger une partie (${lastSave})` : 'Charger une partie';
    const loadDisabled = lastSave ? '' : 'disabled';
    startScreen.innerHTML = `
        <div class="modal-wrap">
            <div class="modal-glow"></div>
            <div class="start-modal">
                <h2 class="start-title">Donjon & Quêtes</h2>
                <p class="start-sub">Choisis ton destin et pars à l’aventure.</p>
                <div class="start-actions">
                    <button class="start-btn" onclick="startNewGame()">Nouvelle partie</button>
                    <button class="start-btn secondary" ${loadDisabled} onclick="loadGame()">${loadLabel}</button>
                    <button class="start-btn secondary" onclick="openOptions()">Options</button>
                </div>
                ${lastSave ? `<div class="start-save">Dernière sauvegarde : ${lastSave}</div>` : ''}
                <div class="start-hint">Conseil : commence par une classe adaptée à ton style.</div>
            </div>
        </div>`;
    startScreen.style.display = 'flex';
    document.getElementById('questBoard').style.display = 'none';
    document.getElementById('game').style.display = 'none';
    document.getElementById('dungeonUI').style.display = 'none';
    hideMobilePanels();
    setActionsEnabled(false);
    requestAnimationFrame(()=>startScreen.classList.add('show'));
}

function startNewGame(){
    const startScreen = document.getElementById('startScreen');
    startScreen.classList.remove('show');
    startScreen.style.display = 'none';
    startScreen.innerHTML = '';
    resetNewGame();
    chooseDifficulty();
}

function loadGame(){
    const raw = localStorage.getItem('rpgSave');
    if(!raw){
        alert('Aucune sauvegarde trouvée.');
        return;
    }
    const data = JSON.parse(raw);
    player = data.player;
    if(!player.talents) player.talents = {strength:0, vitality:0, alchemy:0, luck:0};
    if(typeof player.gold!=='number') player.gold = 0;
    if(typeof player.talentPoints!=='number') player.talentPoints = 0;
    if(!('specialization' in player)) player.specialization = null;
    if(!('companion' in player)) player.companion = null;
    if(!('artifact' in player)) player.artifact = null;
    if(!('artifacts' in player)) player.artifacts = [];
    if(!('defeatedBosses' in player)) player.defeatedBosses = [];
    if(!('debuffs' in player)) player.debuffs = [];
    difficulty = data.difficulty || difficulty;
    questLevel = data.questLevel || 1;
    if(Array.isArray(data.quests)){
        quests = data.quests;
    } else if(data.currentQuest){
        quests = [data.currentQuest];
    } else {
        initQuests(3);
    }
    quests.forEach(q=>{
        if(!q.reward) q.reward = {xp:0, gold:0, loot:false};
        if(!q.reward.gold) q.reward.gold = 0;
        if(q.progress && q.progress.drop===undefined) q.progress.drop = 0;
        if(q.progress && q.progress.zoneKills===undefined) q.progress.zoneKills = 0;
        if(q.objective && q.objective.zoneId && !q.objective.zoneName){
            const z = zones.find(x=>x.id===q.objective.zoneId);
            q.objective.zoneName = z ? z.name : '';
        }
        if(!q.faction) q.faction = 'Explorateurs';
    });
    factions = data.factions || {Explorateurs:0, Arcanes:0, Chasseurs:0};
    dailyQuest = data.dailyQuest || dailyQuest;
    weeklyQuest = data.weeklyQuest || weeklyQuest;
    bestiary = data.bestiary || {};
    achievements = data.achievements || {};
    initDailyWeekly();
    currentZone = zones.find(z=>z.id===data.currentZoneId) || getDefaultZone();
    classChosen = data.classChosen;
    respawnBonus = data.respawnBonus || {hp:0, atk:0, potions:0, label:''};
    if(classChosen){
        const startScreen = document.getElementById('startScreen');
        startScreen.classList.remove('show');
        startScreen.style.display = 'none';
        startScreen.innerHTML = '';
        document.getElementById('questBoard').style.display = '';
        document.getElementById('game').style.display = '';
        setActionsEnabled(true);
        showMobilePanels();
        enemy = currentZone.safe ? null : initEnemy(player.level);
        updateUI();
    } else {
        const startScreen = document.getElementById('startScreen');
        startScreen.classList.remove('show');
        startScreen.style.display = 'none';
        startScreen.innerHTML = '';
        chooseClass();
    }
}

function resetNewGame(){
    classChosen = false;
    respawnBonus = {hp:0, atk:0, potions:0, label:''};
    factions = {Explorateurs:0, Arcanes:0, Chasseurs:0};
    difficulty = {id:'normal', name:'Normal', enemyMult:1, lootBonus:0};
    player = {
        hp:50, maxHp:50, atk:8, level:1, xp:0, potions:3, gold:0, talentPoints:0,
        talents:{strength:0, vitality:0, alchemy:0, luck:0},
        skill:{name:'Coup puissant', mult:2, cooldown:0, maxCd:3},
        equipment:{weapon:null, armor:null, helmet:null, ring:null, amulet:null},
        inventory:{weapons:[], armors:[], helmets:[], rings:[], amulets:[], drops:[]},
        class:null,
        specialization:null,
        companion:null,
        artifact:null,
        artifacts:[],
        defeatedBosses:[],
        debuffs:[]
    };
    questLevel = 1;
    initQuests(3);
    currentZone = getDefaultZone();
    enemy = currentZone.safe ? null : initEnemy(1);
    dungeon = {level:1, rooms:[], current:0};
    inDungeon = false;
    inArena = false;
    arenaWave = 0;
    dungeonEnemy = null;
    dungeonRoomCleared = false;
    dailyQuest = null;
    weeklyQuest = null;
    bestiary = {};
    achievements = {};
    worldBoss = null;
    worldBossPhase = 0;
    initSeasonalEvent();
    initDailyWeekly();
    saveGame();
}

function openOptions(){
    const optionsScreen = document.getElementById('optionsScreen');
    optionsScreen.innerHTML = `
        <div class="modal-wrap">
            <div class="modal-glow"></div>
            <div class="options-modal">
                <h2 class="options-title">Options</h2>
                <div class="options-grid">
                    <div class="opt-row">
                        <label>Musique</label>
                        <input id="optMusic" type="range" min="0" max="100" value="${settings.music}">
                    </div>
                    <div class="opt-row">
                        <label>SFX</label>
                        <input id="optSfx" type="range" min="0" max="100" value="${settings.sfx}">
                    </div>
                    <div class="opt-row">
                        <label>Vitesse des animations</label>
                        <select id="optAnim">
                            <option value="0.8">Rapide</option>
                            <option value="1">Normal</option>
                            <option value="1.3">Lent</option>
                        </select>
                    </div>
                    <div class="opt-row">
                        <label>Textes flottants</label>
                        <select id="optFloat">
                            <option value="1">Activés</option>
                            <option value="0">Désactivés</option>
                        </select>
                    </div>
                </div>
                <div class="opt-actions">
                    <button class="opt-btn" onclick="saveOptions()">Sauvegarder</button>
                    <button class="opt-btn secondary" onclick="closeOptions()">Retour</button>
                </div>
            </div>
        </div>`;
    optionsScreen.style.display = 'flex';
    requestAnimationFrame(()=>optionsScreen.classList.add('show'));
    document.getElementById('optAnim').value = String(settings.animSpeed);
    document.getElementById('optFloat').value = settings.floatTexts ? '1' : '0';
}

// ===== EVENTS (SAISON + DAILY/WEEKLY) =====
function initSeasonalEvent(){
    const month = new Date().getMonth();
    const events = [
        {name:'Hiver Ancien', desc:'+5% loot', bonus:{loot:0.05}},
        {name:'Saison des Cendres', desc:'+2 ATK', bonus:{atk:2}},
        {name:'Équinoxe Arcanique', desc:'+1 potion au départ', bonus:{potions:1}}
    ];
    seasonalEvent = events[month % events.length];
    const banner = document.getElementById('eventBanner');
    banner.style.display = 'block';
    banner.textContent = `Événement: ${seasonalEvent.name} — ${seasonalEvent.desc}`;
    if(seasonalEvent.bonus?.potions){
        player.potions += seasonalEvent.bonus.potions;
    }
}

function initDailyWeekly(){
    const today = new Date().toDateString();
    const weekKey = `${new Date().getFullYear()}-W${Math.ceil((new Date().getDate())/7)}`;
    if(!dailyQuest || dailyQuest.key !== today){
        dailyQuest = {key:today, quest:generateQuest(1), claimed:false};
    }
    if(!weeklyQuest || weeklyQuest.key !== weekKey){
        weeklyQuest = {key:weekKey, quest:generateQuest(3), claimed:false};
    }
}

function closeOptions(){
    const optionsScreen = document.getElementById('optionsScreen');
    optionsScreen.classList.remove('show');
    optionsScreen.style.display = 'none';
    optionsScreen.innerHTML = '';
}

function saveOptions(){
    settings.music = Number(document.getElementById('optMusic').value);
    settings.sfx = Number(document.getElementById('optSfx').value);
    settings.animSpeed = Number(document.getElementById('optAnim').value);
    settings.floatTexts = document.getElementById('optFloat').value === '1';
    localStorage.setItem('rpgSettings', JSON.stringify(settings));
    applySettings();
    closeOptions();
}

function applySettings(){
    document.documentElement.style.setProperty('--anim-speed', settings.animSpeed);
}

function loadSettings(){
    const raw = localStorage.getItem('rpgSettings');
    if(raw){
        settings = {...settings, ...JSON.parse(raw)};
    }
    applySettings();
}

function saveGame(){
    const payload = {
        player,
        questLevel,
        quests,
        factions,
        dailyQuest,
        weeklyQuest,
        bestiary,
        achievements,
        currentZoneId: currentZone.id,
        classChosen,
        respawnBonus,
        difficulty,
        savedAt: Date.now()
    };
    localStorage.setItem('rpgSave', JSON.stringify(payload));
}

function getLastSaveInfo(){
    const raw = localStorage.getItem('rpgSave');
    if(!raw) return '';
    try{
        const data = JSON.parse(raw);
        if(!data.savedAt) return '';
        const d = new Date(data.savedAt);
        const date = d.toLocaleDateString('fr-FR');
        const time = d.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
        return `${date} ${time}`;
    } catch(e){
        return '';
    }
}

function computeRespawnBonus(){
    const zoneBonus = Math.max(0, currentZone.diff - 1) * 4;
    const levelBonus = Math.max(0, player.level - 1) * 2;
    const questBonus = Math.max(0, questLevel - 1) * 3;
    const score = zoneBonus + levelBonus + questBonus;
    const bonus = {
        hp: Math.floor(score * 2),
        atk: Math.floor(score / 4),
        potions: Math.floor(score / 10)
    };
    bonus.label = `+${bonus.hp} PV, +${bonus.atk} ATK, +${bonus.potions} potions`;
    return bonus;
}

function fullResetWithBonus(){
    if(!classChosen) return;
    respawnBonus = computeRespawnBonus();
    const baseDef = getClassDefs().find(c=>c.name===player.class) || {hp:50, atk:10};
    const classBase = {hp:baseDef.hp, atk:baseDef.atk};
    player.level = 1;
    player.xp = 0;
    player.maxHp = classBase.hp + respawnBonus.hp;
    player.hp = player.maxHp;
    player.atk = classBase.atk + respawnBonus.atk;
    player.potions = RESPAWN_BASE_POTIONS + respawnBonus.potions;
    player.gold = 0;
    player.talentPoints = 0;
    player.talents = {strength:0, vitality:0, alchemy:0, luck:0};
    player.specialization = null;
    player.companion = null;
    player.artifact = null;
    player.artifacts = [];
    player.defeatedBosses = [];
    player.debuffs = [];
    factions = {Explorateurs:0, Arcanes:0, Chasseurs:0};
    player.equipment = {weapon:null, armor:null, helmet:null, ring:null, amulet:null};
    player.inventory = {weapons:[], armors:[], helmets:[], rings:[], amulets:[], drops:[]};
    player.skill.cooldown = 0;
    questLevel = 1;
    initQuests(3);
    currentZone = zones[0];
    enemy = initEnemy(player.level);
}

// ===== RESTART =====
function restartGame(){
    if(!classChosen){return;}
    fullResetWithBonus();
    if(inDungeon) exitDungeon();
    updateUI();
    saveGame();
}

// ===== INIT =====
renderZoneMap();
initQuests(3);
updateUI();
loadSettings();
initSeasonalEvent();
initDailyWeekly();
showStartMenu();
initHoverInfo();
</script>
</body>
</html>
